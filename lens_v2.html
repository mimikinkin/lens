<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<meta name="theme-color" content="#0a0a0a"/>
<meta name="mobile-web-app-capable" content="yes"/>
<meta name="apple-mobile-web-app-capable" content="yes"/>
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
<title>LENS</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
<style>
/* ─── RESET ─────────────────────────────────────── */
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
html{height:100%;overflow:hidden}
body{height:100%;overflow:hidden;background:#0a0a0a;color:#f0f0f0;font-family:'Nunito','Noto Sans JP',sans-serif;font-size:14px;line-height:1.5;-webkit-font-smoothing:antialiased;user-select:none;}

/* ─── TOKENS ─────────────────────────────────────── */
:root{
  --bg:#0a0a0a;--s1:#111;--s2:#181818;--s3:#222;--s4:#2c2c2c;
  --b1:#1e1e1e;--b2:#2a2a2a;--b3:#363636;
  --t1:#f0f0f0;--t2:#a0a0a0;--t3:#555;
  --red:#c8000a;--red-a:rgba(200,0,10,.14);
  --pink:#e4007f;--blue:#0066cc;
  --r:10px;--rs:7px;
  --ease:cubic-bezier(.22,1,.36,1);--dur:180ms;
  --split:38%;
}

/* ─── SPLASH ─────────────────────────────────────── */
#splash{position:fixed;inset:0;z-index:9000;background:var(--bg);display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;}
#splash.out{animation:sp-out .5s var(--ease) forwards;pointer-events:none}
@keyframes sp-out{to{opacity:0;transform:scale(1.04)}}
.sp-ring{width:80px;height:80px;border-radius:50%;border:1.5px solid var(--b3);display:flex;align-items:center;justify-content:center;position:relative;margin-bottom:28px;animation:rot 9s linear infinite;}
@keyframes rot{to{transform:rotate(360deg)}}
.sp-ring::before{content:'';position:absolute;inset:10px;border-radius:50%;border:1px solid var(--b2);animation:rot 6s linear infinite reverse}
.sp-ring::after{content:'';position:absolute;inset:22px;border-radius:50%;border:1px solid var(--b1)}
.sp-dot{width:11px;height:11px;background:var(--red);border-radius:50%;box-shadow:0 0 14px rgba(200,0,10,.6);animation:glow 3s ease-in-out infinite}
@keyframes glow{0%,100%{box-shadow:0 0 8px rgba(200,0,10,.4)}50%{box-shadow:0 0 20px rgba(200,0,10,.9)}}
.sp-title{font-size:40px;font-weight:900;letter-spacing:10px;color:var(--t1);margin-bottom:6px}
.sp-sub{font-size:9.5px;font-weight:700;letter-spacing:4px;color:var(--t3);margin-bottom:44px}
.sp-cta{display:flex;align-items:center;gap:10px;font-size:10px;font-weight:700;letter-spacing:3px;color:var(--t3);animation:blink 2s ease-in-out infinite}
@keyframes blink{0%,100%{opacity:.3}55%{opacity:1}}
.sp-line{width:24px;height:1px;background:var(--b3)}

/* ─── APP SHELL ──────────────────────────────────── */
#app{display:flex;height:100%;width:100%;opacity:0;animation:fadein .4s .05s ease forwards;}
@keyframes fadein{to{opacity:1}}

/* ─── LAYOUT DESKTOP ─────────────────────────────── */
#left-pane{display:flex;flex-direction:column;flex-shrink:0;}
#right-pane{display:flex;flex-direction:column;flex:1;min-width:0;overflow:hidden;}

/* mobile stacked */
@media(max-width:767px){
  #app{flex-direction:column}
  #left-pane{width:100%}
  #preview-area{height:min(56vw,260px)}
  .panel{max-height:calc(100dvh - 320px)}
  /* mobile: scrollable horizontal tabs */
  .tabs{overflow-x:auto;overflow-y:hidden;flex-wrap:nowrap;-webkit-overflow-scrolling:touch;scrollbar-width:none;}
  .tabs::-webkit-scrollbar{display:none}
  .tab{flex:0 0 auto;min-width:52px;}
  /* hide divider handle on mobile */
  #split-handle{display:none}
}

/* desktop side-by-side */
@media(min-width:768px){
  #app{flex-direction:row}
  #left-pane{width:var(--split);border-right:1px solid var(--b1);}
  #preview-area{flex:1;min-height:0}
  .tabs{flex-direction:column;width:58px;flex-shrink:0;border-right:1px solid var(--b1);border-bottom:none;}
  .tab{padding:14px 4px;min-height:62px;border-bottom:none;border-right:2.5px solid transparent;}
  .tab.active{border-right-color:var(--red);border-bottom-color:transparent}
  #editor-area{display:flex;flex:1;min-height:0;overflow:hidden}
  .panel-wrap{flex:1}
  .panel{max-height:100%}
  /* split handle */
  #split-handle{
    position:absolute;top:0;bottom:0;width:6px;background:transparent;
    cursor:col-resize;z-index:100;
    transform:translateX(-3px);
    display:flex;align-items:center;justify-content:center;
  }
  #split-handle::after{content:'';width:2px;height:40px;background:var(--b3);border-radius:2px;opacity:0;transition:opacity .2s;}
  #split-handle:hover::after,#split-handle.dragging::after{opacity:1}
}

/* ─── HEADER ─────────────────────────────────────── */
header{display:flex;align-items:center;justify-content:space-between;padding:10px 14px 8px 22px;border-bottom:1px solid var(--b1);background:var(--bg);flex-shrink:0;gap:8px;}
.logo{display:flex;align-items:center;gap:9px;flex-shrink:0;cursor:pointer;transition:opacity .15s;}
.logo:hover{opacity:.75}
.hdr-dot{width:8px;height:8px;background:var(--red);border-radius:50%;animation:glow 3s ease-in-out infinite;flex-shrink:0}
.logo-n{font-size:20px;font-weight:900;letter-spacing:3px;line-height:1}
.logo-s{font-size:8px;font-weight:700;letter-spacing:3px;color:var(--t3);margin-top:1px}
.hdr-r{display:flex;gap:5px;align-items:center;flex-wrap:nowrap}
.hbtn{background:var(--s2);border:1.5px solid var(--b2);color:var(--t2);font-family:inherit;font-size:10px;font-weight:700;letter-spacing:.5px;padding:5px 9px;cursor:pointer;border-radius:var(--rs);transition:border-color var(--dur),color var(--dur),background var(--dur);white-space:nowrap;}
.hbtn:hover{border-color:var(--t3);color:var(--t1)}
.hbtn.red{background:var(--red);color:#fff;border-color:var(--red)}
.hbtn.red:hover{opacity:.88}
/* mode toggle */
.mode-toggle{display:flex;background:var(--s1);border:1.5px solid var(--b2);border-radius:var(--rs);overflow:hidden;flex-shrink:0;}
.mode-btn{padding:5px 8px;font-family:inherit;font-size:9.5px;font-weight:700;border:none;background:none;color:var(--t3);cursor:pointer;transition:all .15s;white-space:nowrap;letter-spacing:.3px;}
.mode-btn.active{background:var(--red);color:#fff;}

/* ─── PREVIEW ────────────────────────────────────── */
#preview-area{background:var(--s1);display:flex;align-items:center;justify-content:center;position:relative;overflow:hidden;flex-shrink:0;border-bottom:1px solid var(--b1);cursor:pointer;}
#preview-area.has-img{cursor:default}
#checker-bg{position:absolute;inset:0;display:none;background-image:linear-gradient(45deg,#1e1e1e 25%,transparent 25%),linear-gradient(-45deg,#1e1e1e 25%,transparent 25%),linear-gradient(45deg,transparent 75%,#1e1e1e 75%),linear-gradient(-45deg,transparent 75%,#1e1e1e 75%);background-size:14px 14px;background-position:0 0,0 7px,7px -7px,-7px 0px;pointer-events:none;}
#preview-canvas{display:none;max-width:100%;max-height:100%;object-fit:contain;image-rendering:auto;will-change:auto;}
.ph-wrap{display:flex;flex-direction:column;align-items:center;pointer-events:none}
.ph-ring{width:54px;height:54px;border:1.5px solid var(--b3);border-radius:50%;display:flex;align-items:center;justify-content:center;position:relative;margin-bottom:12px;}
.ph-ring::before{content:'';position:absolute;inset:8px;border:1px solid var(--b2);border-radius:50%}
.ph-ring::after{content:'';position:absolute;inset:17px;border:1px solid var(--b2);border-radius:50%}
.ph-dot{width:6px;height:6px;background:var(--red);border-radius:50%}
.ph-txt{font-size:10px;font-weight:700;letter-spacing:2.5px;color:var(--t3)}
.exp-bar{position:absolute;bottom:0;left:0;right:0;height:2px;background:var(--b1)}
.exp-fill{height:100%;background:var(--red);width:50%;transition:width .1s linear}

/* ─── TABS ───────────────────────────────────────── */
.tabs{display:flex;background:var(--bg);border-bottom:1px solid var(--b1);flex-shrink:0;}
.tab{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:9px 2px 7px;border:none;background:none;color:var(--t3);font-family:inherit;font-size:8px;font-weight:700;letter-spacing:.5px;cursor:pointer;gap:3px;border-bottom:2px solid transparent;transition:color var(--dur),border-color var(--dur);will-change:color;}
.tab.active{color:var(--t1);border-bottom-color:var(--red)}
.tab svg{width:14px;height:14px;opacity:.6;transition:opacity var(--dur)}
.tab.active svg{opacity:1}
.tab-lbl{font-size:7px;white-space:nowrap;}

/* easy mode tab */
.tab.easy-hidden{display:none}

/* ─── PANEL WRAP ─────────────────────────────────── */
.panel-wrap{flex:1;overflow:hidden;min-height:0;position:relative}
.panel{display:none;padding:14px 16px 40px;overflow-y:auto;height:100%;-webkit-overflow-scrolling:touch;overscroll-behavior:contain;contain:paint layout;}
.panel.active{display:block;animation:panel-in .2s var(--ease)}
@keyframes panel-in{from{opacity:0;transform:translateY(5px)}to{opacity:1;transform:none}}
.pnl-hd{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px}
.pnl-title{font-size:9px;font-weight:800;letter-spacing:3px;color:var(--t3)}

/* ─── SLIDER SECTION ─────────────────────────────── */
.sl-section{margin-bottom:2px}
.sl-section-hd{display:flex;align-items:center;justify-content:space-between;padding:10px 0 8px;border-bottom:1px solid var(--b1);margin-bottom:10px;}
.sl-section-hd.clickable{cursor:pointer}
.sl-section-hd.clickable:hover .sl-sec-title{color:var(--t2)}
.sl-sec-title{display:flex;align-items:center;gap:7px;font-size:8.5px;font-weight:800;letter-spacing:2.5px;color:var(--t3);transition:color var(--dur);}
.sl-sec-bar{width:3px;height:10px;background:var(--red);border-radius:2px;flex-shrink:0}
.sl-sec-arrow{font-size:10px;color:var(--t3);transition:transform .22s var(--ease)}
.sl-section.collapsed .sl-sec-arrow{transform:rotate(-90deg)}
.sl-section-body{overflow:hidden;transition:max-height .28s var(--ease),opacity .22s ease;max-height:3000px;opacity:1}
.sl-section.collapsed .sl-section-body{max-height:0;opacity:0}

/* ─── SLIDER ROW ─────────────────────────────────── */
.sl-row{margin-bottom:15px;contain:layout style}
.sl-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:7px}
.sl-label{font-size:11.5px;font-weight:700;color:var(--t2)}
.sl-badge{position:relative;display:inline-flex;align-items:center;min-width:44px;justify-content:flex-end;}
.sl-num{font-size:12px;font-weight:800;color:var(--t3);font-variant-numeric:tabular-nums;cursor:pointer;padding:2px 5px;border-radius:5px;transition:color .15s,background .15s;}
.sl-num.nonzero{color:var(--red)}
.sl-num:hover{background:var(--s2)}
.sl-input{position:absolute;right:0;top:-3px;width:58px;height:24px;background:var(--s2);border:1.5px solid var(--red);color:var(--t1);font-family:inherit;font-size:12px;font-weight:800;text-align:right;padding:0 6px;border-radius:5px;outline:none;display:none;font-variant-numeric:tabular-nums;z-index:20;}

/* ─── TRACK ──────────────────────────────────────── */
.sl-track-hit{position:relative;height:36px;display:flex;align-items:center;touch-action:none;cursor:ew-resize;}
.sl-track-bg{position:absolute;left:0;right:0;height:3px;background:var(--s3);border-radius:2px;pointer-events:none;}
.sl-fill{position:absolute;height:3px;background:var(--red);border-radius:2px;pointer-events:none;}
.sl-center{position:absolute;left:50%;top:0;width:1px;height:3px;background:var(--b3);transform:translateX(-50%);pointer-events:none;}
.sl-thumb{position:absolute;width:17px;height:17px;background:var(--bg);border:2.5px solid var(--red);border-radius:50%;transform:translate(-50%,-50%);top:50%;pointer-events:none;box-shadow:0 2px 8px rgba(0,0,0,.55);will-change:left;}
.sl-track-hit.active .sl-thumb{box-shadow:0 0 0 6px var(--red-a),0 2px 8px rgba(0,0,0,.5);transform:translate(-50%,-50%) scale(1.08);transition:transform .12s var(--ease),box-shadow .12s;}

/* ─── EASY MODE SLIDERS ──────────────────────────── */
.easy-card{background:var(--s1);border:1.5px solid var(--b1);border-radius:14px;padding:16px;margin-bottom:12px;}
.easy-card-title{font-size:13px;font-weight:800;color:var(--t1);margin-bottom:4px;display:flex;align-items:center;gap:8px;}
.easy-card-emoji{font-size:18px}
.easy-card-desc{font-size:10px;color:var(--t3);margin-bottom:14px;font-weight:600;}
.easy-slider-row{margin-bottom:12px;}
.easy-label{font-size:12px;font-weight:700;color:var(--t2);display:flex;justify-content:space-between;margin-bottom:8px;}
.easy-track-hit{position:relative;height:44px;display:flex;align-items:center;touch-action:none;cursor:ew-resize;}
.easy-track-bg{position:absolute;left:0;right:0;height:6px;background:var(--s3);border-radius:3px;pointer-events:none;}
.easy-fill{position:absolute;height:6px;background:linear-gradient(90deg,var(--red),#ff4466);border-radius:3px;pointer-events:none;}
.easy-center{position:absolute;left:50%;top:0;width:2px;height:6px;background:var(--b3);transform:translateX(-50%);pointer-events:none;}
.easy-thumb{position:absolute;width:26px;height:26px;background:#fff;border:3px solid var(--red);border-radius:50%;transform:translate(-50%,-50%);top:50%;pointer-events:none;box-shadow:0 2px 12px rgba(0,0,0,.6);will-change:left;}
.easy-track-hit.active .easy-thumb{box-shadow:0 0 0 8px var(--red-a),0 2px 12px rgba(0,0,0,.5);transform:translate(-50%,-50%) scale(1.12);transition:transform .12s var(--ease);}

/* ─── EASY FILTER GRID ───────────────────────────── */
.filter-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:16px;}
.filter-card{background:var(--s2);border:1.5px solid var(--b2);border-radius:10px;padding:10px 6px;cursor:pointer;text-align:center;transition:all .15s;position:relative;overflow:hidden;}
.filter-card.active{border-color:var(--red);background:var(--red-a);}
.filter-card::after{content:'';position:absolute;bottom:0;left:0;right:0;height:2px;background:var(--red);transform:scaleX(0);transform-origin:left;transition:transform .2s var(--ease);}
.filter-card.active::after{transform:scaleX(1)}
.filter-icon{font-size:22px;margin-bottom:4px;}
.filter-name{font-size:9.5px;font-weight:800;color:var(--t2);letter-spacing:.3px;}
.filter-card.active .filter-name{color:var(--t1)}

/* ─── BUTTONS ────────────────────────────────────── */
.ghost-btn{background:none;border:1.5px solid var(--b2);color:var(--t2);font-size:10.5px;font-weight:700;padding:7px 13px;cursor:pointer;font-family:inherit;border-radius:var(--rs);transition:border-color var(--dur),color var(--dur),background var(--dur);}
.ghost-btn:hover{border-color:var(--t2);color:var(--t1);background:var(--s2)}
.solid-btn{background:var(--red);color:#fff;border:none;font-size:10.5px;font-weight:700;padding:8px 16px;cursor:pointer;font-family:inherit;border-radius:var(--rs);transition:opacity .15s,transform .1s;}
.solid-btn:active{opacity:.85;transform:scale(.97)}

/* ─── CROP GRID ──────────────────────────────────── */
.crop-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:14px}
.crop-card{border:1.5px solid var(--b1);background:var(--s1);padding:13px 14px 10px;cursor:pointer;border-radius:var(--r);position:relative;overflow:hidden;transition:background var(--dur),border-color var(--dur);}
.crop-card::after{content:'';position:absolute;bottom:0;left:0;right:0;height:2.5px;background:var(--red);transform:scaleX(0);transform-origin:left;transition:transform .22s var(--ease);}
.crop-card.active{background:var(--s2);border-color:var(--b2)}
.crop-card.active::after{transform:scaleX(1)}
.crop-ratio{font-size:14px;font-weight:900;color:var(--t2);margin-bottom:2px;line-height:1.1}
.crop-card.active .crop-ratio{color:var(--t1)}
.crop-name{font-size:9px;font-weight:700;color:var(--t3);letter-spacing:.5px}

/* ─── ROTATE GRID ────────────────────────────────── */
.rot-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:14px}
.rot-btn{background:var(--s1);border:1.5px solid var(--b1);color:var(--t2);font-size:11px;font-weight:700;padding:12px 8px;cursor:pointer;font-family:inherit;border-radius:var(--r);display:flex;align-items:center;justify-content:center;gap:6px;transition:background var(--dur),border-color var(--dur),color var(--dur);}
.rot-btn:hover{background:var(--s2);border-color:var(--b2);color:var(--t1)}
.rot-btn:active{transform:scale(.97)}
.rot-icon{font-size:16px;line-height:1}

/* ─── RESOLUTION ─────────────────────────────────── */
.res-row{display:flex;align-items:flex-end;gap:10px;margin-bottom:12px}
.res-x{color:var(--t3);font-size:16px;padding-bottom:8px}
.res-inp-w{flex:1}
.inp-lbl{font-size:8.5px;font-weight:700;letter-spacing:1.5px;color:var(--t3);margin-bottom:5px}
input[type=number],input[type=text]{background:var(--s1);border:1.5px solid var(--b1);color:var(--t1);padding:9px 11px;font-size:12.5px;font-weight:600;font-family:inherit;width:100%;outline:none;border-radius:var(--rs);transition:border-color .15s;}
input:focus{border-color:var(--red)}
input::placeholder{color:var(--t3)}
.divider{height:1px;background:var(--b1);margin:12px 0}
.rp-list{display:flex;flex-direction:column;gap:5px}
.rp-cat-hd{font-size:8px;font-weight:800;letter-spacing:2px;color:var(--t3);margin-top:10px;margin-bottom:2px;padding-bottom:4px;border-bottom:1px solid var(--b1);}
.rp-cat-hd:first-child{margin-top:0}
.rp-item{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border:1.5px solid var(--b1);border-radius:var(--r);background:var(--s1);cursor:pointer;position:relative;overflow:hidden;transition:background var(--dur),border-color var(--dur);}
.rp-item::before{content:'';position:absolute;left:0;top:0;bottom:0;width:3px;background:var(--red);transform:scaleY(0);transform-origin:bottom;border-radius:0 2px 2px 0;transition:transform .2s var(--ease);}
.rp-item.active{background:var(--s2);border-color:var(--b2)}
.rp-item.active::before{transform:scaleY(1)}
.rp-name{font-size:12px;font-weight:700;color:var(--t2)}
.rp-item.active .rp-name{color:var(--t1)}
.rp-dim{font-size:10px;font-weight:600;color:var(--t3)}

/* ─── RGB CURVE ──────────────────────────────────── */
.curve-wrap{background:var(--s1);border:1.5px solid var(--b1);border-radius:var(--r);padding:11px;margin-bottom:12px}
.curve-tabs{display:flex;gap:4px;margin-bottom:9px}
.curve-tab{flex:1;padding:5px 4px;border:1.5px solid var(--b2);background:none;font-family:inherit;font-size:9.5px;font-weight:700;letter-spacing:.5px;cursor:pointer;border-radius:var(--rs);color:var(--t3);transition:all var(--dur);}
.curve-tab.active{color:#fff}
.curve-tab[data-ch=L].active{background:var(--s3);border-color:var(--b3)}
.curve-tab[data-ch=R].active{background:#8b0000;border-color:#8b0000}
.curve-tab[data-ch=G].active{background:#005500;border-color:#005500}
.curve-tab[data-ch=B].active{background:#00008b;border-color:#00008b}
#curve-canvas{width:100%;height:160px;display:block;border-radius:5px;cursor:crosshair;touch-action:none;}

/* ─── HISTOGRAM ──────────────────────────────────── */
.hist-wrap{background:var(--s1);border:1.5px solid var(--b1);border-radius:var(--r);padding:11px;margin-bottom:12px;}
.hist-tabs{display:flex;gap:4px;margin-bottom:9px;}
.hist-tab{flex:1;padding:4px;border:1.5px solid var(--b2);background:none;font-family:inherit;font-size:9px;font-weight:700;cursor:pointer;border-radius:var(--rs);color:var(--t3);transition:all .15s;}
.hist-tab.active{background:var(--s3);border-color:var(--b3);color:var(--t1);}
#hist-canvas{width:100%;height:80px;display:block;border-radius:5px;}

/* ─── HSL MIXER ──────────────────────────────────── */
.hsl-color-row{margin-bottom:14px}
.hsl-color-head{display:flex;align-items:center;gap:8px;margin-bottom:8px}
.hsl-dot{width:11px;height:11px;border-radius:50%;flex-shrink:0}
.hsl-color-name{font-size:11px;font-weight:700;color:var(--t2)}
.hsl-sub-row{display:grid;grid-template-columns:26px 1fr 38px;align-items:center;gap:6px;margin-bottom:5px;}
.hsl-sub-lbl{font-size:8.5px;font-weight:700;color:var(--t3);text-align:center}

/* ─── MOSAIC ──────────────────────────────────────── */
.mosaic-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:12px;}
.mosaic-card{border:1.5px solid var(--b1);background:var(--s1);border-radius:var(--r);padding:12px 8px;text-align:center;cursor:pointer;transition:all .15s;}
.mosaic-card.active{border-color:var(--red);background:var(--red-a);}
.mosaic-size{font-size:14px;font-weight:900;color:var(--t2);}
.mosaic-card.active .mosaic-size{color:var(--t1);}
.mosaic-lbl{font-size:9px;color:var(--t3);font-weight:700;}

/* ─── PRESETS ────────────────────────────────────── */
.pi-box{background:var(--s1);border:1.5px solid var(--b1);padding:13px;margin-bottom:12px;border-radius:var(--r);animation:panel-in .2s var(--ease);}
.pi-btns{display:flex;gap:7px;margin-top:9px}
.preset-card{display:flex;align-items:center;gap:9px;border:1.5px solid var(--b1);background:var(--s1);padding:11px 12px;margin-bottom:7px;border-radius:var(--r);transition:border-color var(--dur),background var(--dur);animation:panel-in .2s var(--ease);}
.preset-card:hover{border-color:var(--b2);background:var(--s2)}
.preset-card.builtin{border-left:3px solid var(--red);}
.pc-info{flex:1;min-width:0}
.pc-name{font-size:13px;font-weight:700;color:var(--t1);margin-bottom:2px}
.pc-meta{font-size:9px;font-weight:600;color:var(--t3);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.apply-btn{background:var(--red);color:#fff;border:none;font-size:9.5px;font-weight:700;padding:7px 11px;cursor:pointer;font-family:inherit;border-radius:var(--rs);white-space:nowrap;}
.del-btn{border:1.5px solid var(--b2);background:none;color:var(--t3);font-size:12px;padding:6px 10px;cursor:pointer;border-radius:var(--rs);transition:border-color var(--dur),color var(--dur);}
.del-btn:hover{border-color:var(--red);color:var(--red)}

/* ─── INFO ───────────────────────────────────────── */
.info-r{display:flex;justify-content:space-between;align-items:center;padding:9px 0;border-bottom:1px solid var(--b1);gap:10px;}
.info-k{font-size:9px;font-weight:700;letter-spacing:.8px;color:var(--t3);flex-shrink:0}
.info-v{font-size:11px;font-weight:600;color:var(--t2);text-align:right;word-break:break-all}
.info-v.hi{color:var(--red)}
.info-sec{margin-top:8px}
.info-sec-hd{display:flex;align-items:center;justify-content:space-between;padding:9px 12px;background:var(--s1);border:1.5px solid var(--b1);border-radius:var(--r);cursor:pointer;margin-bottom:3px;transition:background var(--dur);}
.info-sec-hd:hover{background:var(--s2)}
.info-sec-hd.open{border-radius:var(--r) var(--r) 0 0;margin-bottom:0}
.info-sec-title{font-size:10.5px;font-weight:700;color:var(--t2)}
.info-chevron{font-size:10px;color:var(--t3);transition:transform .22s var(--ease)}
.info-sec-hd.open .info-chevron{transform:rotate(180deg)}
.info-sec-body{background:var(--s1);border:1.5px solid var(--b2);border-top:none;border-radius:0 0 var(--r) var(--r);padding:0 12px;overflow:hidden;max-height:0;transition:max-height .3s var(--ease);margin-bottom:4px;}
.info-sec-body.open{max-height:600px;padding:2px 12px 9px}
.idr{display:flex;justify-content:space-between;padding:7px 0;border-bottom:1px solid var(--b1);gap:8px}
.idr:last-child{border-bottom:none}
.idk{font-size:8.5px;font-weight:700;letter-spacing:.8px;color:var(--t3);flex-shrink:0}
.idv{font-size:10px;font-weight:600;color:var(--t2);text-align:right}
.idv.r{color:var(--red)}

/* ─── EMPTY ──────────────────────────────────────── */
.empty-state{text-align:center;padding:44px 0}
.empty-ring{width:44px;height:44px;border:1.5px solid var(--b2);border-radius:50%;display:flex;align-items:center;justify-content:center;margin:0 auto 13px}
.empty-ring-dot{width:4px;height:4px;background:var(--b2);border-radius:50%}
.empty-ttl{font-size:11px;font-weight:700;letter-spacing:2px;color:var(--t3);margin-bottom:5px}
.empty-sub{font-size:9.5px;font-weight:600;color:#252525;letter-spacing:.5px}

/* ─── BOTTOM BAR ─────────────────────────────────── */
#bottom-bar{display:none;gap:8px;padding:10px 14px;border-top:1px solid var(--b1);background:var(--bg);flex-shrink:0;}
.rst-btn{flex:1;border:1.5px solid var(--b2);background:none;color:var(--t2);padding:12px;font-size:11px;font-weight:700;cursor:pointer;font-family:inherit;border-radius:var(--rs);transition:border-color var(--dur),color var(--dur),background var(--dur);}
.rst-btn:hover{border-color:var(--t2);color:var(--t1);background:var(--s2)}
.exp-btn{flex:2;background:var(--red);color:#fff;border:none;padding:12px;font-size:12px;font-weight:700;letter-spacing:.8px;cursor:pointer;font-family:inherit;border-radius:var(--rs);transition:opacity .15s,transform .1s;}
.exp-btn:active{opacity:.85;transform:scale(.98)}

/* ─── EXPORT MODAL ───────────────────────────────── */
#exp-modal{position:fixed;inset:0;z-index:800;background:rgba(0,0,0,.75);display:none;align-items:flex-end;justify-content:center;backdrop-filter:blur(6px);-webkit-backdrop-filter:blur(6px);}
#exp-modal.open{display:flex;animation:modal-in .25s ease}
@keyframes modal-in{from{opacity:0}to{opacity:1}}
.modal-sheet{background:var(--s1);border:1.5px solid var(--b2);border-radius:var(--r) var(--r) 0 0;padding:18px 18px 36px;width:100%;max-width:480px;animation:sheet-up .28s var(--ease);}
@keyframes sheet-up{from{transform:translateY(36px)}to{transform:none}}
.modal-title{font-size:12px;font-weight:800;letter-spacing:2.5px;color:var(--t2);margin-bottom:13px}
.fmt-grid{display:grid;grid-template-columns:1fr 1fr;gap:7px;margin-bottom:13px}
.fmt-opt{border:1.5px solid var(--b2);background:var(--s2);padding:12px;border-radius:var(--rs);cursor:pointer;text-align:center;transition:all var(--dur);}
.fmt-opt.active{border-color:var(--red);background:var(--red-a)}
.fmt-name{font-size:11px;font-weight:700;color:var(--t2)}
.fmt-opt.active .fmt-name{color:var(--t1)}
.fmt-desc{font-size:9px;color:var(--t3);margin-top:2px}
.modal-btns{display:flex;gap:8px}

/* ─── CONFIRM DIALOG ─────────────────────────────── */
#confirm-dlg{position:fixed;inset:0;z-index:9500;background:rgba(0,0,0,.8);display:none;align-items:center;justify-content:center;backdrop-filter:blur(8px);}
#confirm-dlg.open{display:flex;animation:modal-in .2s ease}
.confirm-box{background:var(--s1);border:1.5px solid var(--b2);border-radius:14px;padding:28px 24px;max-width:320px;width:90%;text-align:center;}
.confirm-icon{font-size:32px;margin-bottom:10px;}
.confirm-title{font-size:15px;font-weight:800;color:var(--t1);margin-bottom:8px;}
.confirm-sub{font-size:12px;color:var(--t2);margin-bottom:24px;line-height:1.6;}
.confirm-btns{display:flex;gap:10px;}
.confirm-ok{flex:1;background:var(--red);color:#fff;border:none;padding:12px;font-size:12px;font-weight:700;border-radius:var(--rs);cursor:pointer;font-family:inherit;}
.confirm-cancel{flex:1;background:none;border:1.5px solid var(--b2);color:var(--t2);padding:12px;font-size:12px;font-weight:700;border-radius:var(--rs);cursor:pointer;font-family:inherit;}

/* ─── SCROLLBAR ──────────────────────────────────── */
::-webkit-scrollbar{width:2px}
::-webkit-scrollbar-track{background:var(--bg)}
::-webkit-scrollbar-thumb{background:var(--b3);border-radius:2px}
</style>
</head>
<body>

<!-- SPLASH -->
<div id="splash">
  <div class="sp-ring"><div class="sp-dot"></div></div>
  <div class="sp-title">LENS</div>
  <div class="sp-sub" id="sp-sub">PHOTO EDITOR</div>
  <div class="sp-cta">
    <div class="sp-line"></div><span id="sp-cta">TAP TO BEGIN</span><div class="sp-line"></div>
  </div>
</div>

<!-- APP -->
<div id="app">

  <!-- LEFT PANE -->
  <div id="left-pane">
    <header>
      <div class="logo" onclick="goHome()">
        <div class="hdr-dot"></div>
        <div>
          <div class="logo-n">LENS</div>
          <div class="logo-s" data-i="appSub">PHOTO EDITOR</div>
        </div>
      </div>
      <div class="hdr-r">
        <!-- mode toggle -->
        <div class="mode-toggle">
          <button class="mode-btn active" id="mode-easy" onclick="setMode('easy')" data-i="modeEasy">かんたん</button>
          <button class="mode-btn" id="mode-pro" onclick="setMode('pro')" data-i="modePro">PRO</button>
        </div>
        <button class="hbtn" onclick="toggleLang()" id="lang-btn">EN</button>
        <button class="hbtn" onclick="triggerOpen()" data-i="open">開く</button>
        <button class="hbtn red" id="hd-export" style="display:none" onclick="openModal()" data-i="export">書き出す</button>
        <input id="fi" type="file" accept="image/*" style="display:none" onchange="onFileLoad(event)"/>
      </div>
    </header>

    <!-- PREVIEW -->
    <div id="preview-area" onclick="triggerOpen()">
      <div id="checker-bg"></div>
      <div class="ph-wrap" id="ph">
        <div class="ph-ring"><div class="ph-dot"></div></div>
        <div class="ph-txt" data-i="tapOpen">タップして開く</div>
      </div>
      <canvas id="preview-canvas"></canvas>
      <div class="exp-bar"><div class="exp-fill" id="exp-fill"></div></div>
    </div>

    <!-- SPLIT HANDLE (desktop only) -->
    <div id="split-handle" title="ドラッグでサイズ変更"></div>
  </div><!-- /left-pane -->

  <!-- RIGHT PANE -->
  <div id="right-pane">
    <div id="editor-area">

      <!-- TABS -->
      <div class="tabs" id="tab-bar">
        <!-- Easy mode tabs -->
        <button class="tab active" data-tab="easy-look" data-mode="easy" onclick="sw('easy-look')">
          <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M8 2l1.5 3 3.5.5-2.5 2.5.6 3.5L8 10l-3.1 1.5.6-3.5L3 5.5l3.5-.5z"/></svg>
          <span class="tab-lbl" data-i="tabEasyLook">フィルター</span>
        </button>
        <button class="tab" data-tab="easy-adj" data-mode="easy" onclick="sw('easy-adj')">
          <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="8" cy="8" r="5"/><line x1="8" y1="3" x2="8" y2="13"/></svg>
          <span class="tab-lbl" data-i="tabEasyAdj">かんたん調整</span>
        </button>
        <!-- Pro mode tabs -->
        <button class="tab pro-only" data-tab="tone" data-mode="pro" onclick="sw('tone')">
          <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="8" cy="8" r="5"/><line x1="8" y1="3" x2="8" y2="13"/></svg>
          <span class="tab-lbl" data-i="tabTone">トーン</span>
        </button>
        <button class="tab pro-only" data-tab="color" data-mode="pro" onclick="sw('color')">
          <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M8 2a6 6 0 100 12A6 6 0 008 2z"/><path d="M8 2c2 2 2 8 0 12M8 2C6 4 6 10 8 14"/></svg>
          <span class="tab-lbl" data-i="tabColor">カラー</span>
        </button>
        <button class="tab pro-only" data-tab="detail" data-mode="pro" onclick="sw('detail')">
          <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M3 8h10M8 3v10M4.5 4.5l7 7M11.5 4.5l-7 7"/></svg>
          <span class="tab-lbl" data-i="tabDetail">詳細</span>
        </button>
        <button class="tab pro-only" data-tab="transform" data-mode="pro" onclick="sw('transform')">
          <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M5 3L2 8l3 5M11 3l3 5-3 5"/><line x1="2" y1="8" x2="14" y2="8"/></svg>
          <span class="tab-lbl" data-i="tabTransform">変形</span>
        </button>
        <!-- Shared tabs -->
        <button class="tab" data-tab="cut" onclick="sw('cut')">
          <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="3" width="10" height="10" rx="1"/><line x1="3" y1="7" x2="13" y2="7"/><line x1="7" y1="3" x2="7" y2="13"/></svg>
          <span class="tab-lbl" data-i="tabCut">カット</span>
        </button>
        <button class="tab pro-only" data-tab="mosaic" data-mode="pro" onclick="sw('mosaic')">
          <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="2" y="2" width="5" height="5" rx="1"/><rect x="9" y="2" width="5" height="5" rx="1"/><rect x="2" y="9" width="5" height="5" rx="1"/><rect x="9" y="9" width="5" height="5" rx="1"/></svg>
          <span class="tab-lbl" data-i="tabMosaic">モザイク</span>
        </button>
        <button class="tab pro-only" data-tab="size" data-mode="pro" onclick="sw('size')">
          <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="2" y="4" width="8" height="8" rx="1"/><rect x="6" y="2" width="8" height="8" rx="1"/></svg>
          <span class="tab-lbl" data-i="tabSize">サイズ</span>
        </button>
        <button class="tab" data-tab="preset" onclick="sw('preset')">
          <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M4 8a4 4 0 108 0 4 4 0 00-8 0z"/><path d="M8 5v3l2 2"/></svg>
          <span class="tab-lbl" data-i="tabPreset">プリセット</span>
        </button>
        <button class="tab pro-only" data-tab="info" data-mode="pro" onclick="sw('info')">
          <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="8" cy="8" r="5.5"/><line x1="8" y1="7" x2="8" y2="11"/><circle cx="8" cy="5" r=".5" fill="currentColor"/></svg>
          <span class="tab-lbl" data-i="tabInfo">情報</span>
        </button>
      </div>

      <!-- PANELS -->
      <div class="panel-wrap">

        <!-- ═══ EASY: FILTER ═══ -->
        <div class="panel active" id="panel-easy-look">
          <div class="pnl-hd">
            <div class="pnl-title" data-i="panelEasyLook">フィルター & ルック</div>
          </div>
          <div class="filter-grid" id="filter-grid"></div>
          <div class="pnl-title" style="margin-bottom:10px" data-i="panelEasyIntensity">フィルターの強さ</div>
          <div id="filter-intensity-row"></div>
        </div>

        <!-- ═══ EASY: ADJUSTMENTS ═══ -->
        <div class="panel" id="panel-easy-adj">
          <div class="pnl-hd">
            <div class="pnl-title" data-i="panelEasyAdj">かんたん調整</div>
            <button class="ghost-btn" onclick="resetAdj()" data-i="reset">リセット</button>
          </div>
          <!-- Easy cards -->
          <div id="easy-cards"></div>
        </div>

        <!-- ═══ PRO: TONE ═══ -->
        <div class="panel" id="panel-tone">
          <div class="pnl-hd">
            <div class="pnl-title" data-i="panelTone">TONE & LIGHT</div>
            <button class="ghost-btn" onclick="resetAdj()" data-i="reset">RESET</button>
          </div>
          <div id="sliders-tone"></div>
          <!-- Histogram -->
          <div class="sl-section">
            <div class="sl-section-hd clickable" onclick="toggleSection(this)">
              <div class="sl-sec-title"><div class="sl-sec-bar"></div><span data-i="histogram">ヒストグラム</span></div>
              <span class="sl-sec-arrow">▾</span>
            </div>
            <div class="sl-section-body">
              <div class="hist-wrap">
                <div class="hist-tabs">
                  <button class="hist-tab active" onclick="setHistMode(this,'rgb')">RGB</button>
                  <button class="hist-tab" onclick="setHistMode(this,'luma')">LUMA</button>
                </div>
                <canvas id="hist-canvas"></canvas>
              </div>
            </div>
          </div>
        </div>

        <!-- ═══ PRO: COLOR ═══ -->
        <div class="panel" id="panel-color">
          <div class="pnl-title" data-i="panelColor">COLOR GRADING</div>
          <div id="sliders-color"></div>
          <!-- RGB Curve -->
          <div class="sl-section">
            <div class="sl-section-hd">
              <div class="sl-sec-title"><div class="sl-sec-bar"></div><span data-i="rgbCurve">RGB CURVE</span></div>
            </div>
            <div class="sl-section-body">
              <div class="curve-wrap">
                <div class="curve-tabs">
                  <button class="curve-tab active" data-ch="L" onclick="setCurveCh(this,'L')">LUMA</button>
                  <button class="curve-tab" data-ch="R" onclick="setCurveCh(this,'R')">R</button>
                  <button class="curve-tab" data-ch="G" onclick="setCurveCh(this,'G')">G</button>
                  <button class="curve-tab" data-ch="B" onclick="setCurveCh(this,'B')">B</button>
                </div>
                <canvas id="curve-canvas"></canvas>
                <div style="font-size:8px;color:var(--t3);margin-top:6px" data-i="curveHint">ドラッグで移動 · タップで追加 · ダブルタップで削除</div>
              </div>
            </div>
          </div>
          <!-- HSL Mixer -->
          <div class="sl-section">
            <div class="sl-section-hd clickable" onclick="toggleSection(this)">
              <div class="sl-sec-title"><div class="sl-sec-bar"></div><span data-i="hslMixer">HSL MIXER</span></div>
              <span class="sl-sec-arrow">▾</span>
            </div>
            <div class="sl-section-body"><div id="hsl-panel"></div></div>
          </div>
          <!-- Advanced color -->
          <div class="sl-section collapsed">
            <div class="sl-section-hd clickable" onclick="toggleSection(this)">
              <div class="sl-sec-title"><div class="sl-sec-bar"></div><span data-i="advColor">ADVANCED COLOR</span></div>
              <span class="sl-sec-arrow">▾</span>
            </div>
            <div class="sl-section-body"><div id="sliders-advanced"></div></div>
          </div>
        </div>

        <!-- ═══ PRO: DETAIL ═══ -->
        <div class="panel" id="panel-detail">
          <div class="pnl-title" data-i="panelDetail">DETAIL & OPTICS</div>
          <div id="sliders-detail"></div>
        </div>

        <!-- ═══ PRO: TRANSFORM ═══ -->
        <div class="panel" id="panel-transform">
          <div class="pnl-title" data-i="panelTransform">ROTATE & TRANSFORM</div>
          <div class="rot-grid">
            <button class="rot-btn" onclick="doRotate(-90)"><span class="rot-icon">↺</span><span data-i="rotL">左回転</span></button>
            <button class="rot-btn" onclick="doRotate(90)"><span class="rot-icon">↻</span><span data-i="rotR">右回転</span></button>
            <button class="rot-btn" onclick="doFlipH()"><span class="rot-icon">⇄</span><span data-i="flipH">水平反転</span></button>
            <button class="rot-btn" onclick="doFlipV()"><span class="rot-icon">⇅</span><span data-i="flipV">垂直反転</span></button>
          </div>
          <div id="sliders-transform"></div>
        </div>

        <!-- ═══ SHARED: CUT ═══ -->
        <div class="panel" id="panel-cut">
          <div class="pnl-title" data-i="panelCut">CUT & FRAME</div>
          <div class="crop-grid">
            <div class="crop-card active" onclick="pickCrop(this)"><div class="crop-ratio">1:1</div><div class="crop-name" data-i="square">SQUARE</div></div>
            <div class="crop-card" onclick="pickCrop(this)"><div class="crop-ratio">4:3</div><div class="crop-name" data-i="standard">STANDARD</div></div>
            <div class="crop-card" onclick="pickCrop(this)"><div class="crop-ratio">16:9</div><div class="crop-name" data-i="wide">WIDE</div></div>
            <div class="crop-card" onclick="pickCrop(this)"><div class="crop-ratio">3:4</div><div class="crop-name" data-i="portrait">PORTRAIT</div></div>
            <div class="crop-card" onclick="pickCrop(this)"><div class="crop-ratio">9:16</div><div class="crop-name" data-i="story">STORY</div></div>
            <div class="crop-card" onclick="pickCrop(this)"><div class="crop-ratio">FREE</div><div class="crop-name" data-i="custom">CUSTOM</div></div>
          </div>
        </div>

        <!-- ═══ PRO: MOSAIC ═══ -->
        <div class="panel" id="panel-mosaic">
          <div class="pnl-title" data-i="panelMosaic">モザイク</div>
          <div style="font-size:11px;color:var(--t2);margin-bottom:14px;" data-i="mosaicDesc">モザイクのサイズを選んでください。全体に適用されます。</div>
          <div class="mosaic-grid" id="mosaic-grid"></div>
          <button class="ghost-btn" style="width:100%;margin-top:4px" onclick="clearMosaic()" data-i="mosaicClear">モザイクを消す</button>
        </div>

        <!-- ═══ PRO: SIZE ═══ -->
        <div class="panel" id="panel-size">
          <div class="pnl-title" data-i="panelSize">OUTPUT SIZE</div>
          <div class="res-row">
            <div class="res-inp-w"><div class="inp-lbl" data-i="widthPx">WIDTH px</div><input type="number" id="rw" value="1080" oninput="onResChange()"/></div>
            <div class="res-x">×</div>
            <div class="res-inp-w"><div class="inp-lbl" data-i="heightPx">HEIGHT px</div><input type="number" id="rh" value="1080" oninput="onResChange()"/></div>
          </div>
          <div class="divider"></div>
          <div class="rp-list" id="rp-list"></div>
        </div>

        <!-- ═══ SHARED: PRESET ═══ -->
        <div class="panel" id="panel-preset">
          <div class="pnl-hd">
            <div class="pnl-title" data-i="panelPreset">プリセット</div>
            <button class="solid-btn" onclick="showPI()" data-i="saveNew">＋ 保存</button>
          </div>
          <div id="pi-box" style="display:none" class="pi-box">
            <div class="inp-lbl" data-i="presetName">プリセット名</div>
            <input type="text" id="pi-name" style="margin-bottom:9px"/>
            <div class="pi-btns">
              <button class="solid-btn" style="flex:1" onclick="savePreset()" data-i="save">保存</button>
              <button class="ghost-btn" style="flex:1" onclick="hidePI()" data-i="cancel">キャンセル</button>
            </div>
          </div>
          <div id="preset-list"></div>
        </div>

        <!-- ═══ PRO: INFO ═══ -->
        <div class="panel" id="panel-info">
          <div class="pnl-title" data-i="panelInfo">IMAGE DATA</div>
          <div id="info-body">
            <div class="empty-state">
              <div class="empty-ring"><div class="empty-ring-dot"></div></div>
              <div class="empty-ttl" data-i="noImg">画像が読み込まれていません</div>
              <div class="empty-sub" data-i="openToView">画像を開くと情報が表示されます</div>
            </div>
          </div>
        </div>

      </div><!-- /panel-wrap -->
    </div><!-- /editor-area -->

    <!-- BOTTOM BAR -->
    <div id="bottom-bar">
      <button class="rst-btn" onclick="resetAdj()" data-i="reset">リセット</button>
      <button class="exp-btn" onclick="openModal()" data-i="export">書き出す</button>
    </div>
  </div><!-- /right-pane -->
</div><!-- /app -->

<!-- EXPORT MODAL -->
<div id="exp-modal">
  <div class="modal-sheet">
    <div class="modal-title" data-i="exportTitle">書き出し設定</div>
    <div class="fmt-grid">
      <div class="fmt-opt active" onclick="pickFmt(this,'jpg')"><div class="fmt-name">JPEG</div><div class="fmt-desc" data-i="fmtJpg">おすすめ・高画質</div></div>
      <div class="fmt-opt" onclick="pickFmt(this,'png')"><div class="fmt-name">PNG</div><div class="fmt-desc" data-i="fmtPng">ロスレス</div></div>
      <div class="fmt-opt" onclick="pickFmt(this,'webp')"><div class="fmt-name">WEBP</div><div class="fmt-desc" data-i="fmtWebp">ファイルが小さい</div></div>
      <div class="fmt-opt" onclick="pickFmt(this,'transparent')"><div class="fmt-name">PNG透過</div><div class="fmt-desc" data-i="bgOff">背景透過</div></div>
    </div>
    <div class="modal-btns">
      <button class="ghost-btn" style="flex:1" onclick="closeModal()" data-i="cancel">キャンセル</button>
      <button class="solid-btn" style="flex:2" onclick="doExport()" data-i="doExport">ダウンロード</button>
    </div>
  </div>
</div>

<!-- CONFIRM DIALOG (for go home) -->
<div id="confirm-dlg">
  <div class="confirm-box">
    <div class="confirm-icon">⚠️</div>
    <div class="confirm-title" data-i="confirmTitle">編集内容が消えます</div>
    <div class="confirm-sub" data-i="confirmSub">保存されていない編集内容があります。<br>ホームに戻りますか？</div>
    <div class="confirm-btns">
      <button class="confirm-cancel" onclick="closeConfirm()" data-i="cancel">キャンセル</button>
      <button class="confirm-ok" onclick="confirmGoHome()" data-i="confirmOk">戻る</button>
    </div>
  </div>
</div>

<canvas id="offscreen" style="display:none"></canvas>

<script>
(function(){
/* ══════════════════════════════════
   i18n
══════════════════════════════════ */
const I18N={
ja:{
  appSub:'フォトエディター',open:'開く',tapOpen:'タップして開く',splashCta:'タップして開始',
  export:'書き出す',exportTitle:'書き出し設定',doExport:'ダウンロード',bgOff:'背景透過',cancel:'キャンセル',
  modeEasy:'かんたん',modePro:'PRO',
  tabEasyLook:'フィルター',tabEasyAdj:'調整',
  tabTone:'トーン',tabColor:'カラー',tabDetail:'詳細',tabTransform:'変形',tabCut:'カット',
  tabMosaic:'モザイク',tabSize:'サイズ',tabPreset:'プリセット',tabInfo:'情報',
  panelEasyLook:'フィルター & ルック',panelEasyAdj:'かんたん調整',panelEasyIntensity:'フィルターの強さ',
  panelTone:'トーン・露光',panelColor:'カラーグレーディング',panelDetail:'ディテール・光学',
  panelTransform:'回転・変形',panelCut:'カット・フレーム',panelMosaic:'モザイク',
  panelSize:'出力サイズ',panelPreset:'プリセット',panelInfo:'画像情報',
  reset:'リセット',saveNew:'＋ 保存',save:'保存',presetName:'プリセット名',
  rgbCurve:'RGBカーブ',curveHint:'ドラッグで移動 · タップで追加 · ダブルタップで削除',
  hslMixer:'HSLミキサー',advColor:'高度なカラー',
  histogram:'ヒストグラム',
  rotL:'左回転',rotR:'右回転',flipH:'水平反転',flipV:'垂直反転',
  widthPx:'横幅 px',heightPx:'縦幅 px',
  square:'スクエア',standard:'スタンダード',wide:'ワイド',portrait:'ポートレート',story:'ストーリー',custom:'カスタム',
  noImg:'画像が読み込まれていません',openToView:'画像を開くと情報が表示されます',
  langToggle:'EN',applyBtn:'適用',deleteBtn:'✕',noPresets:'プリセットなし',noPresetsSub:'調整して保存しましょう',
  mosaicDesc:'モザイクのサイズを選んでください。',mosaicClear:'モザイクを消す',
  confirmTitle:'編集内容が消えます',confirmSub:'保存されていない編集内容があります。\nホームに戻りますか？',confirmOk:'戻る',
  fmtJpg:'おすすめ・高画質',fmtPng:'ロスレス',fmtWebp:'ファイルが小さい',
  // sliders
  sBrightness:'明るさ',sContrast:'コントラスト',sExposure:'露出',sHighlights:'ハイライト',sShadows:'シャドウ',sBlacks:'黒レベル',sWhites:'白レベル',
  sSaturation:'彩度',sVibrance:'自然な彩度',sHue:'色相シフト',sTemperature:'色温度',sTint:'ティント',
  sSharpness:'シャープ',sBlur:'ぼかし',sClarity:'明瞭度',sVignette:'周辺減光',sLens:'周辺光量補正',sChrAb:'色収差',sNoise:'ノイズ(輝度)',sNoiseC:'ノイズ(色)',sGrain:'フィルムグレイン',sFade:'フェード',sDistortion:'歪み補正',
  sAngle:'微調整角度',sPerspH:'水平補正',sPerspV:'垂直補正',
  sRR:'赤→赤',sRG:'赤→緑',sRB:'赤→青',sGR:'緑→赤',sGG:'緑→緑',sGB:'緑→青',sBR:'青→赤',sBG:'青→緑',sBB:'青→青',
  // easy labels
  easyBright:'明るさ',easyContrast:'コントラスト',easySat:'色の鮮やかさ',easyWarm:'温かみ',easyFade:'ふんわり感',easySharp:'くっきり',easyVig:'周辺暗め',easyGrain:'フィルム感',
  // easy card desc
  easyBrightDesc:'写真を明るく・暗くします',easyContrastDesc:'メリハリをつけます',easySatDesc:'色を鮮やかに・落ち着かせます',easyWarmDesc:'暖かい・冷たい雰囲気に',easyFadeDesc:'ふわっと淡い印象に',easySharpDesc:'輪郭をくっきりさせます',easyVigDesc:'周囲を暗くして中心を目立たせます',easyGrainDesc:'フィルム写真のような質感に',
  // res
  rpHD:'HD',rpFHD:'フルHD',rpQHD:'2K QHD',rp4K:'4K UHD',rp8K:'8K',
  rpIG:'Instagramスクエア',rpIGPort:'Instagramポートレート',rpIGLand:'Instagramランドスケープ',
  rpSt:'ストーリー / リール',rpX:'X(Twitter)投稿',rpTW:'X(Twitter)バナー',
  rpFB:'Facebook OG',rpYT:'YouTubeサムネ',rpTT:'TikTok',
  rpA4L:'A4 横',rpA4P:'A4 縦',rpA3L:'A3 横',rpA3P:'A3 縦',
  rpSq1k:'スクエア 1K',rpSq2k:'スクエア 2K',rpSq4k:'スクエア 4K',
  // info
  infoFile:'ファイル名',infoSize:'ファイルサイズ',infoType:'形式',infoW:'元の幅',infoH:'元の高さ',infoMP:'メガピクセル',infoAR:'アスペクト比',infoOutW:'出力幅',infoOutH:'出力高さ',detailTitle:'テクニカル詳細',adjTitle:'適用中の調整',infoCS:'カラースペース',infoDP:'ビット深度',infoTP:'総ピクセル数',noneAdj:'なし',
},
en:{
  appSub:'PHOTO EDITOR',open:'OPEN',tapOpen:'TAP TO OPEN',splashCta:'TAP TO BEGIN',
  export:'EXPORT',exportTitle:'EXPORT OPTIONS',doExport:'DOWNLOAD',bgOff:'Background off',cancel:'CANCEL',
  modeEasy:'EASY',modePro:'PRO',
  tabEasyLook:'FILTERS',tabEasyAdj:'ADJUST',
  tabTone:'TONE',tabColor:'COLOR',tabDetail:'DETAIL',tabTransform:'ROTATE',tabCut:'CUT',
  tabMosaic:'MOSAIC',tabSize:'SIZE',tabPreset:'PRESET',tabInfo:'INFO',
  panelEasyLook:'FILTERS & LOOKS',panelEasyAdj:'EASY ADJUSTMENTS',panelEasyIntensity:'Filter Intensity',
  panelTone:'TONE & LIGHT',panelColor:'COLOR GRADING',panelDetail:'DETAIL & OPTICS',
  panelTransform:'ROTATE & TRANSFORM',panelCut:'CUT & FRAME',panelMosaic:'MOSAIC',
  panelSize:'OUTPUT SIZE',panelPreset:'SAVED PRESETS',panelInfo:'IMAGE DATA',
  reset:'RESET',saveNew:'＋ SAVE',save:'SAVE',presetName:'PRESET NAME',
  rgbCurve:'RGB CURVE',curveHint:'DRAG · CLICK TO ADD · DBL-TAP REMOVE',
  hslMixer:'HSL MIXER',advColor:'ADVANCED COLOR',
  histogram:'HISTOGRAM',
  rotL:'Rotate Left',rotR:'Rotate Right',flipH:'Flip H',flipV:'Flip V',
  widthPx:'WIDTH px',heightPx:'HEIGHT px',
  square:'SQUARE',standard:'STANDARD',wide:'WIDE',portrait:'PORTRAIT',story:'STORY',custom:'CUSTOM',
  noImg:'NO IMAGE LOADED',openToView:'OPEN AN IMAGE TO VIEW DATA',
  langToggle:'日本語',applyBtn:'APPLY',deleteBtn:'✕',noPresets:'NO PRESETS',noPresetsSub:'ADJUST AND SAVE YOUR LOOK',
  mosaicDesc:'Select mosaic block size.',mosaicClear:'Clear Mosaic',
  confirmTitle:'Unsaved Changes',confirmSub:'You have unsaved edits.\nGo back to home?',confirmOk:'Go Home',
  fmtJpg:'Best quality photo',fmtPng:'Lossless',fmtWebp:'Small file',
  sBrightness:'Brightness',sContrast:'Contrast',sExposure:'Exposure',sHighlights:'Highlights',sShadows:'Shadows',sBlacks:'Blacks',sWhites:'Whites',
  sSaturation:'Saturation',sVibrance:'Vibrance',sHue:'Hue Shift',sTemperature:'Temperature',sTint:'Tint',
  sSharpness:'Sharpness',sBlur:'Blur',sClarity:'Clarity',sVignette:'Vignette',sLens:'Lens Correction',sChrAb:'Chromatic Ab.',sNoise:'Noise (Luma)',sNoiseC:'Noise (Chroma)',sGrain:'Film Grain',sFade:'Fade',sDistortion:'Distortion',
  sAngle:'Fine Angle',sPerspH:'Perspective H',sPerspV:'Perspective V',
  sRR:'Red→Red',sRG:'Red→Green',sRB:'Red→Blue',sGR:'Green→Red',sGG:'Green→Green',sGB:'Green→Blue',sBR:'Blue→Red',sBG:'Blue→Green',sBB:'Blue→Blue',
  easyBright:'Brightness',easyContrast:'Contrast',easySat:'Saturation',easyWarm:'Warmth',easyFade:'Fade',easySharp:'Sharpness',easyVig:'Vignette',easyGrain:'Film Grain',
  easyBrightDesc:'Make photo brighter or darker',easyContrastDesc:'Add punch and depth',easySatDesc:'Make colors pop or muted',easyWarmDesc:'Warm or cool the tones',easyFadeDesc:'Soft dreamy look',easySharpDesc:'Make edges crisper',easyVigDesc:'Darken edges for focus',easyGrainDesc:'Film-like texture',
  rpHD:'HD',rpFHD:'Full HD',rpQHD:'2K QHD',rp4K:'4K UHD',rp8K:'8K',
  rpIG:'Instagram Square',rpIGPort:'Instagram Portrait',rpIGLand:'Instagram Landscape',
  rpSt:'Story / Reel',rpX:'X (Twitter) Post',rpTW:'X (Twitter) Banner',
  rpFB:'Facebook OG',rpYT:'YouTube Thumb',rpTT:'TikTok',
  rpA4L:'A4 Landscape',rpA4P:'A4 Portrait',rpA3L:'A3 Landscape',rpA3P:'A3 Portrait',
  rpSq1k:'Square 1K',rpSq2k:'Square 2K',rpSq4k:'Square 4K',
  infoFile:'Filename',infoSize:'File Size',infoType:'Format',infoW:'Native W',infoH:'Native H',infoMP:'Megapixels',infoAR:'Aspect Ratio',infoOutW:'Output W',infoOutH:'Output H',detailTitle:'Technical Details',adjTitle:'Adjustments',infoCS:'Color Space',infoDP:'Bit Depth',infoTP:'Total Pixels',noneAdj:'NONE',
}};
let L='ja';
function tr(k){return I18N[L][k]||I18N.en[k]||k}
function applyLang(){
  document.getElementById('lang-btn').textContent=tr('langToggle');
  document.querySelectorAll('[data-i]').forEach(el=>el.textContent=tr(el.dataset.i));
  buildAllSliders();buildRes();buildPresets();buildInfo();buildEasyCards();buildFilterGrid();updSplash();
}
function toggleLang(){L=L==='ja'?'en':'ja';applyLang()}

/* ══════════════════════════════════
   MODE (easy / pro)
══════════════════════════════════ */
let currentMode='easy';
function setMode(mode){
  currentMode=mode;
  document.getElementById('mode-easy').classList.toggle('active',mode==='easy');
  document.getElementById('mode-pro').classList.toggle('active',mode==='pro');
  // Show/hide pro tabs
  document.querySelectorAll('.tab.pro-only').forEach(t=>{
    t.style.display=mode==='pro'?'':'none';
  });
  // Show easy tabs
  document.querySelectorAll('.tab[data-mode="easy"]').forEach(t=>{
    t.style.display=mode==='easy'?'':'none';
  });
  // Switch to appropriate default panel
  if(mode==='easy') sw('easy-look');
  else sw('tone');
}

/* ══════════════════════════════════
   State
══════════════════════════════════ */
const DEF={
  brightness:0,contrast:0,exposure:0,highlights:0,shadows:0,blacks:0,whites:0,
  saturation:0,vibrance:0,hue:0,temperature:0,tint:0,
  sharpness:0,blur:0,clarity:0,vignette:0,lens:0,chrAb:0,noise:0,noiseC:0,grain:0,fade:0,distortion:0,
  angle:0,perspH:0,perspV:0,
  rr:0,rg:0,rb:0,gr:0,gg:0,gb:0,br:0,bg2:0,bb:0,
};
const HSL_COLS=['Red','Orange','Yellow','Green','Aqua','Blue','Purple','Magenta'];
const HSL_DOTS=['#e02020','#f87020','#ddb800','#10a020','#00b8cc','#1060e0','#8820e0','#d010a0'];
HSL_COLS.forEach(c=>{DEF['hH_'+c]=0;DEF['hS_'+c]=0;DEF['hL_'+c]=0});

let adj={...DEF};
let rotDeg=0,fH=false,fV=false;
let rw=1080,rh=1080;
let srcImg=null,imgMeta=null;
let exportFmt='jpg';
let mosaicSize=0; // 0=off
let filterIntensity=100;
let activeFilterId=null;
let presets=JSON.parse(localStorage.getItem('lens_v8')||'[]');
let isDirty=false;

/* ── Curve state ── */
const curves={
  L:[[0,0],[.25,.25],[.5,.5],[.75,.75],[1,1]],
  R:[[0,0],[.5,.5],[1,1]],
  G:[[0,0],[.5,.5],[1,1]],
  B:[[0,0],[.5,.5],[1,1]],
};
let curveCh='L';
let histMode='rgb';

/* ══════════════════════════════════
   BUILT-IN PRESETS / FILTERS
══════════════════════════════════ */
const BUILTIN_PRESETS=[
  {id:'bp1',name:'🌸 ふわピンク',icon:'🌸',desc:'ふんわりピンク系',adj:{brightness:8,contrast:-10,saturation:15,tint:20,temperature:15,fade:22,vignette:12,vibrance:10}},
  {id:'bp2',name:'💙 クールブルー',icon:'💙',desc:'涼しげな青系',adj:{brightness:5,contrast:5,saturation:5,temperature:-30,tint:-10,fade:15,vignette:18,vibrance:8}},
  {id:'bp3',name:'🤍 ホワイトドリーム',icon:'🤍',desc:'白っぽく冷たい雰囲気',adj:{brightness:20,contrast:-15,saturation:-20,temperature:-15,fade:30,vignette:5,highlights:20}},
  {id:'bp4',name:'✨ エアリー',icon:'✨',desc:'ふわふわ柔らかい光',adj:{brightness:18,contrast:-18,saturation:-5,fade:35,vignette:8,shadows:15,highlights:10}},
  {id:'bp5',name:'🍊 ゴールデンアワー',icon:'🍊',desc:'夕方のあたたかい光',adj:{brightness:8,contrast:10,saturation:20,temperature:35,tint:8,vignette:25,fade:10}},
  {id:'bp6',name:'🖤 モノクロ',icon:'🖤',desc:'シャープな白黒写真',adj:{saturation:-100,contrast:20,sharpness:20,vignette:30}},
  {id:'bp7',name:'🌿 ナチュラルグリーン',icon:'🌿',desc:'自然でみずみずしい緑系',adj:{brightness:5,saturation:20,temperature:-5,clarity:10,vibrance:15,hue:8}},
  {id:'bp8',name:'🍑 桃色トワイライト',icon:'🍑',desc:'ピンク×オレンジのSNS映え',adj:{brightness:12,saturation:25,temperature:25,tint:18,fade:18,vignette:20,vibrance:20}},
  {id:'bp9',name:'☕ カフェフィルム',icon:'☕',desc:'レトロなフィルム風',adj:{brightness:-5,contrast:15,saturation:-10,temperature:20,grain:35,fade:20,vignette:35}},
  {id:'bp10',name:'🍽️ おいしそう',icon:'🍽️',desc:'食べ物が美味しそうになる',adj:{brightness:10,contrast:18,saturation:30,temperature:18,vibrance:25,clarity:15,highlights:-10}},
  {id:'bp11',name:'🌊 オーシャン',icon:'🌊',desc:'澄んだブルーの海感',adj:{brightness:8,saturation:22,temperature:-20,tint:-5,clarity:12,vibrance:20,vignette:15}},
  {id:'bp12',name:'🌙 ナイトムード',icon:'🌙',desc:'夜のムーディーな雰囲気',adj:{brightness:-18,contrast:25,saturation:10,temperature:-10,vignette:45,clarity:8}},
];

/* ══════════════════════════════════
   Easy Filter Grid
══════════════════════════════════ */
function buildFilterGrid(){
  const grid=document.getElementById('filter-grid');
  if(!grid)return;
  grid.innerHTML=BUILTIN_PRESETS.map(f=>`
    <div class="filter-card${activeFilterId===f.id?' active':''}" onclick="applyFilter('${f.id}')">
      <div class="filter-icon">${f.icon}</div>
      <div class="filter-name">${f.name.replace(/^.*? /,'')}</div>
    </div>`).join('');
  // intensity slider
  const row=document.getElementById('filter-intensity-row');
  if(row){
    row.innerHTML=buildEasySliderHTML('__filter_intensity__','',0,100,filterIntensity,'easyIntensity');
    attachEasySlider(document.getElementById('ehit-__filter_intensity__'),'__filter_intensity__',0,100);
  }
}

function applyFilter(id){
  activeFilterId=id;
  const p=BUILTIN_PRESETS.find(f=>f.id===id);if(!p)return;
  // Blend filter adj with intensity
  const t=filterIntensity/100;
  adj={...DEF};
  Object.entries(p.adj).forEach(([k,v])=>{adj[k]=Math.round(v*t)});
  isDirty=true;
  buildAllSliders();scheduleRender();
  buildFilterGrid();
}

/* ══════════════════════════════════
   Easy Cards
══════════════════════════════════ */
const EASY_DEFS=[
  {key:'brightness',lbl:'easyBright',desc:'easyBrightDesc',emoji:'☀️',min:-100,max:100},
  {key:'contrast',  lbl:'easyContrast',desc:'easyContrastDesc',emoji:'◑',min:-100,max:100},
  {key:'saturation',lbl:'easySat',desc:'easySatDesc',emoji:'🎨',min:-100,max:100},
  {key:'temperature',lbl:'easyWarm',desc:'easyWarmDesc',emoji:'🌡️',min:-100,max:100},
  {key:'fade',      lbl:'easyFade',desc:'easyFadeDesc',emoji:'🌫️',min:0,max:100},
  {key:'sharpness', lbl:'easySharp',desc:'easySharpDesc',emoji:'🔍',min:0,max:100},
  {key:'vignette',  lbl:'easyVig',desc:'easyVigDesc',emoji:'⭕',min:0,max:100},
  {key:'grain',     lbl:'easyGrain',desc:'easyGrainDesc',emoji:'🎞️',min:0,max:100},
];

function buildEasyCards(){
  const el=document.getElementById('easy-cards');if(!el)return;
  el.innerHTML=EASY_DEFS.map(d=>`
    <div class="easy-card">
      <div class="easy-card-title"><span class="easy-card-emoji">${d.emoji}</span>${tr(d.lbl)}</div>
      <div class="easy-card-desc">${tr(d.desc)}</div>
      ${buildEasySliderHTML(d.key,d.lbl,d.min,d.max,adj[d.key]??0)}
    </div>`).join('');
  EASY_DEFS.forEach(d=>attachEasySlider(document.getElementById('ehit-'+d.key),d.key,d.min,d.max));
}

function buildEasySliderHTML(key,lbl,min,max,v,customId){
  const p=((v-min)/(max-min))*100;
  const hasMid=min<0;
  let fl='',fw='';
  if(hasMid){fl=v>=0?'50%':p+'%';fw=v>=0?(p-50)+'%':(50-p)+'%';}
  else{fl='0%';fw=p+'%';}
  return`<div class="easy-slider-row">
    <div class="easy-label"><span>${tr(lbl)||''}</span><span id="enum-${key}" style="color:${v!==0?'var(--red)':'var(--t3)'}">${v>0?'+'+v:v}</span></div>
    <div class="easy-track-hit" id="ehit-${key}" data-key="${key}" data-min="${min}" data-max="${max}">
      <div class="easy-track-bg">
        ${hasMid?'<div class="easy-center"></div>':''}
        <div class="easy-fill" id="efill-${key}" style="left:${fl};width:${fw}"></div>
        <div class="easy-thumb" id="ethumb-${key}" style="left:${p}%"></div>
      </div>
    </div>
  </div>`;
}

function attachEasySlider(hit,key,min,max){
  if(!hit)return;
  let active=false;
  function fromX(cx){
    const bg=hit.querySelector('.easy-track-bg');
    const r=bg.getBoundingClientRect();
    return Math.round(min+Math.max(0,Math.min(1,(cx-r.left)/r.width))*(max-min));
  }
  function set(cx){
    const v=fromX(cx);
    if(key==='__filter_intensity__'){
      filterIntensity=v;
      if(activeFilterId)applyFilter(activeFilterId);
    }else{
      if(adj[key]===v)return;
      adj[key]=v;isDirty=true;
      activeFilterId=null;
      setEasySliderUI(key,v,min,max);
      // Also sync pro slider
      setSliderUI(key,v,min,max);
      scheduleRender();
    }
  }
  hit.addEventListener('pointerdown',e=>{active=true;hit.classList.add('active');hit.setPointerCapture(e.pointerId);set(e.clientX);e.preventDefault();},{passive:false});
  hit.addEventListener('pointermove',e=>{if(!active)return;set(e.clientX);},{passive:true});
  const end=()=>{active=false;hit.classList.remove('active')};
  hit.addEventListener('pointerup',end);hit.addEventListener('pointercancel',end);
}

function setEasySliderUI(key,v,min,max){
  const p=((v-min)/(max-min))*100;
  const hasMid=min<0;
  let fl='',fw='';
  if(hasMid){fl=v>=0?'50%':p+'%';fw=v>=0?(p-50)+'%':(50-p)+'%';}
  else{fl='0%';fw=p+'%';}
  const num=document.getElementById('enum-'+key);
  const fill=document.getElementById('efill-'+key);
  const thumb=document.getElementById('ethumb-'+key);
  if(num){num.textContent=v>0?'+'+v:String(v);num.style.color=v!==0?'var(--red)':'var(--t3)';}
  if(fill){fill.style.left=fl;fill.style.width=fw;}
  if(thumb){thumb.style.left=p+'%';}
}

/* ══════════════════════════════════
   Slider definitions (PRO)
══════════════════════════════════ */
function slDef(key,lbl,min,max){return{key,lbl,min,max}}
const GROUPS={
  tone:[slDef('brightness','sBrightness',-100,100),slDef('contrast','sContrast',-100,100),slDef('exposure','sExposure',-100,100),slDef('highlights','sHighlights',-100,100),slDef('shadows','sShadows',-100,100),slDef('blacks','sBlacks',-100,100),slDef('whites','sWhites',-100,100)],
  color:[slDef('saturation','sSaturation',-100,100),slDef('vibrance','sVibrance',-100,100),slDef('hue','sHue',-180,180),slDef('temperature','sTemperature',-100,100),slDef('tint','sTint',-100,100)],
  detail:[slDef('sharpness','sSharpness',0,100),slDef('blur','sBlur',0,30),slDef('clarity','sClarity',-100,100),slDef('vignette','sVignette',0,100),slDef('lens','sLens',-100,100),slDef('chrAb','sChrAb',0,30),slDef('noise','sNoise',0,100),slDef('noiseC','sNoiseC',0,100),slDef('grain','sGrain',0,100),slDef('fade','sFade',0,100),slDef('distortion','sDistortion',-50,50)],
  transform:[slDef('angle','sAngle',-45,45),slDef('perspH','sPerspH',-50,50),slDef('perspV','sPerspV',-50,50)],
  advanced:[slDef('rr','sRR',-100,100),slDef('rg','sRG',-100,100),slDef('rb','sRB',-100,100),slDef('gr','sGR',-100,100),slDef('gg','sGG',-100,100),slDef('gb','sGB',-100,100),slDef('br','sBR',-100,100),slDef('bg2','sBG',-100,100),slDef('bb','sBB',-100,100)],
};

function pct(v,min,max){return((v-min)/(max-min))*100}
function fillCSS(v,min,max){
  const p=pct(v,min,max);
  if(min<0){if(v>=0)return{left:'50%',width:(p-50)+'%'};return{left:p+'%',width:(50-p)+'%'};}
  return{left:'0%',width:p+'%'};
}
function fmtNum(v){return v>0?'+'+v:String(v)}

function buildSliderHTML(key,lbl,min,max){
  const v=adj[key]??0;const p=pct(v,min,max);const f=fillCSS(v,min,max);const hasMid=min<0;
  return`<div class="sl-row" id="row-${key}">
  <div class="sl-top">
    <span class="sl-label">${tr(lbl)}</span>
    <div class="sl-badge">
      <span class="sl-num${v!==0?' nonzero':''}" id="num-${key}" onclick="openNumInput('${key}',${min},${max})">${fmtNum(v)}</span>
      <input class="sl-input" id="inp-${key}" type="number" min="${min}" max="${max}" onblur="closeNumInput('${key}',${min},${max})" onkeydown="numKey(event,'${key}',${min},${max})"/>
    </div>
  </div>
  <div class="sl-track-hit" id="hit-${key}" data-key="${key}" data-min="${min}" data-max="${max}">
    <div class="sl-track-bg">
      ${hasMid?'<div class="sl-center"></div>':''}
      <div class="sl-fill" id="fill-${key}" style="left:${f.left};width:${f.width}"></div>
      <div class="sl-thumb" id="thumb-${key}" style="left:${p}%"></div>
    </div>
  </div>
</div>`;
}

function buildGroup(defs,containerId){
  const el=document.getElementById(containerId);if(!el)return;
  el.innerHTML=defs.map(d=>buildSliderHTML(d.key,d.lbl,d.min,d.max)).join('');
  defs.forEach(d=>attachSlider(document.getElementById('hit-'+d.key),d.key,d.min,d.max));
}

function buildAllSliders(){
  buildGroup(GROUPS.tone,'sliders-tone');
  buildGroup(GROUPS.color,'sliders-color');
  buildGroup(GROUPS.detail,'sliders-detail');
  buildGroup(GROUPS.transform,'sliders-transform');
  buildGroup(GROUPS.advanced,'sliders-advanced');
  buildHSL();buildEasyCards();
}

/* ══════════════════════════════════
   Zero-lag drag — pointer events (PRO)
══════════════════════════════════ */
function attachSlider(hit,key,min,max){
  if(!hit)return;
  let active=false;
  function fromX(clientX){const bg=hit.querySelector('.sl-track-bg');const r=bg.getBoundingClientRect();return Math.round(min+Math.max(0,Math.min(1,(clientX-r.left)/r.width))*(max-min));}
  function set(clientX){
    const v=fromX(clientX);if(adj[key]===v)return;adj[key]=v;isDirty=true;
    setSliderUI(key,v,min,max);
    // Also sync easy slider
    setEasySliderUI(key,v,min,max);
    scheduleRender();
  }
  hit.addEventListener('pointerdown',e=>{active=true;hit.classList.add('active');hit.setPointerCapture(e.pointerId);set(e.clientX);e.preventDefault();},{passive:false});
  hit.addEventListener('pointermove',e=>{if(!active)return;set(e.clientX);},{passive:true});
  const end=()=>{active=false;hit.classList.remove('active')};
  hit.addEventListener('pointerup',end);hit.addEventListener('pointercancel',end);
}

function setSliderUI(key,v,min,max){
  const p=pct(v,min,max);const f=fillCSS(v,min,max);
  const num=document.getElementById('num-'+key);const fill=document.getElementById('fill-'+key);const thumb=document.getElementById('thumb-'+key);
  if(num){num.textContent=fmtNum(v);num.className='sl-num'+(v!==0?' nonzero':'');}
  if(fill){fill.style.left=f.left;fill.style.width=f.width;}
  if(thumb){thumb.style.left=p+'%';}
}

/* ══════════════════════════════════
   Number input on tap
══════════════════════════════════ */
function openNumInput(key,min,max){
  const num=document.getElementById('num-'+key);const inp=document.getElementById('inp-'+key);if(!num||!inp)return;
  inp.value=adj[key];num.style.display='none';inp.style.display='block';setTimeout(()=>{inp.focus();inp.select()},10);
}
function closeNumInput(key,min,max){
  const num=document.getElementById('num-'+key);const inp=document.getElementById('inp-'+key);if(!num||!inp)return;
  let v=parseInt(inp.value,10);if(isNaN(v))v=adj[key];v=Math.max(min,Math.min(max,v));
  adj[key]=v;isDirty=true;setSliderUI(key,v,min,max);setEasySliderUI(key,v,min,max);scheduleRender();
  inp.style.display='none';num.style.display='';
}
function numKey(e,key,min,max){if(e.key==='Enter'||e.key==='Escape')closeNumInput(key,min,max);}

/* ══════════════════════════════════
   HSL sliders
══════════════════════════════════ */
function buildHSL(){
  const container=document.getElementById('hsl-panel');if(!container)return;
  const subs=[{s:'H',min:-50,max:50},{s:'S',min:-100,max:100},{s:'L',min:-100,max:100}];
  container.innerHTML=HSL_COLS.map((c,i)=>`
    <div class="hsl-color-row">
      <div class="hsl-color-head"><div class="hsl-dot" style="background:${HSL_DOTS[i]}"></div><span class="hsl-color-name">${c}</span></div>
      ${subs.map(({s,min,max})=>{
        const key='h'+s+'_'+c;const v=adj[key]??0;const p=pct(v,min,max);const f=fillCSS(v,min,max);
        return`<div class="hsl-sub-row">
          <span class="hsl-sub-lbl">${s}</span>
          <div class="sl-track-hit" id="hit-${key}" data-key="${key}" data-min="${min}" data-max="${max}">
            <div class="sl-track-bg"><div class="sl-center"></div><div class="sl-fill" id="fill-${key}" style="left:${f.left};width:${f.width}"></div><div class="sl-thumb" id="thumb-${key}" style="left:${p}%"></div></div>
          </div>
          <span class="sl-num${v!==0?' nonzero':''}" id="num-${key}">${fmtNum(v)}</span>
        </div>`;
      }).join('')}
    </div>`).join('');
  HSL_COLS.forEach(c=>subs.forEach(({s,min,max})=>{
    const key='h'+s+'_'+c;const hit=document.getElementById('hit-'+key);if(hit)attachSlider(hit,key,min,max);
  }));
}

function toggleSection(hd){hd.parentElement.classList.toggle('collapsed');}

/* ══════════════════════════════════
   Render pipeline — rAF-based
   FIXED: proper filter sync + mosaic
══════════════════════════════════ */
let renderQueued=false;
function scheduleRender(){
  if(renderQueued)return;
  renderQueued=true;
  requestAnimationFrame(()=>{renderQueued=false;renderCanvas();});
}

function renderCanvas(){
  if(!srcImg)return;
  const area=document.getElementById('preview-area');
  const cv=document.getElementById('preview-canvas');
  const AW=area.clientWidth,AH=area.clientHeight;
  if(!AW||!AH)return;

  const iw=srcImg.naturalWidth,ih=srcImg.naturalHeight;
  const sc=Math.min(AW/iw,AH/ih);
  const cw=Math.round(iw*sc),ch=Math.round(ih*sc);

  if(cv.width!==cw||cv.height!==ch){cv.width=cw;cv.height=ch;}
  cv.style.width=cw+'px';cv.style.height=ch+'px';

  const ctx=cv.getContext('2d',{willReadFrequently:mosaicSize>0||histMode});
  ctx.clearRect(0,0,cw,ch);

  // === TRANSFORMS ===
  ctx.save();
  ctx.translate(cw/2,ch/2);
  const a=(rotDeg+adj.angle)*Math.PI/180;
  if(a!==0)ctx.rotate(a);
  if(fH)ctx.scale(-1,1);
  if(fV)ctx.scale(1,-1);

  // === CSS FILTERS (brightness, contrast, saturation, hue, blur) ===
  const bv=Math.max(0,1+adj.brightness/100);
  const cv2=Math.max(0.01,1+adj.contrast/100);
  const sv=Math.max(0,1+adj.saturation/100);
  // Temperature: add warm/cool tint via hue-rotate + sepia trick
  const tempHue=adj.temperature*0.3;
  const blr=adj.blur>0?`blur(${(adj.blur*0.25).toFixed(2)}px)`:'';
  const hr=(adj.hue||tempHue)?`hue-rotate(${(adj.hue+(tempHue)).toFixed(1)}deg)`:'';
  ctx.filter=[
    `brightness(${bv.toFixed(3)})`,
    `contrast(${cv2.toFixed(3)})`,
    `saturate(${sv.toFixed(3)})`,
    blr,hr
  ].filter(Boolean).join(' ');

  ctx.drawImage(srcImg,-cw/2,-ch/2,cw,ch);
  ctx.restore();
  ctx.filter='none';

  // === PIXEL-LEVEL EFFECTS ===
  if(adj.vignette>0||adj.fade>0||adj.grain>0||mosaicSize>0||adj.temperature!==0||adj.tint!==0||adj.highlights!==0||adj.shadows!==0){
    // Only do getImageData if truly needed
    const needPixel=adj.grain>0||mosaicSize>0||adj.highlights!==0||adj.shadows!==0||adj.temperature!==0||adj.tint!==0;
    if(needPixel){
      const id=ctx.getImageData(0,0,cw,ch);
      const d=id.data;
      const tempR=adj.temperature>0?adj.temperature*0.6:0;
      const tempB=adj.temperature<0?-adj.temperature*0.6:0;
      const tintG=adj.tint>0?adj.tint*0.4:0;
      const tintM=adj.tint<0?-adj.tint*0.4:0;
      const hiBoost=adj.highlights/400;
      const shBoost=adj.shadows/400;
      for(let i=0;i<d.length;i+=4){
        let r=d[i],g=d[i+1],b=d[i+2];
        // Temperature
        if(adj.temperature!==0){r=Math.min(255,r+tempR);b=Math.min(255,b+tempB);}
        // Tint
        if(adj.tint>0){g=Math.min(255,g+tintG);}
        else if(adj.tint<0){r=Math.min(255,r+tintM);b=Math.min(255,b+tintM);}
        // Highlights/shadows (luminance-based)
        const lum=(r+g+b)/765;
        if(adj.highlights!==0&&lum>0.6){const f2=((lum-0.6)/0.4)*hiBoost;r=Math.max(0,Math.min(255,r+r*f2));g=Math.max(0,Math.min(255,g+g*f2));b=Math.max(0,Math.min(255,b+b*f2));}
        if(adj.shadows!==0&&lum<0.4){const f2=((0.4-lum)/0.4)*shBoost;r=Math.max(0,Math.min(255,r+r*f2));g=Math.max(0,Math.min(255,g+g*f2));b=Math.max(0,Math.min(255,b+b*f2));}
        // Grain
        if(adj.grain>0){const n=(Math.random()-.5)*adj.grain*0.8;r=Math.max(0,Math.min(255,r+n));g=Math.max(0,Math.min(255,g+n));b=Math.max(0,Math.min(255,b+n));}
        d[i]=r;d[i+1]=g;d[i+2]=b;
      }
      ctx.putImageData(id,0,0);
    }
  }

  // Mosaic
  if(mosaicSize>0){
    const ms=Math.max(2,Math.round(mosaicSize*sc/8));
    for(let y=0;y<ch;y+=ms){for(let x=0;x<cw;x+=ms){
      const px=ctx.getImageData(x,y,1,1).data;
      ctx.fillStyle=`rgb(${px[0]},${px[1]},${px[2]})`;
      ctx.fillRect(x,y,ms,ms);
    }}
  }

  // Vignette
  if(adj.vignette>0){
    const vg=ctx.createRadialGradient(cw/2,ch/2,0,cw/2,ch/2,Math.hypot(cw,ch)*0.55);
    vg.addColorStop(Math.max(0,1-adj.vignette/100*0.6),'rgba(0,0,0,0)');
    vg.addColorStop(1,`rgba(0,0,0,${(adj.vignette/100*0.85).toFixed(3)})`);
    ctx.fillStyle=vg;ctx.fillRect(0,0,cw,ch);
  }
  // Fade
  if(adj.fade>0){
    ctx.fillStyle=`rgba(255,255,255,${(adj.fade/100*0.38).toFixed(3)})`;
    ctx.fillRect(0,0,cw,ch);
  }

  // Exposure bar
  document.getElementById('exp-fill').style.width=(50+adj.exposure/2)+'%';

  // Update histogram if visible
  if(document.getElementById('hist-canvas').getBoundingClientRect().width>0)
    requestAnimationFrame(()=>drawHistogram());
}

/* ══════════════════════════════════
   Histogram
══════════════════════════════════ */
function setHistMode(btn,mode){
  histMode=mode;
  document.querySelectorAll('.hist-tab').forEach(b=>b.classList.toggle('active',b===btn));
  drawHistogram();
}

function drawHistogram(){
  const cv=document.getElementById('hist-canvas');if(!cv)return;
  const pv=document.getElementById('preview-canvas');if(!pv||pv.style.display==='none')return;
  const dpr=window.devicePixelRatio||1;
  const rect=cv.getBoundingClientRect();
  const W=Math.round(rect.width*dpr)||600;
  const H=Math.round(rect.height*dpr)||160;
  if(cv.width!==W||cv.height!==H){cv.width=W;cv.height=H;}
  const ctx=cv.getContext('2d');
  ctx.clearRect(0,0,W,H);
  ctx.fillStyle='#0e0e0e';ctx.fillRect(0,0,W,H);

  // Sample pixels from preview canvas
  const pctx=pv.getContext('2d',{willReadFrequently:true});
  const pw=pv.width,ph=pv.height;
  if(!pw||!ph)return;
  const id=pctx.getImageData(0,0,pw,ph);
  const d=id.data;

  if(histMode==='rgb'){
    const rH=new Array(256).fill(0),gH=new Array(256).fill(0),bH=new Array(256).fill(0);
    for(let i=0;i<d.length;i+=4){rH[d[i]]++;gH[d[i+1]]++;bH[d[i+2]]++;}
    const maxV=Math.max(...rH,...gH,...bH)||1;
    [[rH,'rgba(200,50,50,.7)'],[gH,'rgba(50,180,80,.7)'],[bH,'rgba(60,100,200,.7)']].forEach(([h,col])=>{
      ctx.fillStyle=col;
      for(let i=0;i<256;i++){
        const barH=Math.round((h[i]/maxV)*(H-4));
        ctx.fillRect(Math.round(i/256*W),H-barH,Math.ceil(W/256)+1,barH);
      }
    });
  }else{
    const lH=new Array(256).fill(0);
    for(let i=0;i<d.length;i+=4){lH[Math.round(.299*d[i]+.587*d[i+1]+.114*d[i+2])]++;}
    const maxV=Math.max(...lH)||1;
    ctx.fillStyle='rgba(200,200,200,.75)';
    for(let i=0;i<256;i++){
      const barH=Math.round((lH[i]/maxV)*(H-4));
      ctx.fillRect(Math.round(i/256*W),H-barH,Math.ceil(W/256)+1,barH);
    }
  }
}

/* ══════════════════════════════════
   Image loading
══════════════════════════════════ */
function triggerOpen(){if(srcImg)return;document.getElementById('fi').click();}
function onFileLoad(e){
  const f=e.target.files[0];if(!f)return;
  const img=new Image();
  img.onload=()=>{
    srcImg=img;isDirty=false;
    const ph=document.getElementById('ph');
    ph.style.transition='opacity .3s';ph.style.opacity='0';
    setTimeout(()=>ph.style.display='none',300);
    const cv=document.getElementById('preview-canvas');cv.style.display='block';
    const area=document.getElementById('preview-area');area.onclick=null;area.classList.add('has-img');
    document.getElementById('bottom-bar').style.display='flex';
    document.getElementById('hd-export').style.display='';
    document.getElementById('checker-bg').style.display='block';
    imgMeta={name:f.name,size:(f.size/1024).toFixed(1)+' KB',type:f.type,
      w:img.naturalWidth,h:img.naturalHeight,
      mp:((img.naturalWidth*img.naturalHeight)/1e6).toFixed(2),
      ar:(img.naturalWidth/img.naturalHeight).toFixed(3),
      totalPx:(img.naturalWidth*img.naturalHeight).toLocaleString()};
    // Set output res to image size
    rw=img.naturalWidth;rh=img.naturalHeight;
    document.getElementById('rw').value=rw;
    document.getElementById('rh').value=rh;
    scheduleRender();buildInfo();buildRes();
  };
  img.src=URL.createObjectURL(f);
  // reset file input so same file can be opened again
  e.target.value='';
}

/* ══════════════════════════════════
   Tabs
══════════════════════════════════ */
function sw(id){
  document.querySelectorAll('.tab').forEach(t=>t.classList.toggle('active',t.dataset.tab===id));
  document.querySelectorAll('.panel').forEach(p=>p.classList.toggle('active',p.id==='panel-'+id));
  if(id==='color')requestAnimationFrame(drawCurve);
  if(id==='tone')requestAnimationFrame(drawHistogram);
}

/* ══════════════════════════════════
   Crop / Rotate / Flip
══════════════════════════════════ */
function pickCrop(el){document.querySelectorAll('.crop-card').forEach(c=>c.classList.remove('active'));el.classList.add('active');}
function doRotate(d){rotDeg=(rotDeg+d+360)%360;isDirty=true;scheduleRender();}
function doFlipH(){fH=!fH;isDirty=true;scheduleRender();}
function doFlipV(){fV=!fV;isDirty=true;scheduleRender();}

/* ══════════════════════════════════
   Mosaic
══════════════════════════════════ */
const MOSAIC_SIZES=[4,8,16,32,64];
function buildMosaicGrid(){
  const el=document.getElementById('mosaic-grid');if(!el)return;
  el.innerHTML=MOSAIC_SIZES.map(s=>`
    <div class="mosaic-card${mosaicSize===s?' active':''}" onclick="setMosaic(${s})">
      <div class="mosaic-size">${s}px</div>
      <div class="mosaic-lbl">${s<=4?'細かい':s<=16?'普通':'粗い'}</div>
    </div>`).join('');
}
function setMosaic(s){mosaicSize=s;isDirty=true;buildMosaicGrid();scheduleRender();}
function clearMosaic(){mosaicSize=0;buildMosaicGrid();scheduleRender();}

/* ══════════════════════════════════
   Reset
══════════════════════════════════ */
function resetAdj(){
  adj={...DEF};rotDeg=0;fH=false;fV=false;mosaicSize=0;activeFilterId=null;filterIntensity=100;isDirty=false;
  curves.L=[[0,0],[.25,.25],[.5,.5],[.75,.75],[1,1]];
  curves.R=[[0,0],[.5,.5],[1,1]];curves.G=[[0,0],[.5,.5],[1,1]];curves.B=[[0,0],[.5,.5],[1,1]];
  buildAllSliders();buildMosaicGrid();buildFilterGrid();scheduleRender();requestAnimationFrame(drawCurve);
}

/* ══════════════════════════════════
   Resolution
══════════════════════════════════ */
const RP=[
  {k:'rpIG',w:1080,h:1080,cat:'SNS'},{k:'rpIGPort',w:1080,h:1350,cat:'SNS'},{k:'rpIGLand',w:1080,h:566,cat:'SNS'},
  {k:'rpSt',w:1080,h:1920,cat:'SNS'},{k:'rpX',w:1200,h:675,cat:'SNS'},{k:'rpTW',w:1500,h:500,cat:'SNS'},
  {k:'rpFB',w:1200,h:630,cat:'SNS'},{k:'rpYT',w:1280,h:720,cat:'SNS'},{k:'rpTT',w:1080,h:1920,cat:'SNS'},
  {k:'rpHD',w:1280,h:720,cat:'HD'},{k:'rpFHD',w:1920,h:1080,cat:'HD'},{k:'rpQHD',w:2560,h:1440,cat:'HD'},
  {k:'rp4K',w:3840,h:2160,cat:'HD'},{k:'rp8K',w:7680,h:4320,cat:'HD'},
  {k:'rpA4L',w:3508,h:2480,cat:'Print'},{k:'rpA4P',w:2480,h:3508,cat:'Print'},
  {k:'rpA3L',w:4961,h:3508,cat:'Print'},{k:'rpA3P',w:3508,h:4961,cat:'Print'},
  {k:'rpSq1k',w:1000,h:1000,cat:'Square'},{k:'rpSq2k',w:2000,h:2000,cat:'Square'},{k:'rpSq4k',w:4000,h:4000,cat:'Square'},
];
function buildRes(){
  const cats=[...new Set(RP.map(r=>r.cat))];
  document.getElementById('rp-list').innerHTML=cats.map(cat=>{
    const items=RP.filter(r=>r.cat===cat);
    return`<div class="rp-cat-hd">${cat}</div>`+items.map(r=>`
      <div class="rp-item${rw===r.w&&rh===r.h?' active':''}" onclick="pickRP(this,${r.w},${r.h})">
        <span class="rp-name">${tr(r.k)}</span><span class="rp-dim">${r.w} × ${r.h}</span>
      </div>`).join('');
  }).join('');
}
function pickRP(el,w,h){
  document.querySelectorAll('.rp-item').forEach(r=>r.classList.remove('active'));
  el.classList.add('active');rw=w;rh=h;
  document.getElementById('rw').value=w;document.getElementById('rh').value=h;buildInfo();
}
function onResChange(){
  rw=+document.getElementById('rw').value||1080;rh=+document.getElementById('rh').value||1080;
  document.querySelectorAll('.rp-item').forEach(r=>r.classList.remove('active'));buildInfo();
}

/* ══════════════════════════════════
   RGB Curve  (FIXED coordinate system)
══════════════════════════════════ */
function setCurveCh(btn,ch){
  document.querySelectorAll('.curve-tab').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');curveCh=ch;drawCurve();
}

function drawCurve(){
  const cv=document.getElementById('curve-canvas');if(!cv)return;
  const dpr=window.devicePixelRatio||1;
  const rect=cv.getBoundingClientRect();
  const W=Math.round(rect.width*dpr)||400;
  const H=Math.round(rect.height*dpr)||320;
  if(cv.width!==W||cv.height!==H){cv.width=W;cv.height=H;}
  const ctx=cv.getContext('2d');
  ctx.clearRect(0,0,W,H);
  ctx.fillStyle='#0e0e0e';ctx.fillRect(0,0,W,H);
  // Grid
  ctx.strokeStyle='#1e1e1e';ctx.lineWidth=dpr;
  for(let i=1;i<4;i++){
    const x=W*i/4,y=H*i/4;
    ctx.beginPath();ctx.moveTo(x,0);ctx.lineTo(x,H);ctx.stroke();
    ctx.beginPath();ctx.moveTo(0,y);ctx.lineTo(W,y);ctx.stroke();
  }
  // Identity
  ctx.strokeStyle='#252525';ctx.lineWidth=dpr;
  ctx.beginPath();ctx.moveTo(0,H);ctx.lineTo(W,0);ctx.stroke();
  // Curve
  const pts=curves[curveCh];
  const col={L:'#d0d0d0',R:'#cc3333',G:'#33aa44',B:'#3366cc'}[curveCh];
  ctx.strokeStyle=col;ctx.lineWidth=2*dpr;
  ctx.beginPath();
  pts.forEach(([x,y],i)=>{const px=x*W,py=(1-y)*H;i===0?ctx.moveTo(px,py):ctx.lineTo(px,py);});
  ctx.stroke();
  // Points
  pts.forEach(([x,y])=>{
    ctx.fillStyle=col;ctx.beginPath();ctx.arc(x*W,(1-y)*H,5*dpr,0,Math.PI*2);ctx.fill();
    ctx.strokeStyle='#000';ctx.lineWidth=1.5*dpr;ctx.stroke();
  });
}

(function initCurveInteraction(){
  const cv=document.getElementById('curve-canvas');if(!cv)return;
  let dragging=null;
  function toNorm(e){
    const r=cv.getBoundingClientRect();
    const cx=e.touches?e.touches[0].clientX:e.clientX;
    const cy=e.touches?e.touches[0].clientY:e.clientY;
    return[Math.max(0,Math.min(1,(cx-r.left)/r.width)),Math.max(0,Math.min(1,1-(cy-r.top)/r.height))];
  }
  function nearest([x,y]){
    let bi=null,bd=Infinity;
    curves[curveCh].forEach(([px,py],i)=>{const d=Math.hypot(px-x,py-y);if(d<bd){bd=d;bi=i;}});
    return bd<0.08?bi:null;
  }
  cv.addEventListener('pointerdown',e=>{
    cv.setPointerCapture(e.pointerId);
    const nm=toNorm(e);let idx=nearest(nm);
    if(idx===null){
      curves[curveCh].push([...nm]);
      curves[curveCh].sort((a,b)=>a[0]-b[0]);
      idx=curves[curveCh].findIndex(([x,y])=>Math.abs(x-nm[0])<0.001&&Math.abs(y-nm[1])<0.001);
    }
    dragging=idx;drawCurve();e.preventDefault();
  },{passive:false});
  cv.addEventListener('pointermove',e=>{
    if(dragging===null)return;
    const nm=toNorm(e);
    curves[curveCh][dragging]=[...nm];
    curves[curveCh].sort((a,b)=>a[0]-b[0]);
    dragging=curves[curveCh].findIndex(([x,y])=>Math.abs(x-nm[0])<0.001&&Math.abs(y-nm[1])<0.001);
    drawCurve();scheduleRender();
  },{passive:true});
  cv.addEventListener('pointerup',()=>{dragging=null;});
  cv.addEventListener('dblclick',e=>{
    const nm=toNorm(e),idx=nearest(nm);
    if(idx!==null&&curves[curveCh].length>2){curves[curveCh].splice(idx,1);drawCurve();scheduleRender();}
  });
})();

/* ══════════════════════════════════
   Presets
══════════════════════════════════ */
function showPI(){document.getElementById('pi-box').style.display='block';setTimeout(()=>document.getElementById('pi-name').focus(),30);}
function hidePI(){document.getElementById('pi-box').style.display='none';document.getElementById('pi-name').value='';}
function savePreset(){
  const n=document.getElementById('pi-name').value.trim();if(!n)return;
  presets.push({id:Date.now(),name:n,adj:{...adj},curves:JSON.parse(JSON.stringify(curves)),rot:rotDeg,fH,fV});
  localStorage.setItem('lens_v8',JSON.stringify(presets));hidePI();buildPresets();
}
function delPreset(id){presets=presets.filter(p=>p.id!==id);localStorage.setItem('lens_v8',JSON.stringify(presets));buildPresets();}
function applyPreset(id){
  // Check built-in first
  const bp=BUILTIN_PRESETS.find(p=>p.id===id);
  if(bp){adj={...DEF,...bp.adj};isDirty=true;buildAllSliders();scheduleRender();drawCurve();if(currentMode==='easy')sw('easy-adj');else sw('tone');return;}
  const p=presets.find(x=>x.id===id);if(!p)return;
  adj={...p.adj};if(p.curves)Object.assign(curves,JSON.parse(JSON.stringify(p.curves)));
  rotDeg=p.rot||0;fH=!!p.fH;fV=!!p.fV;isDirty=true;
  buildAllSliders();scheduleRender();drawCurve();sw('tone');
}
function buildPresets(){
  const el=document.getElementById('preset-list');
  // Built-in presets section
  let html=`<div class="pnl-title" style="margin-bottom:10px;font-size:8px" data-i="builtinPresets">デフォルトフィルター</div>`;
  html+=BUILTIN_PRESETS.map(p=>`
    <div class="preset-card builtin">
      <div class="pc-info"><div class="pc-name">${p.name}</div><div class="pc-meta">${p.desc||''}</div></div>
      <button class="apply-btn" onclick="applyPreset('${p.id}')">${tr('applyBtn')}</button>
    </div>`).join('');

  if(presets.length){
    html+=`<div class="pnl-title" style="margin-top:16px;margin-bottom:10px;font-size:8px">マイプリセット</div>`;
    html+=presets.map(p=>{
      const meta=Object.entries(p.adj).filter(([,v])=>v!==0).slice(0,3).map(([k,v])=>`${k}:${v>0?'+':''}${v}`).join(' · ')||'DEFAULT';
      return`<div class="preset-card">
        <div class="pc-info"><div class="pc-name">${p.name}</div><div class="pc-meta">${meta}</div></div>
        <button class="apply-btn" onclick="applyPreset(${p.id})">${tr('applyBtn')}</button>
        <button class="del-btn" onclick="delPreset(${p.id})">${tr('deleteBtn')}</button>
      </div>`;
    }).join('');
  }else{
    html+=`<div class="empty-state" style="padding:24px 0"><div class="empty-ring"><div class="empty-ring-dot"></div></div><div class="empty-ttl" data-i="noPresets">${tr('noPresets')}</div><div class="empty-sub" data-i="noPresetsSub">${tr('noPresetsSub')}</div></div>`;
  }
  el.innerHTML=html;
}

/* ══════════════════════════════════
   Info
══════════════════════════════════ */
function toggleInfoSec(id){document.getElementById('is-hd-'+id).classList.toggle('open');document.getElementById('is-bd-'+id).classList.toggle('open');}
function buildInfo(){
  const el=document.getElementById('info-body');if(!imgMeta)return;
  const rows=[
    ['infoFile',imgMeta.name,false],['infoSize',imgMeta.size,false],['infoType',imgMeta.type,false],
    ['infoW',imgMeta.w+' px',false],['infoH',imgMeta.h+' px',false],
    ['infoMP',imgMeta.mp+' MP',true],['infoAR',imgMeta.ar+' : 1',false],
    ['infoOutW',rw+' px',false],['infoOutH',rh+' px',false],
  ];
  const active=Object.entries(adj).filter(([,v])=>v!==0);
  el.innerHTML=rows.map(([k,v,hi])=>`<div class="info-r"><span class="info-k">${tr(k)}</span><span class="info-v${hi?' hi':''}">${v}</span></div>`).join('')+
    `<div class="info-sec">
      <div class="info-sec-hd" id="is-hd-tech" onclick="toggleInfoSec('tech')"><span class="info-sec-title">${tr('detailTitle')}</span><span class="info-chevron">▾</span></div>
      <div class="info-sec-body" id="is-bd-tech">
        <div class="idr"><span class="idk">${tr('infoCS')}</span><span class="idv">sRGB</span></div>
        <div class="idr"><span class="idk">${tr('infoDP')}</span><span class="idv">8-bit</span></div>
        <div class="idr"><span class="idk">${tr('infoTP')}</span><span class="idv">${imgMeta.totalPx}</span></div>
        <div class="idr"><span class="idk">ROTATION</span><span class="idv">${rotDeg}°${fH?' FH':''}${fV?' FV':''}</span></div>
      </div>
    </div>
    <div class="info-sec">
      <div class="info-sec-hd" id="is-hd-adj" onclick="toggleInfoSec('adj')"><span class="info-sec-title">${tr('adjTitle')}</span><span class="info-chevron">▾</span></div>
      <div class="info-sec-body" id="is-bd-adj">
        ${active.length?active.map(([k,v])=>`<div class="idr"><span class="idk">${k}</span><span class="idv r">${v>0?'+':''}${v}</span></div>`).join(''):`<div class="idr"><span class="idk">${tr('noneAdj')}</span></div>`}
      </div>
    </div>`;
}

/* ══════════════════════════════════
   Export
══════════════════════════════════ */
function openModal(){if(!srcImg)return;document.getElementById('exp-modal').classList.add('open');}
function closeModal(){document.getElementById('exp-modal').classList.remove('open');}
function pickFmt(el,fmt){document.querySelectorAll('.fmt-opt').forEach(e=>e.classList.remove('active'));el.classList.add('active');exportFmt=fmt;}
function doExport(){
  if(!srcImg)return;
  const cv=document.getElementById('offscreen');
  cv.width=rw;cv.height=rh;
  const ctx=cv.getContext('2d');
  const transparent=exportFmt==='transparent';
  if(!transparent){ctx.fillStyle='#fff';ctx.fillRect(0,0,rw,rh);}
  ctx.save();
  ctx.translate(rw/2,rh/2);
  const a=(rotDeg+adj.angle)*Math.PI/180;
  if(a)ctx.rotate(a);
  if(fH)ctx.scale(-1,1);if(fV)ctx.scale(1,-1);
  const bv=Math.max(0,1+adj.brightness/100),cv2=Math.max(0.01,1+adj.contrast/100),sv=Math.max(0,1+adj.saturation/100);
  const tempHue=adj.temperature*0.3;
  const blr=adj.blur>0?`blur(${(adj.blur*0.25).toFixed(2)}px)`:'';
  const hr=(adj.hue||tempHue)?`hue-rotate(${(adj.hue+tempHue).toFixed(1)}deg)`:'';
  ctx.filter=[`brightness(${bv})`,`contrast(${cv2})`,`saturate(${sv})`,blr,hr].filter(Boolean).join(' ');
  ctx.drawImage(srcImg,-rw/2,-rh/2,rw,rh);
  ctx.restore();ctx.filter='none';
  // Pixel effects
  if(adj.grain>0||adj.temperature!==0||adj.tint!==0||adj.highlights!==0||adj.shadows!==0){
    const id=ctx.getImageData(0,0,rw,rh);const d=id.data;
    const tempR=adj.temperature>0?adj.temperature*0.6:0,tempB=adj.temperature<0?-adj.temperature*0.6:0;
    const tintG=adj.tint>0?adj.tint*0.4:0,tintM=adj.tint<0?-adj.tint*0.4:0;
    const hiBoost=adj.highlights/400,shBoost=adj.shadows/400;
    for(let i=0;i<d.length;i+=4){
      let r=d[i],g=d[i+1],b=d[i+2];
      if(adj.temperature!==0){r=Math.min(255,r+tempR);b=Math.min(255,b+tempB);}
      if(adj.tint>0){g=Math.min(255,g+tintG);}else if(adj.tint<0){r=Math.min(255,r+tintM);b=Math.min(255,b+tintM);}
      const lum=(r+g+b)/765;
      if(adj.highlights!==0&&lum>0.6){const f2=((lum-0.6)/0.4)*hiBoost;r=Math.max(0,Math.min(255,r+r*f2));g=Math.max(0,Math.min(255,g+g*f2));b=Math.max(0,Math.min(255,b+b*f2));}
      if(adj.shadows!==0&&lum<0.4){const f2=((0.4-lum)/0.4)*shBoost;r=Math.max(0,Math.min(255,r+r*f2));g=Math.max(0,Math.min(255,g+g*f2));b=Math.max(0,Math.min(255,b+b*f2));}
      if(adj.grain>0){const n=(Math.random()-.5)*adj.grain*0.8;r=Math.max(0,Math.min(255,r+n));g=Math.max(0,Math.min(255,g+n));b=Math.max(0,Math.min(255,b+n));}
      d[i]=r;d[i+1]=g;d[i+2]=b;
    }
    ctx.putImageData(id,0,0);
  }
  // Mosaic
  if(mosaicSize>0){
    const ms=mosaicSize;
    for(let y=0;y<rh;y+=ms){for(let x=0;x<rw;x+=ms){
      const px=ctx.getImageData(x,y,1,1).data;
      ctx.fillStyle=`rgb(${px[0]},${px[1]},${px[2]})`;
      ctx.fillRect(x,y,ms,ms);
    }}
  }
  if(adj.vignette>0&&!transparent){
    const vg=ctx.createRadialGradient(rw/2,rh/2,0,rw/2,rh/2,Math.hypot(rw,rh)*0.55);
    vg.addColorStop(Math.max(0,1-adj.vignette/100*0.6),'rgba(0,0,0,0)');
    vg.addColorStop(1,`rgba(0,0,0,${adj.vignette/100*0.85})`);
    ctx.fillStyle=vg;ctx.fillRect(0,0,rw,rh);
  }
  if(adj.fade>0){ctx.fillStyle=`rgba(255,255,255,${adj.fade/100*0.38})`;ctx.fillRect(0,0,rw,rh);}
  const mime=transparent||exportFmt==='png'?'image/png':exportFmt==='webp'?'image/webp':'image/jpeg';
  const ext=transparent||exportFmt==='png'?'png':exportFmt==='webp'?'webp':'jpg';
  const dlLink=document.createElement('a');
  dlLink.download=`lens_${Date.now()}.${ext}`;
  dlLink.href=cv.toDataURL(mime,mime==='image/jpeg'?.94:undefined);
  dlLink.click();closeModal();isDirty=false;
}

/* ══════════════════════════════════
   Home / Confirm Dialog
══════════════════════════════════ */
function goHome(){
  if(!srcImg){return;}// no image, just stay
  if(!isDirty){doGoHome();return;}
  document.getElementById('confirm-dlg').classList.add('open');
}
function closeConfirm(){document.getElementById('confirm-dlg').classList.remove('open');}
function confirmGoHome(){closeConfirm();doGoHome();}
function doGoHome(){
  srcImg=null;isDirty=false;mosaicSize=0;activeFilterId=null;filterIntensity=100;
  adj={...DEF};rotDeg=0;fH=false;fV=false;
  // Reset UI
  const cv=document.getElementById('preview-canvas');cv.style.display='none';
  const area=document.getElementById('preview-area');area.onclick=triggerOpen;area.classList.remove('has-img');
  const ph=document.getElementById('ph');ph.style.display='';ph.style.opacity='1';
  document.getElementById('checker-bg').style.display='none';
  document.getElementById('bottom-bar').style.display='none';
  document.getElementById('hd-export').style.display='none';
  document.getElementById('info-body').innerHTML='<div class="empty-state"><div class="empty-ring"><div class="empty-ring-dot"></div></div><div class="empty-ttl">'+tr('noImg')+'</div><div class="empty-sub">'+tr('openToView')+'</div></div>';
  buildAllSliders();buildMosaicGrid();buildFilterGrid();
  if(currentMode==='easy')sw('easy-look');else sw('tone');
}

/* ══════════════════════════════════
   Splash
══════════════════════════════════ */
function updSplash(){
  document.getElementById('sp-sub').textContent=tr('appSub');
  document.getElementById('sp-cta').textContent=tr('splashCta');
}
function dismissSplash(){
  const sp=document.getElementById('splash');sp.classList.add('out');
  setTimeout(()=>sp.remove(),550);
}

/* ══════════════════════════════════
   Split handle (desktop resize)
══════════════════════════════════ */
(function initSplit(){
  const handle=document.getElementById('split-handle');if(!handle)return;
  const app=document.getElementById('app');
  let dragging=false;
  handle.addEventListener('mousedown',e=>{
    dragging=true;handle.classList.add('dragging');e.preventDefault();
  });
  document.addEventListener('mousemove',e=>{
    if(!dragging)return;
    const appRect=app.getBoundingClientRect();
    const pct=Math.max(20,Math.min(70,((e.clientX-appRect.left)/appRect.width)*100));
    document.documentElement.style.setProperty('--split',pct+'%');
  });
  document.addEventListener('mouseup',()=>{dragging=false;handle.classList.remove('dragging');});
  // Position handle relative to left pane right edge
  function posHandle(){
    const lp=document.getElementById('left-pane');
    const lRect=lp.getBoundingClientRect();
    handle.style.left=lRect.right+'px';
  }
  new ResizeObserver(posHandle).observe(document.getElementById('left-pane'));
})();

/* ══════════════════════════════════
   Responsive preview resize
══════════════════════════════════ */
new ResizeObserver(()=>{
  if(srcImg)scheduleRender();
  // Redraw curve if color panel visible
  if(document.getElementById('panel-color').classList.contains('active'))requestAnimationFrame(drawCurve);
}).observe(document.getElementById('preview-area'));

/* ══════════════════════════════════
   Expose to global scope
══════════════════════════════════ */
window.toggleLang=toggleLang;window.setMode=setMode;window.triggerOpen=triggerOpen;
window.openModal=openModal;window.closeModal=closeModal;window.pickFmt=pickFmt;window.doExport=doExport;
window.sw=sw;window.resetAdj=resetAdj;window.setCurveCh=setCurveCh;window.toggleSection=toggleSection;
window.doRotate=doRotate;window.doFlipH=doFlipH;window.doFlipV=doFlipV;window.pickCrop=pickCrop;
window.onResChange=onResChange;window.pickRP=pickRP;
window.showPI=showPI;window.hidePI=hidePI;window.savePreset=savePreset;window.delPreset=delPreset;window.applyPreset=applyPreset;
window.toggleInfoSec=toggleInfoSec;window.openNumInput=openNumInput;window.closeNumInput=closeNumInput;window.numKey=numKey;
window.onFileLoad=onFileLoad;window.goHome=goHome;window.closeConfirm=closeConfirm;window.confirmGoHome=confirmGoHome;
window.setMosaic=setMosaic;window.clearMosaic=clearMosaic;window.setHistMode=setHistMode;window.applyFilter=applyFilter;

/* ══════════════════════════════════
   Boot
══════════════════════════════════ */
setMode('easy'); // start in easy mode
buildAllSliders();buildRes();buildPresets();buildFilterGrid();buildMosaicGrid();updSplash();
requestAnimationFrame(drawCurve);
document.getElementById('splash').addEventListener('click',dismissSplash);

})();
</script>
</body>
</html>
