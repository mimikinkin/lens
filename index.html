<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<meta name="mobile-web-app-capable" content="yes"/>
<meta name="apple-mobile-web-app-capable" content="yes"/>
<title>LENS</title>
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
html,body{height:100%;overflow:hidden}
body{background:#0a0a0a;color:#f0f0f0;font-family:'Nunito','Noto Sans JP',sans-serif;font-size:var(--fs,14px);line-height:1.5;-webkit-font-smoothing:antialiased;user-select:none}
:root{
  --bg:#0a0a0a;--s1:#111;--s2:#181818;--s3:#222;
  --b1:#1e1e1e;--b2:#2a2a2a;--b3:#363636;
  --t1:#f0f0f0;--t2:#a0a0a0;--t3:#555;
  --red:#c8000a;--reda:rgba(200,0,10,.15);
  --r:10px;--rs:7px;
  --ease:cubic-bezier(.22,1,.36,1);
  --anim-dur:.15s;--anim-ease:cubic-bezier(.22,1,.36,1);
  --split:40%;--mobile-prev:clamp(180px,52vw,260px);
  --fs:14px;
}

/* ‚ïê‚ïê SPLASH ‚ïê‚ïê */
#splash{position:fixed;inset:0;z-index:9999;background:#0a0a0a;display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;overflow:hidden}
#splash.out{animation:spout .95s cubic-bezier(.4,0,.2,1) forwards;pointer-events:none}
@keyframes spout{0%{opacity:1;transform:scale(1);filter:blur(0)}40%{opacity:1;transform:scale(1.015);filter:blur(0)}100%{opacity:0;transform:scale(1.07) translateY(-6px);filter:blur(5px)}}
#splash::before{content:'';position:absolute;inset:0;background:repeating-linear-gradient(0deg,transparent,transparent 3px,rgba(0,0,0,.04) 3px,rgba(0,0,0,.04) 6px);pointer-events:none;z-index:1}

/* Leica rings */
.sp-rings{position:relative;width:110px;height:110px;margin-bottom:40px;will-change:transform;animation:sp-fadein-up 1s cubic-bezier(.22,1,.36,1) 0s both}
.sp-r1{position:absolute;inset:0;border-radius:50%;border:1px solid rgba(255,255,255,.08);animation:sp-spin 18s linear infinite;pointer-events:none;will-change:transform}
.sp-r1::before{content:'';position:absolute;top:-3.5px;left:50%;transform:translateX(-50%);width:7px;height:7px;background:var(--red);border-radius:50%;box-shadow:0 0 10px 2px var(--red),0 0 28px rgba(200,0,10,.5);animation:sp-dot-glow 3.2s ease-in-out infinite}
@keyframes sp-dot-glow{0%,100%{box-shadow:0 0 8px 1px var(--red),0 0 18px rgba(200,0,10,.3)}50%{box-shadow:0 0 18px 5px var(--red),0 0 42px rgba(200,0,10,.7)}}
.sp-r2{position:absolute;inset:16px;border-radius:50%;border:1px solid rgba(255,255,255,.04);animation:sp-spin 11s linear infinite reverse;pointer-events:none;will-change:transform}
.sp-r2::before{content:'';position:absolute;bottom:-2.5px;left:50%;transform:translateX(-50%);width:5px;height:5px;background:#2a2a2a;border-radius:50%}
.sp-r3{position:absolute;inset:30px;border-radius:50%;border:1px solid rgba(255,255,255,.025);animation:sp-spin 7s linear infinite;pointer-events:none;will-change:transform}
.sp-r4{position:absolute;inset:44px;border-radius:50%;border:0.5px solid rgba(200,0,10,.12);animation:sp-spin 4.5s linear infinite reverse;pointer-events:none;will-change:transform}
.sp-core{position:absolute;inset:42px;border-radius:50%;background:radial-gradient(circle at 38% 38%,#1e0003 0%,#0a0a0a 100%);display:flex;align-items:center;justify-content:center;pointer-events:none}
.sp-dot{width:10px;height:10px;background:var(--red);border-radius:50%;animation:sp-pulse 3s ease-in-out infinite;pointer-events:none;will-change:transform,box-shadow}
@keyframes sp-spin{to{transform:rotate(360deg)}}
@keyframes sp-pulse{0%,100%{box-shadow:0 0 0 0 rgba(200,0,10,.5),0 0 6px rgba(200,0,10,.3);transform:scale(1)}50%{box-shadow:0 0 0 8px rgba(200,0,10,.1),0 0 22px rgba(200,0,10,.8);transform:scale(1.15)}}

.sp-logo-wrap{text-align:center;margin-bottom:48px;pointer-events:none;animation:sp-fadein-up 1.2s cubic-bezier(.22,1,.36,1) .15s both}
@keyframes sp-fadein-up{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:none}}
.sp-brand{font-size:8.5px;font-weight:800;letter-spacing:7px;color:rgba(255,255,255,.22);margin-bottom:10px;animation:sp-fadein .9s .2s ease both}
@keyframes sp-fadein{from{opacity:0}to{opacity:1}}
.sp-name{font-size:54px;font-weight:900;letter-spacing:14px;line-height:1;position:relative;display:inline-block;animation:sp-name-in 1.2s .08s cubic-bezier(.22,1,.36,1) both}
@keyframes sp-name-in{from{opacity:0;letter-spacing:4px;filter:blur(8px)}to{opacity:1;letter-spacing:14px;filter:blur(0)}}
.sp-name::after{content:'';position:absolute;bottom:-6px;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,rgba(200,0,10,.2) 20%,var(--red) 50%,rgba(200,0,10,.2) 80%,transparent);animation:sp-line 3.5s ease-in-out infinite}
@keyframes sp-line{0%,100%{opacity:.12;transform:scaleX(.3)}50%{opacity:1;transform:scaleX(1)}}
.sp-sub{font-size:7.5px;font-weight:700;letter-spacing:5px;color:rgba(255,255,255,.18);margin-top:12px;animation:sp-fadein .9s .5s ease both}

.sp-tap{display:flex;align-items:center;gap:18px;font-size:7.5px;font-weight:800;letter-spacing:5px;color:rgba(255,255,255,.28);animation:sp-blink 3.2s 2s ease-in-out infinite,sp-fadein .9s 1s ease both;pointer-events:none}
@keyframes sp-blink{0%,100%{opacity:.08}65%{opacity:1}}
.sp-tap-line{flex:1;max-width:32px;height:1px;background:linear-gradient(90deg,transparent,rgba(255,255,255,.12))}
.sp-tap-line:last-child{background:linear-gradient(90deg,rgba(255,255,255,.12),transparent)}

/* ‚ïê‚ïê APP ‚ïê‚ïê */
#app{display:flex;width:100%;height:100%;opacity:0;animation:fadein .4s .1s ease forwards}
@keyframes fadein{to{opacity:1}}

/* MOBILE */
@media(max-width:767px){
  #app{flex-direction:column}
  #left-pane{width:100%;flex-shrink:0;display:flex;flex-direction:column}
  #preview-area{height:var(--mobile-prev);flex-shrink:0;transition:height .15s}
  #right-pane{flex:1;min-height:0;display:flex;flex-direction:column;overflow:hidden}
  #editor-area{flex:1;min-height:0;display:flex;overflow:hidden}
  .panel-wrap{flex:1;min-width:0;min-height:0}
  .tabs{overflow-x:auto;overflow-y:hidden;flex-wrap:nowrap;-webkit-overflow-scrolling:touch;scrollbar-width:none;flex-shrink:0}
  .tabs::-webkit-scrollbar{display:none}
  .tab{flex:0 0 auto;min-width:54px}
  #split-handle{display:none!important}
  #mob-resize{display:flex;align-items:center;justify-content:center;height:26px;background:var(--bg);border-bottom:1px solid var(--b1);cursor:ns-resize;flex-shrink:0;touch-action:none;-webkit-touch-callout:none;user-select:none;z-index:10;position:relative}
  #mob-resize::before{content:'';width:44px;height:4px;background:var(--b3);border-radius:3px;transition:background .15s}
  #mob-resize.active::before{background:var(--red)}
}
/* DESKTOP */
@media(min-width:768px){
  #app{flex-direction:row}
  #left-pane{width:var(--split);flex-shrink:0;height:100%;display:flex;flex-direction:column;border-right:1px solid var(--b1);overflow:hidden}
  #preview-area{flex:1;min-height:0}
  #right-pane{flex:1;min-width:0;height:100%;display:flex;flex-direction:column;overflow:hidden}
  .tabs{flex-direction:column;width:56px;flex-shrink:0;border-right:1px solid var(--b1);border-bottom:none;overflow-y:auto;scrollbar-width:none}
  .tabs::-webkit-scrollbar{display:none}
  .tab{padding:11px 4px;min-height:56px;border-bottom:none;border-right:2.5px solid transparent;flex:0 0 auto}
  .tab.active{border-right-color:var(--red);border-bottom-color:transparent}
  #editor-area{flex:1;display:flex;min-height:0;overflow:hidden}
  .panel-wrap{flex:1;min-width:0}
  #split-handle{position:fixed;top:0;bottom:0;width:8px;cursor:col-resize;z-index:200}
  #split-handle::after{content:'';position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:3px;height:44px;background:var(--b3);border-radius:4px;opacity:0;transition:opacity .18s}
  #split-handle:hover::after,#split-handle.drag::after{opacity:1}
  #mob-resize{display:none!important}
}

/* ‚ïê‚ïê HEADER ‚ïê‚ïê */
header{display:flex;align-items:center;gap:5px;padding:8px 12px 8px 18px;border-bottom:1px solid var(--b1);background:var(--bg);flex-shrink:0;flex-wrap:nowrap}
.logo{display:flex;align-items:center;gap:8px;cursor:pointer;flex-shrink:0;margin-right:auto;transition:opacity .15s}
.logo:hover{opacity:.7}
.hdr-dot{width:7px;height:7px;background:var(--red);border-radius:50%;flex-shrink:0;animation:glow 3s ease-in-out infinite}
@keyframes glow{0%,100%{box-shadow:0 0 5px rgba(200,0,10,.4)}50%{box-shadow:0 0 16px rgba(200,0,10,.9)}}
.logo-n{font-size:18px;font-weight:900;letter-spacing:3px;line-height:1;display:flex;align-items:center;gap:5px}
.logo-s{font-size:7px;font-weight:700;letter-spacing:3px;color:var(--t3);margin-top:1px}
.raw-badge{font-size:6.5px;font-weight:900;background:var(--red);color:#fff;padding:1px 4px;border-radius:3px;display:none;letter-spacing:.5px}
.mode-toggle{display:flex;background:var(--s1);border:1.5px solid var(--b2);border-radius:var(--rs);overflow:hidden;flex-shrink:0}
.mode-btn{padding:4px 8px;font-family:inherit;font-size:9px;font-weight:700;border:none;background:none;color:var(--t3);cursor:pointer;transition:all .15s;white-space:nowrap}
.mode-btn.on{background:var(--red);color:#fff}
.hbtn{background:var(--s2);border:1.5px solid var(--b2);color:var(--t2);font-family:inherit;font-size:9.5px;font-weight:700;padding:4px 8px;cursor:pointer;border-radius:var(--rs);transition:all .15s;white-space:nowrap;flex-shrink:0}
.hbtn:hover{border-color:var(--t3);color:var(--t1)}
.hbtn.red{background:var(--red);color:#fff;border-color:var(--red)}
.hbtn.red:hover{opacity:.85}

/* ‚ïê‚ïê PREVIEW ‚ïê‚ïê */
#preview-area{background:#0d0d0d;display:flex;align-items:center;justify-content:center;position:relative;overflow:hidden;cursor:pointer;flex-shrink:0;border-bottom:1px solid var(--b1)}
#preview-area.has-img{cursor:default}
#preview-area.dragover{outline:3px dashed var(--red);outline-offset:-8px;background:var(--reda)}
#checker{position:absolute;inset:0;pointer-events:none;display:none;background-image:linear-gradient(45deg,#1e1e1e 25%,transparent 25%),linear-gradient(-45deg,#1e1e1e 25%,transparent 25%),linear-gradient(45deg,transparent 75%,#1e1e1e 75%),linear-gradient(-45deg,transparent 75%,#1e1e1e 75%);background-size:14px 14px;background-position:0 0,0 7px,7px -7px,-7px 0}
#cv-viewport{position:absolute;inset:0;overflow:hidden;display:none;touch-action:none;cursor:grab}
#cv-viewport.panning{cursor:grabbing}
#prev-cv{position:absolute;image-rendering:auto;transform-origin:0 0;will-change:transform}
#zoom-ctrls{position:absolute;bottom:10px;left:10px;display:none;gap:4px;flex-direction:column;z-index:10}
.zc-btn{width:30px;height:30px;background:rgba(0,0,0,.75);backdrop-filter:blur(4px);border:1px solid var(--b2);border-radius:5px;color:var(--t2);font-size:16px;font-weight:700;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:background .14s}
.zc-btn:hover{background:rgba(0,0,0,.9);color:var(--t1)}
.ph-wrap{display:flex;flex-direction:column;align-items:center;gap:10px;pointer-events:none;z-index:1}
.ph-ring{width:50px;height:50px;border:1.5px solid var(--b3);border-radius:50%;display:flex;align-items:center;justify-content:center;position:relative}
.ph-ring::before{content:'';position:absolute;inset:8px;border:1px solid var(--b2);border-radius:50%}
.ph-ring::after{content:'';position:absolute;inset:17px;border:1px solid var(--b2);border-radius:50%}
.ph-dot{width:6px;height:6px;background:var(--red);border-radius:50%}
.ph-txt{font-size:9px;font-weight:700;letter-spacing:2px;color:var(--t3);text-align:center;line-height:1.6}
#zoom-badge{position:absolute;bottom:8px;right:8px;background:rgba(0,0,0,.65);backdrop-filter:blur(4px);border:1px solid var(--b2);border-radius:4px;padding:2px 6px;font-size:8.5px;font-weight:700;letter-spacing:1px;color:var(--t2);pointer-events:none;z-index:10;display:none}
.exp-bar{position:absolute;bottom:0;left:0;right:0;height:2px;background:var(--b1);z-index:5}
.exp-fill{height:100%;background:var(--red);width:50%;transition:width .08s}

/* Always-on histogram overlay */
#ht-overlay{position:absolute;bottom:52px;right:10px;width:150px;height:62px;pointer-events:none;z-index:4;display:none;border-radius:8px;overflow:hidden;background:rgba(0,0,0,.55);border:1px solid rgba(255,255,255,.06);backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px)}
#ht-overlay canvas{display:block;width:100%;height:100%}

/* Blur selection overlay */
#blur-sel{position:absolute;inset:0;z-index:20;display:none;cursor:crosshair}
#blur-sel canvas{display:block;width:100%;height:100%;position:absolute;inset:0}
.blur-sel-hint{position:absolute;top:8px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,.8);backdrop-filter:blur(4px);border:1px solid var(--b2);border-radius:6px;padding:5px 12px;font-size:9.5px;font-weight:700;color:var(--t2);white-space:nowrap;pointer-events:none}

/* ‚ïê‚ïê TABS ‚ïê‚ïê */
.tabs{display:flex;background:var(--bg);border-bottom:1px solid var(--b1);flex-shrink:0}
.tab{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:7px 2px 6px;border:none;background:none;color:var(--t3);font-family:inherit;font-size:7.5px;font-weight:700;letter-spacing:.5px;cursor:pointer;gap:3px;border-bottom:2px solid transparent;transition:color .15s,border-color .15s}
.tab.active{color:var(--t1);border-bottom-color:var(--red)}
.tab svg{width:13px;height:13px;opacity:.5;transition:opacity .15s;flex-shrink:0}
.tab.active svg{opacity:1}
.tab span{font-size:6px;white-space:nowrap;line-height:1}

/* ‚ïê‚ïê PANELS ‚ïê‚ïê */
.panel-wrap{flex:1;overflow:hidden;min-height:0;position:relative}
.panel{display:none;padding:12px 14px 40px;overflow-y:auto;position:absolute;inset:0;overscroll-behavior-y:contain;-webkit-overflow-scrolling:touch}
.panel.on{display:block;animation:pin .16s var(--ease)}
@keyframes pin{from{opacity:0;transform:translateY(3px)}to{opacity:1;transform:none}}
.pnl-hd{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
.pnl-ttl{font-size:8px;font-weight:800;letter-spacing:3px;color:var(--t3)}

/* ‚ïê‚ïê SECTIONS ‚ïê‚ïê */
.sec{margin-bottom:2px}
.sec-hd{display:flex;align-items:center;justify-content:space-between;padding:8px 0 7px;border-bottom:1px solid var(--b1);margin-bottom:9px}
.sec-hd.clk{cursor:pointer}
.sec-hd.clk:hover .sec-ttl{color:var(--t2)}
.sec-ttl{display:flex;align-items:center;gap:6px;font-size:8px;font-weight:800;letter-spacing:2px;color:var(--t3);transition:color .15s}
.sec-bar{width:3px;height:9px;background:var(--red);border-radius:2px;flex-shrink:0}
.sec-arr{font-size:10px;color:var(--t3);transition:transform .2s var(--ease)}
.sec.closed .sec-arr{transform:rotate(-90deg)}
.sec-body{overflow:hidden;transition:max-height .25s var(--ease),opacity .2s;max-height:4000px;opacity:1}
.sec.closed .sec-body{max-height:0!important;opacity:0}

/* ‚ïê‚ïê PRO SLIDER ‚ïê‚ïê */
.sl-row{margin-bottom:12px}
.sl-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:5px}
.sl-lbl{font-size:11px;font-weight:700;color:var(--t2)}
.sl-val-wrap{position:relative}
.sl-val{font-size:11.5px;font-weight:800;color:var(--t3);font-variant-numeric:tabular-nums;cursor:pointer;padding:2px 5px;border-radius:4px;transition:color .12s,background .12s;min-width:38px;text-align:right;display:inline-block}
.sl-val.nz{color:var(--red)}
.sl-val:hover{background:var(--s2)}
.sl-inp{position:absolute;right:0;top:-3px;width:56px;height:22px;background:var(--s2);border:1.5px solid var(--red);color:var(--t1);font-family:inherit;font-size:11.5px;font-weight:800;text-align:right;padding:0 5px;border-radius:4px;outline:none;display:none;z-index:30}
/* SLIDER TRACK - the key fix: use a taller hit area */
.sl-hit{position:relative;height:32px;display:flex;align-items:center;touch-action:none;cursor:ew-resize;-webkit-user-select:none;user-select:none}
.sl-track{position:absolute;left:0;right:0;height:3px;background:var(--s3);border-radius:2px;pointer-events:none}
.sl-fill{position:absolute;height:3px;background:var(--red);border-radius:2px;pointer-events:none;transition:none}
.sl-mid{position:absolute;left:50%;top:0;width:1px;height:3px;background:var(--b3);transform:translateX(-50%);pointer-events:none}
.sl-knob{position:absolute;width:15px;height:15px;background:var(--bg);border:2.5px solid var(--red);border-radius:50%;transform:translate(-50%,-50%);top:50%;pointer-events:none;box-shadow:0 2px 5px rgba(0,0,0,.6);will-change:left;transition:none}
.sl-hit.drag .sl-knob{box-shadow:0 0 0 6px var(--reda);transform:translate(-50%,-50%) scale(1.12)}

/* ‚ïê‚ïê EASY CARD SLIDER ‚ïê‚ïê */
.ec{background:var(--s1);border:1.5px solid var(--b1);border-radius:11px;padding:12px 12px 10px;margin-bottom:9px}
.ec-hd{display:flex;align-items:center;gap:7px;margin-bottom:2px}
.ec-ico{font-size:16px}
.ec-ttl{font-size:12px;font-weight:800;color:var(--t1)}
.ec-sub{font-size:9px;color:var(--t3);font-weight:600;margin-bottom:10px}
.ec-val-row{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
.ec-val{font-size:12px;font-weight:800;color:var(--t3);font-variant-numeric:tabular-nums}
.ec-val.nz{color:var(--red)}
.es-hit{position:relative;height:38px;display:flex;align-items:center;touch-action:none;cursor:ew-resize;-webkit-user-select:none;user-select:none}
.es-bg{position:absolute;left:0;right:0;height:5px;background:var(--s3);border-radius:3px;pointer-events:none}
.es-fill{position:absolute;height:5px;border-radius:3px;pointer-events:none;background:linear-gradient(90deg,var(--red),#ff3355);transition:none}
.es-mid{position:absolute;left:50%;top:0;width:2px;height:5px;background:var(--b3);transform:translateX(-50%);pointer-events:none}
.es-knob{position:absolute;width:22px;height:22px;background:#fff;border:3px solid var(--red);border-radius:50%;transform:translate(-50%,-50%);top:50%;pointer-events:none;box-shadow:0 2px 8px rgba(0,0,0,.6);will-change:left;transition:none}
.es-hit.drag .es-knob{box-shadow:0 0 0 7px var(--reda);transform:translate(-50%,-50%) scale(1.1)}

/* ‚ïê‚ïê FILTER GRID ‚ïê‚ïê */
.fg{display:grid;grid-template-columns:repeat(3,1fr);gap:6px;margin-bottom:12px}
.fg-cat{font-size:7.5px;font-weight:800;letter-spacing:2px;color:var(--t3);grid-column:1/-1;margin-top:6px;padding-bottom:4px;border-bottom:1px solid var(--b1)}
.fg-cat:first-child{margin-top:0}
.fc{background:var(--s2);border:1.5px solid var(--b2);border-radius:9px;padding:9px 3px;cursor:pointer;text-align:center;transition:all .14s;position:relative;overflow:hidden}
.fc:hover{border-color:var(--b3)}
.fc.on{border-color:var(--red);background:var(--reda)}
.fc::after{content:'';position:absolute;bottom:0;left:0;right:0;height:2px;background:var(--red);transform:scaleX(0);transform-origin:left;transition:transform .18s var(--ease)}
.fc.on::after{transform:scaleX(1)}
.fi{font-size:18px;margin-bottom:2px}
.fn{font-size:8.5px;font-weight:800;color:var(--t2);line-height:1.2}
.fc.on .fn{color:var(--t1)}

/* ‚ïê‚ïê MISC ‚ïê‚ïê */
.ghost{background:none;border:1.5px solid var(--b2);color:var(--t2);font-size:10px;font-weight:700;padding:6px 11px;cursor:pointer;font-family:inherit;border-radius:var(--rs);transition:all .14s}
.ghost:hover{border-color:var(--t2);color:var(--t1);background:var(--s2)}
.solid{background:var(--red);color:#fff;border:none;font-size:10px;font-weight:700;padding:7px 14px;cursor:pointer;font-family:inherit;border-radius:var(--rs);transition:opacity .14s,transform .1s}
.solid:active{opacity:.85;transform:scale(.97)}
.divider{height:1px;background:var(--b1);margin:10px 0}
.inp-lbl{font-size:8px;font-weight:700;letter-spacing:1.5px;color:var(--t3);margin-bottom:4px}
input[type=number],input[type=text]{background:var(--s1);border:1.5px solid var(--b1);color:var(--t1);padding:8px 10px;font-size:12px;font-weight:600;font-family:inherit;width:100%;outline:none;border-radius:var(--rs);transition:border-color .14s}
input:focus{border-color:var(--red)}
input::placeholder{color:var(--t3)}

/* ‚ïê‚ïê CROP ‚ïê‚ïê */
.crop-grid{display:grid;grid-template-columns:1fr 1fr;gap:7px;margin-bottom:11px}
.crop-card{border:1.5px solid var(--b1);background:var(--s1);padding:10px 12px 9px;cursor:pointer;border-radius:var(--r);overflow:hidden;position:relative;transition:all .14s}
.crop-card::after{content:'';position:absolute;bottom:0;left:0;right:0;height:2px;background:var(--red);transform:scaleX(0);transform-origin:left;transition:transform .2s var(--ease)}
.crop-card.on::after{transform:scaleX(1)}
.crop-ratio{font-size:13px;font-weight:900;color:var(--t2);margin-bottom:2px}
.crop-card.on .crop-ratio{color:var(--t1)}
.crop-nm{font-size:8.5px;font-weight:700;color:var(--t3)}

/* ‚ïê‚ïê ROTATE ‚ïê‚ïê */
.rot-grid{display:grid;grid-template-columns:1fr 1fr;gap:7px;margin-bottom:11px}
.rot-btn{background:var(--s1);border:1.5px solid var(--b1);color:var(--t2);font-size:10.5px;font-weight:700;padding:11px 8px;cursor:pointer;font-family:inherit;border-radius:var(--r);display:flex;align-items:center;justify-content:center;gap:5px;transition:all .14s}
.rot-btn:hover{background:var(--s2);border-color:var(--b2);color:var(--t1)}
.rot-btn:active{transform:scale(.96)}

/* ‚ïê‚ïê MOSAIC ‚ïê‚ïê */
.mos-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:7px;margin-bottom:11px}
.mos-card{border:1.5px solid var(--b1);background:var(--s1);border-radius:var(--r);padding:11px 7px;text-align:center;cursor:pointer;transition:all .14s}
.mos-card.on{border-color:var(--red);background:var(--reda)}
.mos-sz{font-size:13px;font-weight:900;color:var(--t2)}
.mos-card.on .mos-sz{color:var(--t1)}
.mos-lbl{font-size:8.5px;color:var(--t3);font-weight:700}

/* ‚ïê‚ïê RESOLUTION ‚ïê‚ïê */
.res-row{display:flex;align-items:flex-end;gap:9px;margin-bottom:11px}
.res-x{color:var(--t3);font-size:15px;padding-bottom:7px}
.res-iw{flex:1}
.rp-cat{font-size:7.5px;font-weight:800;letter-spacing:2px;color:var(--t3);margin-top:9px;margin-bottom:3px;padding-bottom:3px;border-bottom:1px solid var(--b1)}
.rp-cat:first-child{margin-top:0}
.rp-item{display:flex;justify-content:space-between;align-items:center;padding:9px 11px;border:1.5px solid var(--b1);border-radius:var(--r);background:var(--s1);cursor:pointer;position:relative;overflow:hidden;transition:all .14s;margin-bottom:3px}
.rp-item::before{content:'';position:absolute;left:0;top:0;bottom:0;width:3px;background:var(--red);transform:scaleY(0);transform-origin:bottom;border-radius:0 2px 2px 0;transition:transform .18s var(--ease)}
.rp-item.on{background:var(--s2);border-color:var(--b2)}
.rp-item.on::before{transform:scaleY(1)}
.rp-nm{font-size:11.5px;font-weight:700;color:var(--t2)}
.rp-item.on .rp-nm{color:var(--t1)}
.rp-dim{font-size:9.5px;color:var(--t3)}

/* ‚ïê‚ïê RGB CURVE ‚ïê‚ïê */
.cv-wrap{background:var(--s1);border:1.5px solid var(--b1);border-radius:var(--r);padding:10px;margin-bottom:11px}
.cv-tabs{display:flex;gap:4px;margin-bottom:8px}
.cv-tab{flex:1;padding:4px;border:1.5px solid var(--b2);background:none;font-family:inherit;font-size:9px;font-weight:700;cursor:pointer;border-radius:var(--rs);color:var(--t3);transition:all .14s}
.cv-tab.on{color:#fff}
.cv-tab[data-ch=L].on{background:var(--s3);border-color:var(--b3)}
.cv-tab[data-ch=R].on{background:#8b0000;border-color:#8b0000}
.cv-tab[data-ch=G].on{background:#005500;border-color:#005500}
.cv-tab[data-ch=B].on{background:#00008b;border-color:#00008b}
#cv-canvas{width:100%;height:150px;display:block;border-radius:5px;cursor:crosshair;touch-action:none}

/* ‚ïê‚ïê HISTOGRAM ‚ïê‚ïê */
.ht-wrap{background:var(--s1);border:1.5px solid var(--b1);border-radius:var(--r);padding:10px;margin-bottom:11px}
.ht-tabs{display:flex;gap:4px;margin-bottom:8px}
.ht-tab{flex:1;padding:4px;border:1.5px solid var(--b2);background:none;font-family:inherit;font-size:8.5px;font-weight:700;cursor:pointer;border-radius:var(--rs);color:var(--t3);transition:all .14s}
.ht-tab.on{background:var(--s3);border-color:var(--b3);color:var(--t1)}
#ht-canvas{width:100%;height:75px;display:block;border-radius:3px}

/* ‚ïê‚ïê HSL ‚ïê‚ïê */
.hsl-cr{margin-bottom:12px}
.hsl-hd{display:flex;align-items:center;gap:7px;margin-bottom:7px}
.hsl-dot{width:10px;height:10px;border-radius:50%;flex-shrink:0}
.hsl-nm{font-size:10.5px;font-weight:700;color:var(--t2)}
.hsl-sub{display:grid;grid-template-columns:22px 1fr 34px;align-items:center;gap:5px;margin-bottom:4px}
.hsl-sl{font-size:8px;font-weight:700;color:var(--t3);text-align:center}
.hsl-v{font-size:10.5px;font-weight:800;color:var(--t3);text-align:right;font-variant-numeric:tabular-nums}
.hsl-v.nz{color:var(--red)}

/* ‚ïê‚ïê PRESETS ‚ïê‚ïê */
.pi-box{background:var(--s1);border:1.5px solid var(--b1);padding:12px;margin-bottom:11px;border-radius:var(--r)}
.pi-btns{display:flex;gap:7px;margin-top:8px}
.pc{display:flex;align-items:center;gap:8px;border:1.5px solid var(--b1);background:var(--s1);padding:10px 11px;margin-bottom:6px;border-radius:var(--r);transition:all .14s}
.pc:hover{border-color:var(--b2);background:var(--s2)}
.pc.builtin{border-left:3px solid var(--red)}
.pc-info{flex:1;min-width:0}
.pc-nm{font-size:12.5px;font-weight:700;color:var(--t1);margin-bottom:2px}
.pc-meta{font-size:8.5px;color:var(--t3);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.app-btn{background:var(--red);color:#fff;border:none;font-size:9px;font-weight:700;padding:6px 10px;cursor:pointer;font-family:inherit;border-radius:var(--rs);white-space:nowrap}
.del-btn{border:1.5px solid var(--b2);background:none;color:var(--t3);font-size:11.5px;padding:5px 9px;cursor:pointer;border-radius:var(--rs);transition:all .14s}
.del-btn:hover{border-color:var(--red);color:var(--red)}

/* ‚ïê‚ïê INFO ‚ïê‚ïê */
.info-r{display:flex;justify-content:space-between;align-items:center;padding:7px 0;border-bottom:1px solid var(--b1);gap:10px}
.info-k{font-size:8.5px;font-weight:700;letter-spacing:.8px;color:var(--t3);flex-shrink:0}
.info-v{font-size:10.5px;font-weight:600;color:var(--t2);text-align:right;word-break:break-all}
.info-sec{margin-top:7px}
.info-sh{display:flex;align-items:center;justify-content:space-between;padding:8px 11px;background:var(--s1);border:1.5px solid var(--b1);border-radius:var(--r);cursor:pointer;margin-bottom:3px;transition:background .14s}
.info-sh:hover{background:var(--s2)}
.info-sh.op{border-radius:var(--r) var(--r) 0 0;margin-bottom:0}
.info-st{font-size:10px;font-weight:700;color:var(--t2)}
.info-ch{font-size:9.5px;color:var(--t3);transition:transform .2s var(--ease)}
.info-sh.op .info-ch{transform:rotate(180deg)}
.info-sb{background:var(--s1);border:1.5px solid var(--b2);border-top:none;border-radius:0 0 var(--r) var(--r);padding:0 11px;overflow:hidden;max-height:0;transition:max-height .28s var(--ease);margin-bottom:3px}
.info-sb.op{max-height:600px;padding:2px 11px 8px}
.idr{display:flex;justify-content:space-between;padding:5px 0;border-bottom:1px solid var(--b1);gap:7px}
.idr:last-child{border-bottom:none}
.idk{font-size:8px;font-weight:700;letter-spacing:.8px;color:var(--t3);flex-shrink:0}
.idv{font-size:9.5px;font-weight:600;color:var(--t2);text-align:right}
.idv.r{color:var(--red)}

/* ‚ïê‚ïê EMPTY ‚ïê‚ïê */
.empty{text-align:center;padding:36px 0}
.e-ring{width:40px;height:40px;border:1.5px solid var(--b2);border-radius:50%;display:flex;align-items:center;justify-content:center;margin:0 auto 10px}
.e-dot{width:4px;height:4px;background:var(--b2);border-radius:50%}
.e-ttl{font-size:10.5px;font-weight:700;letter-spacing:2px;color:var(--t3);margin-bottom:4px}
.e-sub{font-size:9px;color:#252525;letter-spacing:.5px}

/* ‚ïê‚ïê BOTTOM BAR ‚ïê‚ïê */
#bot{display:none;gap:7px;padding:9px 12px;border-top:1px solid var(--b1);background:var(--bg);flex-shrink:0}
.rst{flex:1;border:1.5px solid var(--b2);background:none;color:var(--t2);padding:11px;font-size:10.5px;font-weight:700;cursor:pointer;font-family:inherit;border-radius:var(--rs);transition:all .14s}
.rst:hover{border-color:var(--t2);color:var(--t1);background:var(--s2)}
.exp-b{flex:2;background:var(--red);color:#fff;border:none;padding:11px;font-size:11.5px;font-weight:700;cursor:pointer;font-family:inherit;border-radius:var(--rs);transition:opacity .14s,transform .1s}
.exp-b:active{opacity:.85;transform:scale(.98)}

/* ‚ïê‚ïê OVERLAY MODAL BASE ‚ïê‚ïê */
.ovl{position:fixed;inset:0;z-index:850;background:rgba(0,0,0,.82);display:none;align-items:flex-end;justify-content:center;backdrop-filter:blur(8px)}
.ovl.op{display:flex;animation:mfade .22s ease}
@keyframes mfade{from{opacity:0}to{opacity:1}}
.sheet{background:rgba(12,12,12,.96);border:1px solid rgba(255,255,255,.07);border-radius:var(--r) var(--r) 0 0;padding:20px 18px 40px;width:100%;max-width:500px;animation:shup .28s cubic-bezier(.22,1,.36,1);max-height:90vh;overflow-y:auto;backdrop-filter:blur(28px);-webkit-backdrop-filter:blur(28px)}
@keyframes shup{from{transform:translateY(28px)}to{transform:none}}
.modal-ttl{font-size:11.5px;font-weight:800;letter-spacing:2.5px;color:var(--t2);margin-bottom:12px}
.modal-btns{display:flex;gap:7px}

/* ‚ïê‚ïê EXPORT SHEET ‚ïê‚ïê */
.fmt-grid{display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-bottom:12px}
.fmt-opt{border:1.5px solid var(--b2);background:var(--s2);padding:11px;border-radius:var(--rs);cursor:pointer;text-align:center;transition:all .14s}
.fmt-opt.on{border-color:var(--red);background:var(--reda)}
.fmt-nm{font-size:10.5px;font-weight:700;color:var(--t2)}
.fmt-opt.on .fmt-nm{color:var(--t1)}
.fmt-sub{font-size:8.5px;color:var(--t3);margin-top:2px}

/* ‚ïê‚ïê CONFIRM ‚ïê‚ïê */
#confirm{position:fixed;inset:0;z-index:9800;background:rgba(0,0,0,.85);display:none;align-items:center;justify-content:center;backdrop-filter:blur(10px)}
#confirm.op{display:flex;animation:mfade .2s ease}
.confirm-box{background:var(--s1);border:1.5px solid var(--b2);border-radius:14px;padding:26px 20px;max-width:300px;width:90%;text-align:center}
.confirm-ico{font-size:28px;margin-bottom:9px}
.confirm-ttl{font-size:14px;font-weight:800;color:var(--t1);margin-bottom:7px}
.confirm-sub{font-size:11px;color:var(--t2);margin-bottom:20px;line-height:1.6;white-space:pre-line}
.confirm-btns{display:flex;gap:9px}
.c-ok{flex:1;background:var(--red);color:#fff;border:none;padding:11px;font-size:11.5px;font-weight:700;border-radius:var(--rs);cursor:pointer;font-family:inherit}
.c-no{flex:1;background:none;border:1.5px solid var(--b2);color:var(--t2);padding:11px;font-size:11.5px;font-weight:700;border-radius:var(--rs);cursor:pointer;font-family:inherit}

/* ‚ïê‚ïê SETTINGS ‚ïê‚ïê */
.s-row{display:flex;align-items:center;justify-content:space-between;padding:11px 0;border-bottom:1px solid var(--b1)}
.s-row:last-child{border-bottom:none}
.s-lbl{font-size:11.5px;font-weight:700;color:var(--t1)}
.s-sub{font-size:9px;color:var(--t3);margin-top:2px}
.s-tog{position:relative;width:42px;height:22px;flex-shrink:0}
.s-tog input{opacity:0;width:0;height:0;position:absolute}
.s-tog-sl{position:absolute;inset:0;background:var(--b2);border-radius:22px;cursor:pointer;transition:background .2s}
.s-tog-sl::before{content:'';position:absolute;height:16px;width:16px;left:3px;top:3px;background:#fff;border-radius:50%;transition:transform .2s}
.s-tog input:checked+.s-tog-sl{background:var(--red)}
.s-tog input:checked+.s-tog-sl::before{transform:translateX(20px)}
.seg{display:flex;background:var(--s2);border:1.5px solid var(--b2);border-radius:var(--rs);overflow:hidden;flex-shrink:0}
.seg-b{flex:1;padding:4px 8px;font-family:inherit;font-size:9px;font-weight:700;border:none;background:none;color:var(--t3);cursor:pointer;transition:all .15s;white-space:nowrap}
.seg-b.on{background:var(--red);color:#fff}
.s-sec{font-size:7.5px;font-weight:800;letter-spacing:3px;color:var(--t3);margin:14px 0 5px}

/* ‚ïê‚ïê HELP ‚ïê‚ïê */
.help-step{display:flex;gap:11px;margin-bottom:16px}
.help-num{width:26px;height:26px;background:var(--red);color:#fff;border-radius:50%;font-size:10.5px;font-weight:800;display:flex;align-items:center;justify-content:center;flex-shrink:0;margin-top:1px}
.help-ttl{font-size:12.5px;font-weight:800;color:var(--t1);margin-bottom:3px}
.help-desc{font-size:10.5px;color:var(--t2);line-height:1.6}

/* ‚ïê‚ïê SCROLLBAR ‚ïê‚ïê */
::-webkit-scrollbar{width:2px;height:2px}
::-webkit-scrollbar-track{background:var(--bg)}
::-webkit-scrollbar-thumb{background:var(--b3);border-radius:2px}

/* ‚îÄ‚îÄ DRAW TOOL BUTTONS ‚îÄ‚îÄ */
.drw-b{width:28px;height:28px;background:var(--s2);border:1.5px solid var(--b2);color:var(--t2);border-radius:var(--rs);cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .14s;flex-shrink:0}
.drw-b:hover{border-color:var(--b3);color:var(--t1)}
.drw-b.on{background:var(--red);border-color:var(--red);color:#fff}

/* ‚îÄ‚îÄ FRAME CARDS ‚îÄ‚îÄ */
.frame-card{cursor:pointer;border:1.5px solid var(--b2);border-radius:var(--rs);padding:7px;background:var(--s1);transition:all .15s;text-align:center}
.frame-card:hover{border-color:var(--b3);background:var(--s2)}
.frame-card.on{border-color:var(--red);background:var(--s2)}
.frame-preview{border-radius:3px;overflow:hidden;margin-bottom:4px}
.frame-nm{font-size:8px;font-weight:700;color:var(--t3);letter-spacing:.3px}
.frame-card.on .frame-nm{color:var(--t1)}

/* ‚îÄ‚îÄ DRAW CANVAS OVERLAY ‚îÄ‚îÄ */
#draw-cv{position:absolute;inset:0;z-index:25;cursor:crosshair;touch-action:none;display:none;pointer-events:none}
#draw-cv.active{pointer-events:auto}

/* ‚îÄ‚îÄ SPLASH ANIMATION ENHANCEMENTS ‚îÄ‚îÄ */
.sp-scan{position:absolute;inset:0;background:linear-gradient(0deg,transparent 49%,rgba(200,0,10,.03) 50%,transparent 51%);background-size:100% 4px;pointer-events:none;z-index:2;animation:sp-scanline 8s linear infinite}
@keyframes sp-scanline{from{background-position:0 0}to{background-position:0 100%}}
.sp-corner{position:absolute;width:28px;height:28px;pointer-events:none;z-index:3;opacity:0;animation:sp-corner-in 1s ease forwards}
.sp-corner.tl{top:18px;left:18px;border-top:1.5px solid rgba(200,0,10,.5);border-left:1.5px solid rgba(200,0,10,.5);animation-delay:.3s}
.sp-corner.tr{top:18px;right:18px;border-top:1.5px solid rgba(200,0,10,.5);border-right:1.5px solid rgba(200,0,10,.5);animation-delay:.4s}
.sp-corner.bl{bottom:18px;left:18px;border-bottom:1.5px solid rgba(200,0,10,.5);border-left:1.5px solid rgba(200,0,10,.5);animation-delay:.5s}
.sp-corner.br{bottom:18px;right:18px;border-bottom:1.5px solid rgba(200,0,10,.5);border-right:1.5px solid rgba(200,0,10,.5);animation-delay:.6s}
.sp-hud{position:absolute;bottom:60px;display:flex;gap:40px;z-index:3;pointer-events:none;animation:sp-fadein .8s .7s ease both}
.sp-hud-item{display:flex;flex-direction:column;align-items:center;gap:3px}
.sp-hud-val{font-size:9px;font-weight:800;letter-spacing:2px;color:rgba(200,0,10,.6);font-variant-numeric:tabular-nums}
.sp-hud-lbl{font-size:6px;font-weight:700;letter-spacing:2px;color:rgba(255,255,255,.15)}
.sp-exp{position:absolute;left:50%;transform:translateX(-50%);bottom:38px;display:flex;align-items:center;gap:8px;pointer-events:none;z-index:3;animation:sp-fadein .8s .8s ease both}
.sp-exp-bar{width:80px;height:1px;background:rgba(255,255,255,.08);position:relative;overflow:visible}
.sp-exp-mark{position:absolute;top:-3px;left:50%;transform:translateX(-50%);width:1px;height:7px;background:var(--red);animation:sp-exp-blink 2s ease-in-out infinite}
@keyframes sp-exp-blink{0%,100%{opacity:.3}50%{opacity:1}}
@keyframes sp-corner-in{from{opacity:0;transform:scale(.7)}to{opacity:1;transform:scale(1)}}
.sp-exp-txt{font-size:7px;font-weight:700;letter-spacing:2px;color:rgba(255,255,255,.15)}
.sp-aperture{font-size:9px;font-weight:800;letter-spacing:2px;color:rgba(200,0,10,.5);animation:sp-ap-cycle 4s steps(4) infinite}
@keyframes sp-ap-cycle{0%{content:'f/1.4'}25%{opacity:.8}50%{opacity:1}75%{opacity:.6}100%{opacity:1}}
</style>
</head>
<body>

<!-- SPLASH -->
<div id="splash">
  <div class="sp-rings">
    <div class="sp-r1"></div><div class="sp-r2"></div><div class="sp-r3"></div><div class="sp-r4"></div>
    <div class="sp-core"><div class="sp-dot"></div></div>
  </div>
  <div class="sp-logo-wrap">
    <div class="sp-brand">PHOTO EDITOR</div>
    <div class="sp-name">LENS</div>
    <div class="sp-sub" id="sp-sub">„Éï„Ç©„Éà„Ç®„Éá„Ç£„Çø„Éº</div>
  </div>
  <div class="sp-tap">
    <div class="sp-tap-line"></div>
    <span id="sp-cta">„Çø„ÉÉ„Éó„Åó„Å¶ÈñãÂßã</span>
    <div class="sp-tap-line"></div>
  </div>
  <!-- Leica HUD elements -->
  <div class="sp-scan"></div>
  <div class="sp-corner tl"></div>
  <div class="sp-corner tr"></div>
  <div class="sp-corner bl"></div>
  <div class="sp-corner br"></div>
  <div class="sp-hud">
    <div class="sp-hud-item"><div class="sp-hud-val" id="sp-iso">ISO 400</div><div class="sp-hud-lbl">SENSITIVITY</div></div>
    <div class="sp-hud-item"><div class="sp-hud-val sp-aperture">f/1.4</div><div class="sp-hud-lbl">APERTURE</div></div>
    <div class="sp-hud-item"><div class="sp-hud-val">1/250</div><div class="sp-hud-lbl">SHUTTER</div></div>
  </div>
  <div class="sp-exp">
    <span class="sp-exp-txt">EV</span>
    <div class="sp-exp-bar"><div class="sp-exp-mark"></div></div>
    <span class="sp-exp-txt">¬±0</span>
  </div>
</div>

<!-- APP -->
<div id="app">
  <!-- LEFT -->
  <div id="left-pane">
    <header>
      <div class="logo" onclick="goHome()">
        <div class="hdr-dot"></div>
        <div>
          <div class="logo-n">LENS<span class="raw-badge" id="raw-badge"></span></div>
          <div class="logo-s" id="hdr-sub">PHOTO EDITOR</div>
        </div>
      </div>
      <div class="mode-toggle">
        <button class="mode-btn" id="mb-easy" onclick="setMode('easy')">„Åã„Çì„Åü„Çì</button>
        <button class="mode-btn on" id="mb-pro" onclick="setMode('pro')">PRO</button>
      </div>
      <button class="hbtn" id="lang-btn" onclick="toggleLang()">EN</button>
      <button class="hbtn" id="stg-btn" onclick="openSettings()">‚öô</button>
      <button class="hbtn" id="open-btn" onclick="triggerOpen()">Èñã„Åè</button>
      <button class="hbtn red" id="exp-hbtn" style="display:none" onclick="openExport()">Êõ∏„ÅçÂá∫„Åô</button>
      <input id="fi" type="file" accept="image/*,.raw,.cr2,.cr3,.cr4,.nef,.nrw,.arw,.sr2,.orf,.rw2,.pef,.ptx,.dng,.heic,.heif,.avif,.tiff,.tif,.bmp,.webp" style="display:none" onchange="onFI(event)"/>
    </header>

    <div id="preview-area" onclick="onPreviewClick()">
      <div id="checker"></div>
      <div class="ph-wrap" id="ph">
        <div class="ph-ring"><div class="ph-dot"></div></div>
        <div class="ph-txt" id="ph-txt">„Çø„ÉÉ„Éó„Åæ„Åü„ÅØ„Éâ„É≠„ÉÉ„Éó„Åó„Å¶<br>ÂÜôÁúü„ÇíÈñã„Åè</div>
      </div>
      <div id="cv-viewport">
        <canvas id="prev-cv"></canvas>
      </div>
      <div id="zoom-ctrls">
        <button class="zc-btn" onclick="zoomIn()">Ôºã</button>
        <button class="zc-btn" onclick="zoomReset()" style="font-size:10px">FIT</button>
        <button class="zc-btn" onclick="zoomOut()">Ôºç</button>
      </div>
      <div id="ht-overlay"><div style="position:absolute;top:3px;left:6px;font-size:6px;font-weight:800;letter-spacing:2px;color:rgba(255,255,255,.3);z-index:1;pointer-events:none">HIST</div><canvas id="ht-ov-cv" style="position:relative;z-index:0"></canvas></div>
      <div id="zoom-badge">100%</div>
      <div id="blur-sel">
        <canvas id="blur-sel-cv"></canvas>
        <div class="blur-sel-hint" id="blur-hint">„Éâ„É©„ÉÉ„Ç∞„Åó„Å¶ÁØÑÂõ≤„Çí„Åº„Åã„Åô ‚Äî „ÉÄ„Éñ„É´„Çø„ÉÉ„Éó„ÅßÁµÇ‰∫Ü</div>
      </div>
      <div class="exp-bar"><div class="exp-fill" id="exp-fill"></div></div>
    </div>

    <div id="mob-resize"></div>
    <div id="split-handle"></div>
  </div>

  <!-- RIGHT -->
  <div id="right-pane">
    <div id="editor-area">
      <nav class="tabs" id="tabs">
        <button class="tab" data-tab="efilter" data-m="easy" onclick="sw('efilter')">
          <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M8 2l1.5 3 3.5.5-2.5 2.5.6 3.5L8 10l-3.1 1.5.6-3.5L3 5.5l3.5-.5z"/></svg>
          <span id="tl-efilter">„Éï„Ç£„É´„Çø„Éº</span></button>
        <button class="tab" data-tab="eadj" data-m="easy" onclick="sw('eadj')">
          <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="8" cy="8" r="5.5"/><line x1="8" y1="3" x2="8" y2="13"/><line x1="3" y1="8" x2="13" y2="8"/></svg>
          <span id="tl-eadj">Ë™øÊï¥</span></button>
        <button class="tab" data-tab="tone" data-m="pro" onclick="sw('tone')">
          <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="8" cy="8" r="5"/><line x1="8" y1="3" x2="8" y2="13"/></svg>
          <span id="tl-tone">„Éà„Éº„É≥</span></button>
        <button class="tab" data-tab="color" data-m="pro" onclick="sw('color')">
          <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M8 2a6 6 0 100 12A6 6 0 008 2z"/><path d="M8 2c2 2 2 8 0 12M8 2C6 4 6 10 8 14"/></svg>
          <span id="tl-color">„Ç´„É©„Éº</span></button>
        <button class="tab" data-tab="detail" data-m="pro" onclick="sw('detail')">
          <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M3 8h10M8 3v10M4.5 4.5l7 7M11.5 4.5l-7 7"/></svg>
          <span id="tl-detail">Ë©≥Á¥∞</span></button>
        <button class="tab" data-tab="xform" data-m="pro" onclick="sw('xform')">
          <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M5 3L2 8l3 5M11 3l3 5-3 5"/><line x1="2" y1="8" x2="14" y2="8"/></svg>
          <span id="tl-xform">Â§âÂΩ¢</span></button>
        <button class="tab" data-tab="cut" onclick="sw('cut')">
          <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="3" width="10" height="10" rx="1"/><line x1="3" y1="7" x2="13" y2="7"/><line x1="7" y1="3" x2="7" y2="13"/></svg>
          <span id="tl-cut">„Ç´„ÉÉ„Éà</span></button>
        <button class="tab" data-tab="mosaic" data-m="pro" onclick="sw('mosaic')">
          <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="2" y="2" width="5" height="5" rx="1"/><rect x="9" y="2" width="5" height="5" rx="1"/><rect x="2" y="9" width="5" height="5" rx="1"/><rect x="9" y="9" width="5" height="5" rx="1"/></svg>
          <span id="tl-mosaic">„É¢„Ç∂„Ç§„ÇØ</span></button>
        <button class="tab" data-tab="blur" data-m="pro" onclick="sw('blur')">
          <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="8" cy="8" r="5"/><circle cx="8" cy="8" r="2.5" stroke-dasharray="1.5 1.5"/></svg>
          <span id="tl-blur">„Åº„Åã„Åó</span></button>
        <button class="tab" data-tab="size" data-m="pro" onclick="sw('size')">
          <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="2" y="4" width="8" height="8" rx="1"/><rect x="6" y="2" width="8" height="8" rx="1"/></svg>
          <span id="tl-size">„Çµ„Ç§„Ç∫</span></button>
        <button class="tab" data-tab="preset" onclick="sw('preset')">
          <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M4 8a4 4 0 108 0 4 4 0 00-8 0z"/><path d="M8 5v3l2 2"/></svg>
          <span id="tl-preset">„Éó„É™„Çª„ÉÉ„Éà</span></button>
        <button class="tab" data-tab="info" data-m="pro" onclick="sw('info')">
          <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="8" cy="8" r="5.5"/><line x1="8" y1="7" x2="8" y2="11"/><circle cx="8" cy="5" r=".5" fill="currentColor"/></svg>
          <span id="tl-info">ÊÉÖÂ†±</span></button>
        <button class="tab" data-tab="frame" onclick="sw('frame')">
          <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="2" y="2" width="12" height="12" rx="1"/><rect x="4" y="4" width="8" height="8" rx="0.5" stroke-dasharray="2 1"/></svg>
          <span id="tl-frame">„Éï„É¨„Éº„É†</span></button>
        <button class="tab" data-tab="draw" data-m="pro" onclick="sw('draw')">
          <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M2 13l3-1 7-7-2-2-7 7-1 3z"/><path d="M10 3l2-2 2 2-2 2z"/></svg>
          <span id="tl-draw">ÊèèÁîª</span></button>
      </nav>

      <div class="panel-wrap">

        <!-- EASY FILTER -->
        <div class="panel" id="panel-efilter">
          <div class="pnl-hd"><div class="pnl-ttl" id="pt-efilter">„Éï„Ç£„É´„Çø„Éº & „É´„ÉÉ„ÇØ</div></div>
          <div id="cheki-box" style="background:linear-gradient(135deg,#1a1a1a,#1e1e1e);border:1.5px solid #252525;border-radius:11px;padding:13px;margin-bottom:14px">
            <div style="display:flex;align-items:center;gap:7px;margin-bottom:8px">
              <span style="font-size:18px">üì∑</span>
              <div>
                <div style="font-size:12.5px;font-weight:800;color:#f0f0f0" id="cheki-ttl">„ÉÅ„Çß„Ç≠È¢®„Å´‰ªï‰∏ä„Åí„Çã</div>
                <div style="font-size:9px;color:#555;margin-top:1px" id="cheki-sub">„Ç§„É≥„Çπ„Çø„É≥„Éà„Éï„Ç©„ÉàÈ¢®</div>
              </div>
            </div>
            <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:5px">
              <button onclick="applyCheki('soft')" style="background:#1e1e1e;border:1.5px solid #2a2a2a;color:#ccc;font-size:9px;font-weight:700;padding:8px 3px;border-radius:7px;cursor:pointer;font-family:inherit" id="chk-soft">üå∏ „ÇΩ„Éï„Éà</button>
              <button onclick="applyCheki('warm')" style="background:#1e1e1e;border:1.5px solid #2a2a2a;color:#ccc;font-size:9px;font-weight:700;padding:8px 3px;border-radius:7px;cursor:pointer;font-family:inherit" id="chk-warm">‚òÄÔ∏è „Ç¶„Ç©„Éº„É†</button>
              <button onclick="applyCheki('cool')" style="background:#1e1e1e;border:1.5px solid #2a2a2a;color:#ccc;font-size:9px;font-weight:700;padding:8px 3px;border-radius:7px;cursor:pointer;font-family:inherit" id="chk-cool">üßä „ÇØ„Éº„É´</button>
            </div>
          </div>
          <div class="fg" id="filter-grid"></div>
          <div class="pnl-ttl" style="margin-bottom:9px" id="filt-str-lbl">„Éï„Ç£„É´„Çø„Éº„ÅÆÂº∑„Åï</div>
          <div id="filt-intensity"></div>
          <div style="margin-top:20px;text-align:center">
            <button class="ghost" onclick="openHelp()" id="help-btn" style="width:100%;font-size:10.5px">‚ùì „Éò„É´„Éó / ‰Ωø„ÅÑÊñπ</button>
          </div>
        </div>

        <!-- EASY ADJ -->
        <div class="panel" id="panel-eadj">
          <div class="pnl-hd">
            <div class="pnl-ttl" id="pt-eadj">„Åã„Çì„Åü„ÇìË™øÊï¥</div>
            <button class="ghost" id="rst-easy" onclick="resetAdj()">„É™„Çª„ÉÉ„Éà</button>
          </div>
          <div id="easy-cards"></div>
        </div>

        <!-- PRO TONE -->
        <div class="panel on" id="panel-tone">
          <div class="pnl-hd">
            <div class="pnl-ttl" id="pt-tone">„Éà„Éº„É≥„ÉªÈú≤ÂÖâ</div>
            <button class="ghost" id="rst-tone" onclick="resetAdj()">„É™„Çª„ÉÉ„Éà</button>
          </div>
          <div id="sl-tone"></div>
          <div class="sec">
            <div class="sec-hd clk" onclick="toggleSec(this)">
              <div class="sec-ttl"><div class="sec-bar"></div><span id="ht-lbl">„Éí„Çπ„Éà„Ç∞„É©„É†</span></div>
              <span class="sec-arr">‚ñæ</span>
            </div>
            <div class="sec-body">
              <div class="ht-wrap">
                <div class="ht-tabs">
                  <button class="ht-tab on" id="ht-rgb" onclick="setHtMode(this,'rgb')">RGB</button>
                  <button class="ht-tab" id="ht-luma" onclick="setHtMode(this,'luma')">LUMA</button>
                </div>
                <canvas id="ht-canvas"></canvas>
              </div>
            </div>
          </div>
        </div>

        <!-- PRO COLOR -->
        <div class="panel" id="panel-color">
          <div class="pnl-ttl" style="margin-bottom:11px" id="pt-color">„Ç´„É©„Éº„Ç∞„É¨„Éº„Éá„Ç£„É≥„Ç∞</div>
          <div id="sl-color"></div>
          <div class="sec">
            <div class="sec-hd"><div class="sec-ttl"><div class="sec-bar"></div><span id="cv-lbl">RGB„Ç´„Éº„Éñ</span></div></div>
            <div class="sec-body">
              <div class="cv-wrap">
                <div class="cv-tabs">
                  <button class="cv-tab on" data-ch="L" onclick="setCvCh(this,'L')">LUMA</button>
                  <button class="cv-tab" data-ch="R" onclick="setCvCh(this,'R')">R</button>
                  <button class="cv-tab" data-ch="G" onclick="setCvCh(this,'G')">G</button>
                  <button class="cv-tab" data-ch="B" onclick="setCvCh(this,'B')">B</button>
                </div>
                <canvas id="cv-canvas"></canvas>
                <div style="font-size:7.5px;color:var(--t3);margin-top:5px" id="cv-hint">„Éâ„É©„ÉÉ„Ç∞„ÅßÁßªÂãï ¬∑ „Çø„ÉÉ„Éó„ÅßËøΩÂä† ¬∑ „ÉÄ„Éñ„É´„Çø„ÉÉ„Éó„ÅßÂâäÈô§</div>
              </div>
            </div>
          </div>
          <div class="sec">
            <div class="sec-hd clk" onclick="toggleSec(this)">
              <div class="sec-ttl"><div class="sec-bar"></div><span id="hsl-sec-lbl">HSL„Éü„Ç≠„Çµ„Éº</span></div>
              <span class="sec-arr">‚ñæ</span>
            </div>
            <div class="sec-body"><div id="hsl-panel"></div></div>
          </div>
          <div class="sec closed">
            <div class="sec-hd clk" onclick="toggleSec(this)">
              <div class="sec-ttl"><div class="sec-bar"></div><span id="cmix-lbl">„Ç´„É©„Éº„Éü„ÉÉ„ÇØ„Çπ (‰∏äÁ¥ö)</span></div>
              <span class="sec-arr">‚ñæ</span>
            </div>
            <div class="sec-body"><div id="sl-adv"></div></div>
          </div>
        </div>

        <!-- PRO DETAIL -->
        <div class="panel" id="panel-detail">
          <div class="pnl-ttl" style="margin-bottom:11px" id="pt-detail">„Éá„Ç£„ÉÜ„Éº„É´„ÉªÂÖâÂ≠¶</div>
          <div id="sl-detail"></div>
        </div>

        <!-- PRO TRANSFORM -->
        <div class="panel" id="panel-xform">
          <div class="pnl-ttl" style="margin-bottom:11px" id="pt-xform">ÂõûËª¢„ÉªÂ§âÂΩ¢</div>
          <div class="rot-grid">
            <button class="rot-btn" onclick="doRotate(-90)"><span style="font-size:15px">‚Ü∫</span><span id="rot-l">Â∑¶ÂõûËª¢</span></button>
            <button class="rot-btn" onclick="doRotate(90)"><span style="font-size:15px">‚Üª</span><span id="rot-r">Âè≥ÂõûËª¢</span></button>
            <button class="rot-btn" onclick="doFlipH()"><span style="font-size:15px">‚áÑ</span><span id="flip-h">Ê∞¥Âπ≥ÂèçËª¢</span></button>
            <button class="rot-btn" onclick="doFlipV()"><span style="font-size:15px">‚áÖ</span><span id="flip-v">ÂûÇÁõ¥ÂèçËª¢</span></button>
          </div>
          <div id="sl-xform"></div>
        </div>

        <!-- CUT -->
        <div class="panel" id="panel-cut">
          <div class="pnl-ttl" style="margin-bottom:11px" id="pt-cut">„Ç´„ÉÉ„Éà„Éª„Éï„É¨„Éº„É†</div>
          <div style="font-size:8px;color:var(--t3);font-weight:700;letter-spacing:1.5px;margin-bottom:7px" id="cut-basic">Âü∫Êú¨</div>
          <div class="crop-grid">
            <div class="crop-card on" onclick="pickCrop(this)"><div class="crop-ratio">1:1</div><div class="crop-nm" id="cr-sq">„Çπ„ÇØ„Ç®„Ç¢</div></div>
            <div class="crop-card" onclick="pickCrop(this)"><div class="crop-ratio">4:3</div><div class="crop-nm" id="cr-std">„Çπ„Çø„É≥„ÉÄ„Éº„Éâ</div></div>
            <div class="crop-card" onclick="pickCrop(this)"><div class="crop-ratio">16:9</div><div class="crop-nm" id="cr-wide">„ÉØ„Ç§„Éâ</div></div>
            <div class="crop-card" onclick="pickCrop(this)"><div class="crop-ratio">3:4</div><div class="crop-nm" id="cr-port">„Éù„Éº„Éà„É¨„Éº„Éà</div></div>
            <div class="crop-card" onclick="pickCrop(this)"><div class="crop-ratio">9:16</div><div class="crop-nm" id="cr-story">„Çπ„Éà„Éº„É™„Éº</div></div>
            <div class="crop-card" onclick="pickCrop(this)"><div class="crop-ratio">FREE</div><div class="crop-nm" id="cr-free">„Ç´„Çπ„Çø„É†</div></div>
          </div>
          <div style="font-size:8px;color:var(--t3);font-weight:700;letter-spacing:1.5px;margin:9px 0 7px">üì∏ Ë®ºÊòéÂÜôÁúü</div>
          <div class="crop-grid">
            <div class="crop-card" onclick="pickCrop(this,30,40)"><div class="crop-ratio" style="font-size:10px">30√ó40</div><div class="crop-nm">„Éë„Çπ„Éù„Éº„Éà</div></div>
            <div class="crop-card" onclick="pickCrop(this,35,45)"><div class="crop-ratio" style="font-size:10px">35√ó45</div><div class="crop-nm">„Éû„Ç§„Éä„É≥„Éê„Éº</div></div>
            <div class="crop-card" onclick="pickCrop(this,24,30)"><div class="crop-ratio" style="font-size:10px">24√ó30</div><div class="crop-nm">Â±•Ê≠¥Êõ∏S</div></div>
            <div class="crop-card" onclick="pickCrop(this,40,50)"><div class="crop-ratio" style="font-size:10px">40√ó50</div><div class="crop-nm">Â±•Ê≠¥Êõ∏L</div></div>
            <div class="crop-card" onclick="pickCrop(this,25,30)"><div class="crop-ratio" style="font-size:10px">25√ó30</div><div class="crop-nm">ÈÅãËª¢ÂÖçË®±</div></div>
            <div class="crop-card" onclick="pickCrop(this,45,45)"><div class="crop-ratio" style="font-size:10px">45√ó45</div><div class="crop-nm">„Éì„Ç∂Áî®</div></div>
          </div>
          <div style="font-size:8px;color:var(--t3);font-weight:700;letter-spacing:1.5px;margin:9px 0 7px">üìÆ „Éó„É™„É≥„ÉàÂà§</div>
          <div class="crop-grid">
            <div class="crop-card" onclick="pickCrop(this,89,127)"><div class="crop-ratio" style="font-size:10px">LÂà§</div><div class="crop-nm">89√ó127</div></div>
            <div class="crop-card" onclick="pickCrop(this,102,152)"><div class="crop-ratio" style="font-size:10px">2LÂà§</div><div class="crop-nm">102√ó152</div></div>
            <div class="crop-card" onclick="pickCrop(this,62,99)"><div class="crop-ratio" style="font-size:10px">„ÉÅ„Çß„Ç≠</div><div class="crop-nm">62√ó99</div></div>
            <div class="crop-card" onclick="pickCrop(this,100,148)"><div class="crop-ratio" style="font-size:10px">„ÅØ„Åå„Åç</div><div class="crop-nm">100√ó148</div></div>
          </div>
        </div>

        <!-- MOSAIC -->
        <div class="panel" id="panel-mosaic">
          <div class="pnl-ttl" style="margin-bottom:7px" id="pt-mosaic">„É¢„Ç∂„Ç§„ÇØ</div>
          <div id="mosaic-desc" style="font-size:10.5px;color:var(--t2);margin-bottom:12px">„É¢„Ç∂„Ç§„ÇØ„ÅÆ„Çµ„Ç§„Ç∫„ÇíÈÅ∏Êäû</div>
          <div class="mos-grid" id="mos-grid"></div>
          <button class="ghost" id="clear-mos" style="width:100%" onclick="clearMosaic()">„É¢„Ç∂„Ç§„ÇØ„ÇíÊ∂à„Åô</button>
        </div>

        <!-- BLUR (range selection) -->
        <div class="panel" id="panel-blur">
          <div class="pnl-ttl" style="margin-bottom:7px" id="pt-blur">ÁØÑÂõ≤„Åº„Åã„Åó</div>
          <div style="font-size:10.5px;color:var(--t2);margin-bottom:12px;line-height:1.6" id="blur-desc">„Éó„É¨„Éì„É•„Éº‰∏ä„Åß„Éâ„É©„ÉÉ„Ç∞„Åó„Å¶ÁØÑÂõ≤„ÇíÈÅ∏Êäû„Åó„ÄÅ„Åº„Åã„Åó„ÇíÈÅ©Áî®„Åó„Åæ„Åô„ÄÇ</div>
          <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px;margin-bottom:11px">
            <div style="border:1.5px solid var(--red);background:var(--reda);border-radius:var(--r);padding:9px 5px;text-align:center;cursor:pointer" id="bsc-circle" onclick="setBlurShape('circle')">
              <div style="font-size:16px">‚≠ï</div><div style="font-size:8.5px;font-weight:700;color:var(--t1)" id="bs-circle-lbl">ÂÜÜÂΩ¢</div></div>
            <div style="border:1.5px solid var(--b1);background:var(--s1);border-radius:var(--r);padding:9px 5px;text-align:center;cursor:pointer" id="bsc-rect" onclick="setBlurShape('rect')">
              <div style="font-size:16px">‚¨ú</div><div style="font-size:8.5px;font-weight:700;color:var(--t3)" id="bs-rect-lbl">Áü©ÂΩ¢</div></div>
            <div style="border:1.5px solid var(--b1);background:var(--s1);border-radius:var(--r);padding:9px 5px;text-align:center;cursor:pointer" id="bsc-gradient" onclick="setBlurShape('gradient')">
              <div style="font-size:16px">üå´Ô∏è</div><div style="font-size:8.5px;font-weight:700;color:var(--t3)" id="bs-gradient-lbl">„Ç∞„É©„Éá</div></div>
          </div>
          <div id="sl-blur-strength"></div>
          <div id="sl-blur-feather"></div>
          <button class="solid" id="blur-start-btn" style="width:100%;margin-bottom:8px" onclick="startBlurSel()">üéØ ÁØÑÂõ≤ÈÅ∏Êäû„ÇíÈñãÂßã</button>
          <button class="ghost" id="blur-clear-btn" style="width:100%;margin-bottom:10px" onclick="clearBlurRegions()">„Åº„Åã„Åó„ÇíÊ∂à„Åô</button>
          <div style="font-size:8px;font-weight:700;letter-spacing:2px;color:var(--t3);margin-bottom:6px">ÈÅ©Áî®Ê∏à„Åø„Ç®„É™„Ç¢</div>
          <div id="blur-regions-list"></div>
          <div style="margin-top:12px;padding:10px;background:var(--s2);border:1px solid var(--b2);border-radius:var(--rs)">
            <div style="font-size:8px;font-weight:700;letter-spacing:1.5px;color:var(--t3);margin-bottom:5px" id="blur-tip-lbl">‰Ωø„ÅÑÊñπ</div>
            <div style="font-size:9.5px;color:var(--t3);line-height:1.6" id="blur-tip-txt">„ÄåÈñãÂßã„Äç„ÇíÊäº„Åó„Å¶ÂÜôÁúü„ÅÆ‰∏ä„Åß„Éâ„É©„ÉÉ„Ç∞„ÄÇÂÜÜÂΩ¢„ÅÆÁØÑÂõ≤„Åå„Åº„Åã„Åï„Çå„Åæ„Åô„ÄÇ„ÉÄ„Éñ„É´„Çø„ÉÉ„Éó„ÅßÁµÇ‰∫Ü„ÄÇ</div>
          </div>
        </div>

        <!-- SIZE -->
        <div class="panel" id="panel-size">
          <div class="pnl-ttl" style="margin-bottom:11px" id="pt-size">Âá∫Âäõ„Çµ„Ç§„Ç∫</div>
          <div class="res-row">
            <div class="res-iw"><div class="inp-lbl" id="sw-lbl">Ê®™ÂπÖ px</div><input type="number" id="rw" value="1080" oninput="onResChange()"/></div>
            <div class="res-x">√ó</div>
            <div class="res-iw"><div class="inp-lbl" id="sh-lbl">Á∏¶ÂπÖ px</div><input type="number" id="rh" value="1080" oninput="onResChange()"/></div>
          </div>
          <div class="divider"></div>
          <div id="rp-list"></div>
        </div>

        <!-- PRESET -->
        <div class="panel" id="panel-preset">
          <div class="pnl-hd">
            <div class="pnl-ttl" id="pt-preset">„Éó„É™„Çª„ÉÉ„Éà</div>
            <button class="solid" id="pi-open-btn" onclick="showPI()">Ôºã ‰øùÂ≠ò</button>
          </div>
          <div id="pi-box" style="display:none" class="pi-box">
            <div class="inp-lbl" id="pi-nm-lbl">„Éó„É™„Çª„ÉÉ„ÉàÂêç</div>
            <input type="text" id="pi-name" style="margin-bottom:8px"/>
            <div class="pi-btns">
              <button class="solid" id="pi-save-btn" style="flex:1" onclick="savePreset()">‰øùÂ≠ò</button>
              <button class="ghost" id="pi-cancel-btn" style="flex:1" onclick="hidePI()">„Ç≠„É£„É≥„Çª„É´</button>
            </div>
          </div>
          <div id="preset-list"></div>
        </div>

        <!-- INFO -->

        <div class="panel" id="panel-frame">
          <div class="pnl-ttl" id="pt-frame" style="margin-bottom:11px">„Éï„É¨„Éº„É†</div>
          <!-- Cheki style buttons -->
          <div style="margin-bottom:14px">
            <div style="font-size:8px;font-weight:800;letter-spacing:2px;color:var(--t3);margin-bottom:8px" id="frame-cheki-lbl">üì∑ „ÉÅ„Çß„Ç≠È¢®„Éï„É¨„Éº„É†</div>
            <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:6px" id="frame-cheki-grid">
              <div class="frame-card on" data-frame="cheki-white" onclick="pickFrame(this)">
                <div class="frame-preview" style="border:3px solid #fff;background:#f5f5f5;padding:10px 10px 20px"><div style="background:#ccc;width:100%;aspect-ratio:1;border-radius:1px"></div></div>
                <div class="frame-nm" id="fn-cheki-white">„Éõ„ÉØ„Ç§„Éà</div>
              </div>
              <div class="frame-card" data-frame="cheki-black" onclick="pickFrame(this)">
                <div class="frame-preview" style="border:3px solid #333;background:#1a1a1a;padding:10px 10px 20px"><div style="background:#555;width:100%;aspect-ratio:1;border-radius:1px"></div></div>
                <div class="frame-nm" id="fn-cheki-black">„Éñ„É©„ÉÉ„ÇØ</div>
              </div>
              <div class="frame-card" data-frame="cheki-beige" onclick="pickFrame(this)">
                <div class="frame-preview" style="border:3px solid #d4b896;background:#e8d5b7;padding:10px 10px 20px"><div style="background:#c4a882;width:100%;aspect-ratio:1;border-radius:1px"></div></div>
                <div class="frame-nm" id="fn-cheki-beige">„Éô„Éº„Ç∏„É•</div>
              </div>
              <div class="frame-card" data-frame="cheki-pink" onclick="pickFrame(this)">
                <div class="frame-preview" style="border:3px solid #f4a0b0;background:#fce4ec;padding:10px 10px 20px"><div style="background:#f48fb1;width:100%;aspect-ratio:1;border-radius:1px"></div></div>
                <div class="frame-nm" id="fn-cheki-pink">„Éî„É≥„ÇØ</div>
              </div>
              <div class="frame-card" data-frame="cheki-navy" onclick="pickFrame(this)">
                <div class="frame-preview" style="border:3px solid #3a5a8a;background:#1a3a6a;padding:10px 10px 20px"><div style="background:#2a4a7a;width:100%;aspect-ratio:1;border-radius:1px"></div></div>
                <div class="frame-nm" id="fn-cheki-navy">„Éç„Ç§„Éì„Éº</div>
              </div>
              <div class="frame-card" data-frame="none" onclick="pickFrame(this)">
                <div class="frame-preview" style="border:2px dashed var(--b2);background:var(--s1);display:flex;align-items:center;justify-content:center;aspect-ratio:1"><span style="font-size:9px;color:var(--t3)">„Å™„Åó</span></div>
                <div class="frame-nm" id="fn-none">„Å™„Åó</div>
              </div>
            </div>
          </div>
          <!-- Custom frame color -->
          <div style="margin-bottom:12px;background:var(--s1);border:1.5px solid var(--b1);border-radius:var(--r);padding:12px">
            <div style="font-size:8px;font-weight:700;letter-spacing:1.5px;color:var(--t3);margin-bottom:9px" id="frame-custom-lbl">„Ç´„Çπ„Çø„É†„Ç´„É©„Éº</div>
            <div style="display:flex;gap:10px;align-items:center;margin-bottom:9px">
              <input type="color" id="frame-color" value="#ffffff" oninput="updateFrameColor()" style="width:40px;height:28px;border:1.5px solid var(--b2);background:none;border-radius:var(--rs);cursor:pointer;flex-shrink:0"/>
              <div style="flex:1">
                <div style="font-size:9px;font-weight:700;color:var(--t2)" id="frame-color-lbl">„Éï„É¨„Éº„É†„Ç´„É©„Éº</div>
              </div>
            </div>
            <!-- Frame thickness -->
            <div style="font-size:9px;font-weight:700;color:var(--t2);margin-bottom:6px">„Éï„É¨„Éº„É†ÂπÖ <span id="frame-thick-val">60</span>px</div>
            <div class="sl-track-hit" id="frame-thick-hit" style="height:28px;touch-action:none;cursor:ew-resize;position:relative;display:flex;align-items:center">
              <div class="sl-track-bg" style="height:3px;background:var(--s3);border-radius:2px;position:absolute;left:0;right:0">
                <div class="sl-fill" id="frame-thick-fill" style="position:absolute;top:0;height:3px;background:var(--red);border-radius:2px;left:0;width:30%"></div>
                <div class="sl-thumb" id="frame-thick-thumb" style="position:absolute;width:16px;height:16px;background:var(--bg);border:2.5px solid var(--red);border-radius:50%;top:50%;transform:translate(-50%,-50%);left:30%"></div>
              </div>
            </div>
            <!-- Caption toggle -->
            <div style="display:flex;align-items:center;gap:8px;margin-top:10px">
              <label style="display:flex;align-items:center;gap:6px;cursor:pointer">
                <input type="checkbox" id="frame-caption-on" oninput="updateFrameCaption()" style="accent-color:var(--red)"/>
                <span style="font-size:10px;font-weight:700;color:var(--t2)" id="frame-caption-lbl">„Ç≠„É£„Éó„Ç∑„Éß„É≥„ÇíËøΩÂä†</span>
              </label>
            </div>
            <input type="text" id="frame-caption-text" placeholder="‰æãÔºö2025 Summer" oninput="updateFrameCaption()" style="margin-top:8px;display:none;background:var(--s2);border:1.5px solid var(--b2);color:var(--t1);padding:7px 10px;font-size:11px;font-weight:600;font-family:inherit;width:100%;outline:none;border-radius:var(--rs)"/>
          </div>
          <!-- Corner style -->
          <div style="font-size:8px;font-weight:800;letter-spacing:2px;color:var(--t3);margin-bottom:8px" id="frame-corner-lbl">Ëßí„ÅÆÂΩ¢</div>
          <div style="display:flex;gap:6px;margin-bottom:12px">
            <button class="seg-b on" id="corner-sharp" onclick="setFrameCorner('sharp')" id="frame-corner-sharp">Áõ¥Ëßí</button>
            <button class="seg-b" id="corner-round" onclick="setFrameCorner('round')">Ëßí‰∏∏</button>
            <button class="seg-b" id="corner-oval" onclick="setFrameCorner('oval')">Ê•ïÂÜÜ</button>
          </div>
          <button class="ghost-btn" style="width:100%" id="frame-apply-btn" onclick="applyFrame()">„Éï„É¨„Éº„É†„ÇíÈÅ©Áî®„Åó„Å¶„Éó„É¨„Éì„É•„Éº</button>
        </div>


        <div class="panel" id="panel-draw">
          <div class="pnl-ttl" id="pt-draw" style="margin-bottom:11px">ÊèèÁîª</div>
          <!-- Tool buttons (keep existing SVG icon style) -->
          <div style="display:flex;flex-wrap:wrap;gap:5px;margin-bottom:11px" id="draw-tools">
            <button class="drw-b on" id="dt-pen" onclick="setDTool('pen')">
              <svg width="12" height="12" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M2 13l3-1 7-7-2-2-7 7-1 3z"/></svg>
            </button>
            <button class="drw-b" id="dt-brush" onclick="setDTool('brush')">
              <svg width="12" height="12" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M3 13c2-2 4-5 9-9M12 4l1-1 1 1-1 1z"/><path d="M3 13c0 0-1 1-1.5.5"/></svg>
            </button>
            <button class="drw-b" id="dt-eraser" onclick="setDTool('eraser')">
              <svg width="12" height="12" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M3 13l3-4 4-4-3-2-4 4-1 4z"/><line x1="8" y1="13" x2="14" y2="13"/></svg>
            </button>
            <button class="drw-b" id="dt-line" onclick="setDTool('line')">
              <svg width="12" height="12" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><line x1="2" y1="14" x2="14" y2="2"/></svg>
            </button>
            <button class="drw-b" id="dt-rect" onclick="setDTool('rect')">
              <svg width="12" height="12" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="2" y="4" width="12" height="8" rx="1"/></svg>
            </button>
            <button class="drw-b" id="dt-ellipse" onclick="setDTool('ellipse')">
              <svg width="12" height="12" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><ellipse cx="8" cy="8" rx="6" ry="4"/></svg>
            </button>
            <button class="drw-b" id="dt-arrow" onclick="setDTool('arrow')">
              <svg width="12" height="12" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><line x1="2" y1="14" x2="13" y2="3"/><path d="M13 3l-5 1 4 4z"/></svg>
            </button>
            <button class="drw-b" id="dt-text" onclick="setDTool('text')">
              <svg width="12" height="12" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="0"><text x="3" y="13" font-size="13" font-weight="700" fill="currentColor">T</text></svg>
            </button>
          </div>
          <!-- Color + options -->
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:10px">
            <div>
              <div style="font-size:8.5px;font-weight:700;color:var(--t3);margin-bottom:4px" id="draw-stroke-lbl">Á∑ö„ÅÆËâ≤</div>
              <input type="color" id="draw-color" value="#e03030" style="width:100%;height:30px;border:1.5px solid var(--b2);background:none;border-radius:var(--rs);cursor:pointer"/>
            </div>
            <div>
              <div style="font-size:8.5px;font-weight:700;color:var(--t3);margin-bottom:4px" id="draw-fill-lbl">Â°ó„ÇäËâ≤</div>
              <input type="color" id="draw-fill-color" value="#ffffff" style="width:100%;height:30px;border:1.5px solid var(--b2);background:none;border-radius:var(--rs);cursor:pointer"/>
            </div>
          </div>
          <!-- Use fill checkbox -->
          <label style="display:flex;align-items:center;gap:7px;cursor:pointer;margin-bottom:10px">
            <input type="checkbox" id="draw-use-fill" style="accent-color:var(--red)"/>
            <span style="font-size:10px;font-weight:700;color:var(--t2)" id="draw-use-fill-lbl">Â°ó„Çä„Å§„Å∂„ÅóÊúâÂäπ</span>
          </label>
          <!-- Size slider -->
          <div style="display:flex;justify-content:space-between;margin-bottom:5px">
            <span style="font-size:10px;font-weight:700;color:var(--t2)" id="draw-size-lbl">„Éñ„É©„Ç∑„Çµ„Ç§„Ç∫</span>
            <span style="font-size:11px;font-weight:800;color:var(--t3)" id="draw-size-val">8</span>
          </div>
          <div class="sl-track-hit" id="draw-sz-hit" style="height:28px;touch-action:none;cursor:ew-resize;position:relative;display:flex;align-items:center;margin-bottom:10px">
            <div class="sl-track-bg" style="height:3px;background:var(--s3);border-radius:2px;position:absolute;left:0;right:0">
              <div class="sl-fill" id="draw-sz-fill" style="position:absolute;top:0;height:3px;background:var(--red);border-radius:2px;left:0;width:7%"></div>
              <div class="sl-thumb" id="draw-sz-thumb" style="position:absolute;width:16px;height:16px;background:var(--bg);border:2.5px solid var(--red);border-radius:50%;top:50%;transform:translate(-50%,-50%);left:7%"></div>
            </div>
          </div>
          <!-- Opacity slider -->
          <div style="display:flex;justify-content:space-between;margin-bottom:5px">
            <span style="font-size:10px;font-weight:700;color:var(--t2)" id="draw-op-lbl">‰∏çÈÄèÊòéÂ∫¶</span>
            <span style="font-size:11px;font-weight:800;color:var(--t3)" id="draw-op-val">100%</span>
          </div>
          <div class="sl-track-hit" id="draw-op-hit" style="height:28px;touch-action:none;cursor:ew-resize;position:relative;display:flex;align-items:center;margin-bottom:12px">
            <div class="sl-track-bg" style="height:3px;background:var(--s3);border-radius:2px;position:absolute;left:0;right:0">
              <div class="sl-fill" id="draw-op-fill" style="position:absolute;top:0;height:3px;background:var(--red);border-radius:2px;left:0;width:100%"></div>
              <div class="sl-thumb" id="draw-op-thumb" style="position:absolute;width:16px;height:16px;background:var(--bg);border:2.5px solid var(--red);border-radius:50%;top:50%;transform:translate(-50%,-50%);left:100%"></div>
            </div>
          </div>
          <div style="display:flex;gap:6px">
            <button class="ghost-btn" style="flex:1;font-size:10px" onclick="drawUndo()" id="draw-undo-btn">‚Ü© ÂÖÉ„Å´Êàª„Åô</button>
            <button class="ghost-btn" style="flex:1;font-size:10px" onclick="drawClear()" id="draw-clear-btn">‚úï „ÇØ„É™„Ç¢</button>
          </div>
          <div style="margin-top:8px;font-size:8.5px;font-weight:700;color:var(--t3);letter-spacing:.5px" id="draw-hint">ÊèèÁîª„Çø„Éñ„ÇíÈñã„ÅÑ„ÅüÁä∂ÊÖã„Åß„Éó„É¨„Éì„É•„Éº‰∏ä„ÅßÊèè„Åë„Åæ„Åô</div>
        </div>

        <div class="panel" id="panel-info">
          <div class="pnl-ttl" style="margin-bottom:11px" id="pt-info">ÁîªÂÉèÊÉÖÂ†±</div>
          <div id="info-body">
            <div class="empty"><div class="e-ring"><div class="e-dot"></div></div><div class="e-ttl" id="noimg-lbl">ÁîªÂÉè„Å™„Åó</div><div class="e-sub" id="noimg-sub">ÁîªÂÉè„ÇíÈñã„Åè„Å®ÊÉÖÂ†±„ÅåË°®Á§∫„Åï„Çå„Åæ„Åô</div></div>
          </div>
        </div>

      </div>
    </div>

    <div id="bot">
      <button class="rst" id="bot-rst" onclick="resetAdj()">„É™„Çª„ÉÉ„Éà</button>
      <button class="exp-b" id="bot-exp" onclick="openExport()">Êõ∏„ÅçÂá∫„Åô</button>
    </div>
  </div>
</div>

<!-- EXPORT MODAL -->
<div class="ovl" id="exp-modal">
  <div class="sheet">
    <div class="modal-ttl" id="exp-ttl">Êõ∏„ÅçÂá∫„ÅóË®≠ÂÆö</div>
    <div class="fmt-grid">
      <div class="fmt-opt on" onclick="pickFmt(this,'jpg')"><div class="fmt-nm">JPEG</div><div class="fmt-sub" id="fmt-jpg-sub">„Åä„Åô„Åô„ÇÅ„ÉªÈ´òÁîªË≥™</div></div>
      <div class="fmt-opt" onclick="pickFmt(this,'png')"><div class="fmt-nm">PNG</div><div class="fmt-sub" id="fmt-png-sub">„É≠„Çπ„É¨„Çπ</div></div>
      <div class="fmt-opt" onclick="pickFmt(this,'webp')"><div class="fmt-nm">WEBP</div><div class="fmt-sub" id="fmt-webp-sub">„Éï„Ç°„Ç§„É´„ÅåÂ∞è„Åï„ÅÑ</div></div>
      <div class="fmt-opt" onclick="pickFmt(this,'transparent')"><div class="fmt-nm" id="fmt-transp-nm">PNGÈÄèÈÅé</div><div class="fmt-sub" id="fmt-transp-sub">ËÉåÊôØÈÄèÈÅé</div></div>
    </div>
    <div class="modal-btns">
      <button class="ghost" id="exp-cancel" style="flex:1" onclick="closeExport()">„Ç≠„É£„É≥„Çª„É´</button>
      <button class="solid" id="exp-dl" style="flex:2" onclick="doExport()">„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ</button>
    </div>
  </div>
</div>

<!-- CONFIRM DIALOG -->
<div id="confirm">
  <div class="confirm-box">
    <div class="confirm-ico">‚ö†Ô∏è</div>
    <div class="confirm-ttl" id="conf-ttl">Á∑®ÈõÜÂÜÖÂÆπ„ÅåÊ∂à„Åà„Åæ„Åô</div>
    <div class="confirm-sub" id="conf-sub">Êú™‰øùÂ≠ò„ÅÆÁ∑®ÈõÜ„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇ<br>„Éõ„Éº„É†„Å´Êàª„Çä„Åæ„Åô„ÅãÔºü</div>
    <div class="confirm-btns">
      <button class="c-no" id="conf-no" onclick="closeConfirm()">„Ç≠„É£„É≥„Çª„É´</button>
      <button class="c-ok" id="conf-ok" onclick="confirmGoHome()">Êàª„Çã</button>
    </div>
  </div>
</div>

<!-- SETTINGS MODAL -->
<div class="ovl" id="stg-modal">
  <div class="sheet">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px">
      <div class="modal-ttl" id="stg-ttl" style="margin-bottom:0">Ë®≠ÂÆö</div>
      <button class="ghost" style="padding:3px 9px;font-size:10px" onclick="closeSettings()">‚úï</button>
    </div>
    <div class="s-sec">üñ•Ô∏è Ë°®Á§∫</div>
    <div class="s-row">
      <div><div class="s-lbl" id="stg-fs-lbl">ÊñáÂ≠ó„ÅÆÂ§ß„Åç„Åï</div><div class="s-sub" id="stg-fs-sub">UI„ÉÜ„Ç≠„Çπ„Éà„ÅÆ„Çµ„Ç§„Ç∫</div></div>
      <div class="seg">
        <button class="seg-b" id="fs-s" onclick="setFontSize('small')">S</button>
        <button class="seg-b on" id="fs-m" onclick="setFontSize('medium')">M</button>
        <button class="seg-b" id="fs-l" onclick="setFontSize('large')">L</button>
        <button class="seg-b" id="fs-xl" onclick="setFontSize('xlarge')" style="white-space:nowrap">XL</button>
      </div>
    </div>
    <div class="s-row">
      <div><div class="s-lbl" id="stg-hist-lbl">„Éí„Çπ„Éà„Ç∞„É©„É†Â∏∏ÊôÇË°®Á§∫</div><div class="s-sub" id="stg-hist-sub">„Éó„É¨„Éì„É•„Éº‰∏ãÈÉ®„Å´Èáç„Å≠„Å¶Ë°®Á§∫</div></div>
      <label class="s-tog"><input type="checkbox" id="tog-hist" onchange="toggleHistOv(this.checked)"/><span class="s-tog-sl"></span></label>
    </div>
    <div class="s-row">
      <div><div class="s-lbl" id="stg-zoom-lbl">„Ç∫„Éº„É†ÂÄçÁéáË°®Á§∫</div><div class="s-sub" id="stg-zoom-sub">„Éó„É¨„Éì„É•„Éº„Å´„Ç∫„Éº„É†%„ÇíË°®Á§∫</div></div>
      <label class="s-tog"><input type="checkbox" id="tog-zoom" checked onchange="toggleZoom(this.checked)"/><span class="s-tog-sl"></span></label>
    </div>
    <div class="s-sec">‚ö° „Éë„Éï„Ç©„Éº„Éû„É≥„Çπ</div>
    <div class="s-row">
      <div><div class="s-lbl">„Éó„É¨„Éì„É•„ÉºÁîªË≥™</div><div class="s-sub">‰Ωé„Çπ„Éö„ÉÉ„ÇØ„Å™„Çâ„Äå‰ΩéÁîªË≥™„Äç„ÅßÂø´ÈÅ©„Å´</div></div>
      <div class="seg">
        <button class="seg-b on" id="pq-high" onclick="setPreviewQuality('high')">È´ò</button>
        <button class="seg-b" id="pq-mid" onclick="setPreviewQuality('mid')">‰∏≠</button>
        <button class="seg-b" id="pq-low" onclick="setPreviewQuality('low')">‰Ωé</button>
      </div>
    </div>
    <div class="s-sec">‚öôÔ∏è „Ç®„Éá„Ç£„Çø</div>
    <div class="s-row">
      <div><div class="s-lbl" id="stg-dm-lbl">„Éá„Éï„Ç©„É´„Éà„É¢„Éº„Éâ</div><div class="s-sub" id="stg-dm-sub">Ëµ∑ÂãïÊôÇ„ÅÆ„É¢„Éº„Éâ</div></div>
      <div class="seg">
        <button class="seg-b" id="dm-easy" onclick="setDefaultMode('easy')">„Åã„Çì„Åü„Çì</button>
        <button class="seg-b on" id="dm-pro" onclick="setDefaultMode('pro')">PRO</button>
      </div>
    </div>
    <div class="s-row">
      <div><div class="s-lbl" id="stg-save-lbl">Ë®≠ÂÆö„Çí‰øùÂ≠ò</div><div class="s-sub" id="stg-save-sub">„É™„É≠„Éº„ÉâÂæå„ÇÇÁ∂≠ÊåÅ</div></div>
      <label class="s-tog"><input type="checkbox" id="tog-save" checked onchange="toggleSaveStg(this.checked)"/><span class="s-tog-sl"></span></label>
    </div>
    <div class="s-sec">üé® „Ç∞„É©„Éï„Ç£„ÉÉ„ÇØË®≠ÂÆö</div>
    <div class="s-row">
      <div><div class="s-lbl">„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ÂìÅË≥™</div><div class="s-sub">„Éà„É©„É≥„Ç∏„Ç∑„Éß„É≥„Éª„Ç®„Éï„Çß„ÇØ„Éà„ÅÆÂìÅË≥™</div></div>
      <div class="seg">
        <button class="seg-b on" id="anim-high" onclick="setAnimQuality('high')">È´òÂìÅË≥™</button>
        <button class="seg-b" id="anim-low" onclick="setAnimQuality('low')">ÁúÅÈõªÂäõ</button>
      </div>
    </div>
    <div class="s-row">
      <div><div class="s-lbl">„Ç®„Éï„Çß„ÇØ„Éà</div><div class="s-sub">„Ç∞„É©„Çπ„É¢„Éº„Éï„Ç£„Ç∫„É†„Éª„Éñ„É©„ÉºÂäπÊûú</div></div>
      <label class="s-tog"><input type="checkbox" id="tog-fx" checked onchange="toggleFX(this.checked)"/><span class="s-tog-sl"></span></label>
    </div>
    <div class="s-row">
      <div><div class="s-lbl">„É™„Ç¢„É´„Çø„Ç§„É†Êõ¥Êñ∞</div><div class="s-sub">„Çπ„É©„Ç§„ÉÄ„ÉºÊìç‰Ωú‰∏≠„Å´Âç≥ÂèçÊò†ÔºàÈáç„ÅÑÂ†¥ÂêàOFFÔºâ</div></div>
      <label class="s-tog"><input type="checkbox" id="tog-realtime" checked onchange="toggleRealtime(this.checked)"/><span class="s-tog-sl"></span></label>
    </div>
    <div class="s-row">
      <div><div class="s-lbl">„Ç´„Éº„ÇΩ„É´„Ç®„Éï„Çß„ÇØ„Éà</div><div class="s-sub">„Éó„É¨„Éì„É•„Éº‰∏ä„ÅÆ„Ç´„Éº„ÇΩ„É´ÊºîÂá∫</div></div>
      <label class="s-tog"><input type="checkbox" id="tog-cursor" onchange="toggleCursorFX(this.checked)"/><span class="s-tog-sl"></span></label>
    </div>
  </div>
</div>

<!-- HELP MODAL -->
<div class="ovl" id="help-modal">
  <div class="sheet">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:18px">
      <div class="modal-ttl" id="help-ttl" style="margin-bottom:0">‰Ωø„ÅÑÊñπ„Ç¨„Ç§„Éâ</div>
      <button class="ghost" style="padding:3px 9px;font-size:10px" onclick="closeHelp()">‚úï</button>
    </div>
    <div id="help-content"></div>
  </div>
</div>

<canvas id="offscreen" style="display:none"></canvas>

<script>
(()=>{
'use strict';
/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   HELPERS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const $=id=>{
  const e=document.getElementById(id);
  if(e)return e;
  // Return a no-op proxy so .textContent= .style.x= .classList.x() never throws
  const handler={
    get(t,p){
      if(p==='classList')return{add:()=>{},remove:()=>{},toggle:()=>{},contains:()=>false};
      if(p==='style')return new Proxy({},{set:()=>true,get:()=>''});
      if(p==='checked'||p==='value')return '';
      if(typeof p==='symbol')return undefined;
      return ()=>{};
    },
    set:()=>true
  };
  return new Proxy({},handler);
};
function clamp(v){return v<0?0:v>255?255:v}
function pct(v,mn,mx){return((v-mn)/(mx-mn))*100}
function fmtV(v){return v>0?'+'+v:String(v)}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   i18n
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const TX={
  ja:{
    sub:'„Éï„Ç©„Éà„Ç®„Éá„Ç£„Çø„Éº',open:'Èñã„Åè',export:'Êõ∏„ÅçÂá∫„Åô',begin:'„Çø„ÉÉ„Éó„Åó„Å¶ÈñãÂßã',
    phTxt:'„Çø„ÉÉ„Éó„Åæ„Åü„ÅØ„Éâ„É≠„ÉÉ„Éó„Åó„Å¶\nÂÜôÁúü„ÇíÈñã„Åè',
    easy:'„Åã„Çì„Åü„Çì',pro:'PRO',lang:'EN',
    tabLabels:{efilter:'„Éï„Ç£„É´„Çø„Éº',eadj:'Ë™øÊï¥',tone:'„Éà„Éº„É≥',color:'„Ç´„É©„Éº',detail:'Ë©≥Á¥∞',xform:'Â§âÂΩ¢',cut:'„Ç´„ÉÉ„Éà',mosaic:'„É¢„Ç∂„Ç§„ÇØ',blur:'„Åº„Åã„Åó',size:'„Çµ„Ç§„Ç∫',preset:'„Éó„É™„Çª„ÉÉ„Éà',info:'ÊÉÖÂ†±'},
    rotL:'Â∑¶ÂõûËª¢',rotR:'Âè≥ÂõûËª¢',flipH:'Ê∞¥Âπ≥ÂèçËª¢',flipV:'ÂûÇÁõ¥ÂèçËª¢',
    filterStr:'„Éï„Ç£„É´„Çø„Éº„ÅÆÂº∑„Åï',
    filterCats:{fluffy:'‚ú® „Éï„ÉØ„Éï„ÉØ„Éª„Ç®„Ç¢„É™„Éº',white:'ü§ç „Éõ„ÉØ„Ç§„Éà„Éâ„É™„Éº„É†',pink:'üå∏ „Éî„É≥„ÇØÁ≥ª',cold:'üßä Èùí„ÉªÂÜ∑„Åü„ÅÑÁ≥ª',warm:'üî• Ê∏©„Åã„ÅÑÁ≥ª',cheki:'üì∑ „ÉÅ„Çß„Ç≠„Éª„Éï„Ç£„É´„É†',natural:'üåø „Éä„ÉÅ„É•„É©„É´',mono:'üñ§ „É¢„Éé„ÇØ„É≠„Éª„Ç¢„Éº„Éà'},
    easyLbls:{brightness:'Êòé„Çã„Åï',contrast:'„Ç≥„É≥„Éà„É©„Çπ„Éà',saturation:'Ëâ≤„ÅÆÈÆÆ„ÇÑ„Åã„Åï',temperature:'Ëâ≤Ê∏©Â∫¶',fade:'„Åµ„Çì„Çè„ÇäÊÑü',sharpness:'„Ç∑„É£„Éº„Éó',vignette:'Âë®Ëæ∫Êöó„ÇÅ',grain:'„Éï„Ç£„É´„É†ÊÑü'},
    easyDesc:{brightness:'ÂÜôÁúü„ÇíÊòé„Çã„Åè„ÉªÊöó„Åè„Åó„Åæ„Åô',contrast:'„É°„É™„Éè„É™„Çí„Å§„Åë„Åæ„Åô',saturation:'Ëâ≤„ÇíÈÆÆ„ÇÑ„Åã„Å´',temperature:'Êöñ„Åã„ÅÑ„ÉªÂÜ∑„Åü„ÅÑÈõ∞Âõ≤Ê∞ó„Å´',fade:'„Åµ„Çè„Å£„Å®Ê∑°„ÅÑÂç∞Ë±°„Å´',sharpness:'Ëº™ÈÉ≠„Çí„Åè„Å£„Åç„Çä',vignette:'Âë®Âõ≤„ÇíÊöó„Åè„Åó„Å¶‰∏≠ÂøÉ„ÇíÁõÆÁ´ã„Åü„Åõ„Åæ„Åô',grain:'„Éï„Ç£„É´„É†ÂÜôÁúü„ÅÆ„Çà„ÅÜ„Å™Ë≥™ÊÑü„Å´'},
    sl:{brightness:'Êòé„Çã„Åï',contrast:'„Ç≥„É≥„Éà„É©„Çπ„Éà',exposure:'Èú≤Âá∫',highlights:'„Éè„Ç§„É©„Ç§„Éà',shadows:'„Ç∑„É£„Éâ„Ç¶',blacks:'Èªí„É¨„Éô„É´',whites:'ÁôΩ„É¨„Éô„É´',saturation:'ÂΩ©Â∫¶',vibrance:'Ëá™ÁÑ∂„Å™ÂΩ©Â∫¶',hue:'Ëâ≤Áõ∏„Ç∑„Éï„Éà',temperature:'Ëâ≤Ê∏©Â∫¶',tint:'„ÉÜ„Ç£„É≥„Éà',sharpness:'„Ç∑„É£„Éº„Éó',blur:'„Åº„Åã„Åó',clarity:'ÊòéÁû≠Â∫¶',texture:'„ÉÜ„ÇØ„Çπ„ÉÅ„É£„Éº',vignette:'Âë®Ëæ∫Ê∏õÂÖâ',lens:'Âë®Ëæ∫ÂÖâÈáèË£úÊ≠£',chrAb:'Ëâ≤ÂèéÂ∑Æ',noise:'„Éé„Ç§„Ç∫(ËºùÂ∫¶)',noiseC:'„Éé„Ç§„Ç∫(Ëâ≤)',grain:'„Éï„Ç£„É´„É†„Ç∞„É¨„Ç§„É≥',grainSize:'„Ç∞„É¨„Ç§„É≥„Çµ„Ç§„Ç∫',grainRough:'„Ç∞„É¨„Ç§„É≥Á≤ó„Åï',fade:'„Éï„Çß„Éº„Éâ',distortion:'Ê≠™„ÅøË£úÊ≠£',angle:'ÂæÆË™øÊï¥ËßíÂ∫¶',midtone:'„Éü„ÉÉ„Éâ„Éà„Éº„É≥',shadowTint:'„Ç∑„É£„Éâ„Ç¶„ÉÜ„Ç£„É≥„Éà',highlightTint:'„Éè„Ç§„É©„Ç§„Éà„ÉÜ„Ç£„É≥„Éà',splitHigh:'„Éè„Ç§„É©„Ç§„ÉàÂàÜÂâ≤',splitLow:'„Ç∑„É£„Éâ„Ç¶ÂàÜÂâ≤',sharpRadius:'„Ç∑„É£„Éº„ÉóÂçäÂæÑ',sharpDetail:'„Ç®„ÉÉ„Ç∏„ÅÆ„Åø',vignetteFeather:'„Éï„Çß„Ç∂„É™„É≥„Ç∞',vignetteMid:'‰∏≠ÈñìÁÇπ',noiseDetail:'„Éé„Ç§„Ç∫Ë©≥Á¥∞',grainSize:'„Ç∞„É¨„Ç§„É≥„Çµ„Ç§„Ç∫',horizWarp:'Ê∞¥Âπ≥„ÇÜ„Åå„Åø',vertWarp:'ÂûÇÁõ¥„ÇÜ„Åå„Åø',scaleH:'Ê∞¥Âπ≥„Çπ„Ç±„Éº„É´',scaleV:'ÂûÇÁõ¥„Çπ„Ç±„Éº„É´',perspH:'Ê∞¥Âπ≥Ë£úÊ≠£',perspV:'ÂûÇÁõ¥Ë£úÊ≠£',rr:'Ëµ§‚ÜíËµ§',rg:'Ëµ§‚ÜíÁ∑ë',rb:'Ëµ§‚ÜíÈùí',gr:'Á∑ë‚ÜíËµ§',gg:'Á∑ë‚ÜíÁ∑ë',gb:'Á∑ë‚ÜíÈùí',br:'Èùí‚ÜíËµ§',bg2:'Èùí‚ÜíÁ∑ë',bb:'Èùí‚ÜíÈùí',rawExp:'RAWÈú≤Âá∫',rawWB:'RAWËâ≤Ê∏©Â∫¶',rawTint:'RAW„ÉÜ„Ç£„É≥„Éà',rawSat:'RAWÂΩ©Â∫¶',blurRadius:'„Åº„Åã„ÅóÂº∑Â∫¶',warmShadows:'„Ç∑„É£„Éâ„Ç¶„Ç¶„Ç©„Éº„É†',coolHighlights:'„Éè„Ç§„É©„Ç§„Éà„ÇØ„Éº„É´',dehaze:'„Åã„Åô„ÅøÈô§Âéª',texture:'„ÉÜ„ÇØ„Çπ„ÉÅ„É£„Éº',grainRough:'„Ç∞„É¨„Ç§„É≥Á≤ó„Åï'},
    infoKeys:{file:'„Éï„Ç°„Ç§„É´Âêç',size:'„Çµ„Ç§„Ç∫',type:'ÂΩ¢Âºè',w:'ÂÖÉ„ÅÆÂπÖ',h:'ÂÖÉ„ÅÆÈ´ò„Åï',mp:'MP',ar:'„Ç¢„Çπ„Éö„ÇØ„ÉàÊØî',outW:'Âá∫ÂäõÂπÖ',outH:'Âá∫ÂäõÈ´ò„Åï'},
    techTitle:'„ÉÜ„ÇØ„Éã„Ç´„É´Ë©≥Á¥∞',adjTitle:'ÈÅ©Áî®‰∏≠„ÅÆË™øÊï¥',noneAdj:'„Å™„Åó',
    reset:'„É™„Çª„ÉÉ„Éà',save:'‰øùÂ≠ò',cancel:'„Ç≠„É£„É≥„Çª„É´',download:'„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ',apply:'ÈÅ©Áî®',del:'‚úï',
    builtin:'„Éá„Éï„Ç©„É´„Éà„Éï„Ç£„É´„Çø„Éº',myPresets:'„Éû„Ç§„Éó„É™„Çª„ÉÉ„Éà',noPresets:'„Éó„É™„Çª„ÉÉ„Éà„Å™„Åó',noPresetsSub:'Ë™øÊï¥„Åó„Å¶‰øùÂ≠ò„Åó„Åæ„Åó„Çá„ÅÜ',
    mosaicDesc:'„É¢„Ç∂„Ç§„ÇØ„ÅÆ„Çµ„Ç§„Ç∫„ÇíÈÅ∏Êäû',clearMosaic:'„É¢„Ç∂„Ç§„ÇØ„ÇíÊ∂à„Åô',
    expTitle:'Êõ∏„ÅçÂá∫„ÅóË®≠ÂÆö',
    confirmTitle:'Á∑®ÈõÜÂÜÖÂÆπ„ÅåÊ∂à„Åà„Åæ„Åô',confirmSub:'Êú™‰øùÂ≠ò„ÅÆÁ∑®ÈõÜ„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇ\n„Éõ„Éº„É†„Å´Êàª„Çä„Åæ„Åô„ÅãÔºü',confirmOk:'Êàª„Çã',
    settings:'Ë®≠ÂÆö',
    helpTitle:'‰Ωø„ÅÑÊñπ„Ç¨„Ç§„Éâ',help:'‚ùì „Éò„É´„Éó / ‰Ωø„ÅÑÊñπ',
    helpSteps:[
      {n:1,t:'ÂÜôÁúü„ÇíÈñã„Åè',d:'„ÄåÈñã„Åè„Äç„Éú„Çø„É≥„Çí„Çø„ÉÉ„Éó„Åô„Çã„Åã„ÄÅÂÜôÁúü„Çí„Éâ„É©„ÉÉ„Ç∞&„Éâ„É≠„ÉÉ„Éó„ÄÇJPEG„ÉªPNG„ÉªRAW„ÉªHEIC„Å™„Å©ÂØæÂøú„ÄÇ'},
      {n:2,t:'„Éï„Ç£„É´„Çø„Éº„ÇíÈÅ∏„Å∂',d:'„Éï„Ç£„É´„Çø„Éº„Çø„Éñ„Åã„Çâ„Éï„Ç£„É´„Çø„Éº„ÇíÈÅ∏Êäû„ÄÇ„ÉÅ„Çß„Ç≠„Éª„Éõ„ÉØ„Ç§„Éà„Éâ„É™„Éº„É†„Å™„Å©Ë±äÂØå„Å™„Çπ„Çø„Ç§„É´„ÄÇ'},
      {n:3,t:'Êòé„Çã„Åï„ÉªËâ≤„ÇíË™øÊï¥',d:'Ë™øÊï¥„Çø„Éñ„Åß„Çπ„É©„Ç§„ÉÄ„Éº„ÇíÂãï„Åã„Åó„Å¶Êòé„Çã„Åï„Éª„Ç≥„É≥„Éà„É©„Çπ„Éà„ÉªÂΩ©Â∫¶„ÇíË™øÊï¥„ÄÇ'},
      {n:4,t:'PROÊ©üËÉΩ„Çí‰Ωø„ÅÜ',d:'PRO„É¢„Éº„Éâ„Åß„ÅØ„Éà„Éº„É≥„Ç´„Éº„Éñ„ÉªHSL„Éü„Ç≠„Çµ„Éº„ÉªÂ§âÂΩ¢„ÉªÁØÑÂõ≤„Åº„Åã„Åó„Å™„Å©È´òÂ∫¶„Å™Ë™øÊï¥„ÅåÂèØËÉΩ„ÄÇ'},
      {n:5,t:'‰øùÂ≠ò„Åô„Çã',d:'„ÄåÊõ∏„ÅçÂá∫„Åô„Äç„Éú„Çø„É≥„ÇíÊäº„Åó„Å¶„Éï„Ç©„Éº„Éû„ÉÉ„Éà„ÇíÈÅ∏Êäû„Åô„Çã„Å®„Åô„Åê„ÉÄ„Ç¶„É≥„É≠„Éº„ÉâÈñãÂßã„ÄÇ'},
    ],
    blurDesc:'„Éó„É¨„Éì„É•„Éº‰∏ä„Åß„Éâ„É©„ÉÉ„Ç∞„Åó„Å¶ÁØÑÂõ≤„ÇíÈÅ∏Êäû„Åó„ÄÅ„Åº„Åã„Åó„ÇíÈÅ©Áî®„Åó„Åæ„Åô„ÄÇ',
    blurStart:'üéØ ÁØÑÂõ≤ÈÅ∏Êäû„ÇíÈñãÂßã',blurClear:'„Åº„Åã„Åó„ÇíÊ∂à„Åô',
    blurTipLbl:'‰Ωø„ÅÑÊñπ',blurTipTxt:'„ÄåÈñãÂßã„Äç„ÇíÊäº„Åó„Å¶ÂÜôÁúü„ÅÆ‰∏ä„Åß„Éâ„É©„ÉÉ„Ç∞„ÄÇÂÜÜÂΩ¢„ÅÆÁØÑÂõ≤„Åå„Åº„Åã„Åï„Çå„Åæ„Åô„ÄÇ„ÉÄ„Éñ„É´„Çø„ÉÉ„Éó„ÅßÁµÇ‰∫Ü„ÄÇ',
    blurHint:'„Éâ„É©„ÉÉ„Ç∞„Åó„Å¶ÁØÑÂõ≤„Çí„Åº„Åã„Åô ‚Äî „ÉÄ„Éñ„É´„Çø„ÉÉ„Éó„ÅßÁµÇ‰∫Ü',
    chekiTtl:'„ÉÅ„Çß„Ç≠È¢®„Å´‰ªï‰∏ä„Åí„Çã',chekiSub:'„Ç§„É≥„Çπ„Çø„É≥„Éà„Éï„Ç©„ÉàÈ¢®',
    chkSoft:'üå∏ „ÇΩ„Éï„Éà',chkWarm:'‚òÄÔ∏è „Ç¶„Ç©„Éº„É†',chkCool:'üßä „ÇØ„Éº„É´',
    fmtJpg:'„Åä„Åô„Åô„ÇÅ„ÉªÈ´òÁîªË≥™',fmtPng:'„É≠„Çπ„É¨„Çπ',fmtWebp:'„Éï„Ç°„Ç§„É´„ÅåÂ∞è„Åï„ÅÑ',fmtTranspNm:'PNGÈÄèÈÅé',fmtTranspSub:'ËÉåÊôØÈÄèÈÅé',
    rp:{SNS:'SNS',HD:'HD',Print:'Âç∞Âà∑',Square:'„Çπ„ÇØ„Ç®„Ç¢'},
  },
  en:{
    sub:'PHOTO EDITOR',open:'OPEN',export:'EXPORT',begin:'TAP TO BEGIN',
    phTxt:'Tap or drop\na photo',
    easy:'EASY',pro:'PRO',lang:'Êó•Êú¨Ë™û',
    tabLabels:{efilter:'FILTER',eadj:'ADJUST',tone:'TONE',color:'COLOR',detail:'DETAIL',xform:'TRANSFORM',cut:'CROP',mosaic:'MOSAIC',blur:'BLUR',size:'SIZE',preset:'PRESET',info:'INFO'},
    rotL:'Rotate L',rotR:'Rotate R',flipH:'Flip H',flipV:'Flip V',
    filterStr:'Filter Intensity',
    filterCats:{fluffy:'‚ú® Fluffy & Airy',white:'ü§ç White Dream',pink:'üå∏ Pink',cold:'üßä Cold & Blue',warm:'üî• Warm',cheki:'üì∑ Film & Leica',natural:'üåø Natural',mono:'üñ§ Mono & Art'},
    easyLbls:{brightness:'Brightness',contrast:'Contrast',saturation:'Saturation',temperature:'Warmth',fade:'Fade',sharpness:'Sharpness',vignette:'Vignette',grain:'Film Grain'},
    easyDesc:{brightness:'Brighter or darker',contrast:'Add punch',saturation:'Vivid or muted',temperature:'Warm or cool',fade:'Soft dreamy look',sharpness:'Crisper edges',vignette:'Darken edges',grain:'Film-like texture'},
    sl:{brightness:'Brightness',contrast:'Contrast',exposure:'Exposure',highlights:'Highlights',shadows:'Shadows',blacks:'Blacks',whites:'Whites',saturation:'Saturation',vibrance:'Vibrance',hue:'Hue Shift',temperature:'Temperature',tint:'Tint',sharpness:'Sharpness',blur:'Blur',clarity:'Clarity',texture:'Texture',vignette:'Vignette',lens:'Lens Correction',chrAb:'Chromatic Ab.',noise:'Noise(Luma)',noiseC:'Noise(Chroma)',grain:'Film Grain',grainSize:'Grain Size',grainRough:'Grain Rough',fade:'Fade',distortion:'Distortion',angle:'Fine Angle',midtone:'Midtone',shadowTint:'Shadow Tint',highlightTint:'Highlight Tint',splitHigh:'Split High',splitLow:'Split Low',sharpRadius:'Sharp Radius',sharpDetail:'Edge Only',vignetteFeather:'Feathering',vignetteMid:'Midpoint',noiseDetail:'Noise Detail',grainSize:'Grain Size',horizWarp:'Horiz Warp',vertWarp:'Vert Warp',scaleH:'Scale H',scaleV:'Scale V',perspH:'Perspective H',perspV:'Perspective V',rr:'Red‚ÜíRed',rg:'Red‚ÜíGreen',rb:'Red‚ÜíBlue',gr:'Green‚ÜíRed',gg:'Green‚ÜíGreen',gb:'Green‚ÜíBlue',br:'Blue‚ÜíRed',bg2:'Blue‚ÜíGreen',bb:'Blue‚ÜíBlue',rawExp:'RAW Exposure',rawWB:'RAW WB',rawTint:'RAW Tint',rawSat:'RAW Sat',blurRadius:'Blur Radius',warmShadows:'Warm Shadows',coolHighlights:'Cool Highlights',dehaze:'Dehaze',texture:'Texture',grainRough:'Grain Rough'},
    infoKeys:{file:'Filename',size:'Size',type:'Format',w:'Width',h:'Height',mp:'MP',ar:'Aspect Ratio',outW:'Out W',outH:'Out H'},
    techTitle:'Technical',adjTitle:'Active Adjustments',noneAdj:'NONE',
    reset:'RESET',save:'SAVE',cancel:'CANCEL',download:'DOWNLOAD',apply:'APPLY',del:'‚úï',
    builtin:'Default Filters',myPresets:'My Presets',noPresets:'No Presets',noPresetsSub:'Adjust and save a look',
    mosaicDesc:'Select mosaic size',clearMosaic:'Clear Mosaic',
    expTitle:'Export Settings',
    confirmTitle:'Unsaved Changes',confirmSub:'You have unsaved edits.\nGo back to home?',confirmOk:'Go Home',
    settings:'Settings',
    helpTitle:'How to Use',help:'‚ùì Help / How to Use',
    helpSteps:[
      {n:1,t:'Open a Photo',d:'Tap "OPEN" or drag & drop. Supports JPEG, PNG, HEIC, RAW and more.'},
      {n:2,t:'Choose a Filter',d:'Pick from the FILTER tab. Cheki, White Dream, Airy and many more styles.'},
      {n:3,t:'Adjust Brightness & Color',d:'Use sliders in the ADJUST tab for brightness, contrast, and saturation.'},
      {n:4,t:'Use PRO Features',d:'PRO mode offers tone curves, HSL mixer, transform, and region blur tools.'},
      {n:5,t:'Save Your Photo',d:'Press EXPORT and select a format to immediately download.'},
    ],
    blurDesc:'Drag on the preview to select a region and apply blur.',
    blurStart:'üéØ Start Selection',blurClear:'Clear Blur',
    blurTipLbl:'How to use',blurTipTxt:'Press "Start", then drag on the photo. A circular region will be blurred. Double-tap to finish.',
    blurHint:'Drag to blur a region ‚Äî Double-tap to finish',
    chekiTtl:'Cheki-style Finish',chekiSub:'Soft instant photo effect',
    chkSoft:'üå∏ Soft',chkWarm:'‚òÄÔ∏è Warm',chkCool:'üßä Cool',
    fmtJpg:'Recommended',fmtPng:'Lossless',fmtWebp:'Smaller file',fmtTranspNm:'PNG Transparent',fmtTranspSub:'Transparent BG',
    rp:{SNS:'SNS',HD:'HD',Print:'Print',Square:'Square'},
  }
};
let L='ja';
function T(key,...p){let o=TX[L];for(const k of[key,...p]){if(o==null)return key;o=o[k]}return o??TX.en?.[key]??key}

function applyLang(){
  $('lang-btn').textContent=T('lang');
  $('mb-easy').textContent=T('easy');
  $('mb-pro').textContent=T('pro');
  $('open-btn').textContent=T('open');
  $('exp-hbtn').textContent=T('export');
  $('hdr-sub').textContent=T('sub');
  $('sp-sub').textContent=T('sub');
  $('sp-cta').textContent=T('begin');
  $('ph-txt').textContent=T('phTxt');
  $('bot-rst').textContent=T('reset');
  $('bot-exp').textContent=T('export');
  $('conf-ttl').textContent=T('confirmTitle');
  $('conf-sub').textContent=T('confirmSub');
  $('conf-ok').textContent=T('confirmOk');
  $('conf-no').textContent=T('cancel');
  $('stg-ttl').textContent=T('settings');
  $('help-ttl').textContent=T('helpTitle');
  // Tabs
  const tl=T('tabLabels');
  Object.entries(tl).forEach(([k,v])=>{const e=$('tl-'+k);if(e)e.textContent=v});
  // Rotate
  $('rot-l').textContent=T('rotL');
  $('rot-r').textContent=T('rotR');
  $('flip-h').textContent=T('flipH');
  $('flip-v').textContent=T('flipV');
  // Panel titles
  $('pt-efilter').textContent=L==='ja'?'„Éï„Ç£„É´„Çø„Éº & „É´„ÉÉ„ÇØ':'Filter & Look';
  $('pt-eadj').textContent=L==='ja'?'„Åã„Çì„Åü„ÇìË™øÊï¥':'Easy Adjust';
  $('pt-tone').textContent=L==='ja'?'„Éà„Éº„É≥„ÉªÈú≤ÂÖâ':'Tone & Exposure';
  $('pt-color').textContent=L==='ja'?'„Ç´„É©„Éº„Ç∞„É¨„Éº„Éá„Ç£„É≥„Ç∞':'Color Grading';
  $('pt-detail').textContent=L==='ja'?'„Éá„Ç£„ÉÜ„Éº„É´„ÉªÂÖâÂ≠¶':'Detail & Optics';
  $('pt-xform').textContent=L==='ja'?'ÂõûËª¢„ÉªÂ§âÂΩ¢':'Transform';
  $('pt-cut').textContent=L==='ja'?'„Ç´„ÉÉ„Éà„Éª„Éï„É¨„Éº„É†':'Crop & Frame';
  $('pt-mosaic').textContent=L==='ja'?'„É¢„Ç∂„Ç§„ÇØ':'Mosaic';
  $('pt-blur').textContent=L==='ja'?'ÁØÑÂõ≤„Åº„Åã„Åó':'Region Blur';
  $('pt-size').textContent=L==='ja'?'Âá∫Âäõ„Çµ„Ç§„Ç∫':'Output Size';
  $('pt-preset').textContent=L==='ja'?'„Éó„É™„Çª„ÉÉ„Éà':'Presets';
  $('pt-info').textContent=L==='ja'?'ÁîªÂÉèÊÉÖÂ†±':'Image Info';
  {const e=document.getElementById('pt-frame');if(e)e.textContent=L==='ja'?'„Éï„É¨„Éº„É†':'Frame';}
  {const e=document.getElementById('tl-frame');if(e)e.textContent=L==='ja'?'„Éï„É¨„Éº„É†':'FRAME';}
  {const e=document.getElementById('pt-draw');if(e)e.textContent=L==='ja'?'ÊèèÁîª':'Draw';}
  {const e=document.getElementById('tl-draw');if(e)e.textContent=L==='ja'?'ÊèèÁîª':'DRAW';}
  {const e=document.getElementById('frame-cheki-lbl');if(e)e.textContent=L==='ja'?'üì∑ „ÉÅ„Çß„Ç≠È¢®„Éï„É¨„Éº„É†':'üì∑ Cheki Frame';}
  {const e=document.getElementById('frame-custom-lbl');if(e)e.textContent=L==='ja'?'„Ç´„Çπ„Çø„É†„Ç´„É©„Éº':'Custom Color';}
  {const e=document.getElementById('frame-color-lbl');if(e)e.textContent=L==='ja'?'„Éï„É¨„Éº„É†„Ç´„É©„Éº':'Frame Color';}
  {const e=document.getElementById('frame-corner-lbl');if(e)e.textContent=L==='ja'?'Ëßí„ÅÆÂΩ¢':'Corner Style';}
  {const e=document.getElementById('frame-caption-lbl');if(e)e.textContent=L==='ja'?'„Ç≠„É£„Éó„Ç∑„Éß„É≥„ÇíËøΩÂä†':'Add Caption';}
  {const e=document.getElementById('frame-apply-btn');if(e)e.textContent=L==='ja'?'„Éï„É¨„Éº„É†„ÇíÈÅ©Áî®„Åó„Å¶„Éó„É¨„Éì„É•„Éº':'Apply Frame to Preview';}
  {const e=document.getElementById('fn-cheki-white');if(e)e.textContent=L==='ja'?'„Éõ„ÉØ„Ç§„Éà':'White';}
  {const e=document.getElementById('fn-cheki-black');if(e)e.textContent=L==='ja'?'„Éñ„É©„ÉÉ„ÇØ':'Black';}
  {const e=document.getElementById('fn-cheki-beige');if(e)e.textContent=L==='ja'?'„Éô„Éº„Ç∏„É•':'Beige';}
  {const e=document.getElementById('fn-cheki-pink');if(e)e.textContent=L==='ja'?'„Éî„É≥„ÇØ':'Pink';}
  {const e=document.getElementById('fn-cheki-navy');if(e)e.textContent=L==='ja'?'„Éç„Ç§„Éì„Éº':'Navy';}
  {const e=document.getElementById('fn-none');if(e)e.textContent=L==='ja'?'„Å™„Åó':'None';}
  {const e=document.getElementById('draw-stroke-lbl');if(e)e.textContent=L==='ja'?'Á∑ö„ÅÆËâ≤':'Stroke';}
  {const e=document.getElementById('draw-fill-lbl');if(e)e.textContent=L==='ja'?'Â°ó„ÇäËâ≤':'Fill';}
  {const e=document.getElementById('draw-use-fill-lbl');if(e)e.textContent=L==='ja'?'Â°ó„Çä„Å§„Å∂„ÅóÊúâÂäπ':'Enable Fill';}
  {const e=document.getElementById('draw-size-lbl');if(e)e.textContent=L==='ja'?'„Éñ„É©„Ç∑„Çµ„Ç§„Ç∫':'Brush Size';}
  {const e=document.getElementById('draw-op-lbl');if(e)e.textContent=L==='ja'?'‰∏çÈÄèÊòéÂ∫¶':'Opacity';}
  {const e=document.getElementById('draw-undo-btn');if(e)e.textContent=L==='ja'?'‚Ü© ÂÖÉ„Å´Êàª„Åô':'‚Ü© Undo';}
  {const e=document.getElementById('draw-clear-btn');if(e)e.textContent=L==='ja'?'‚úï „ÇØ„É™„Ç¢':'‚úï Clear';}
  {const e=document.getElementById('draw-hint');if(e)e.textContent=L==='ja'?'ÊèèÁîª„Çø„Éñ„ÇíÈñã„ÅÑ„ÅüÁä∂ÊÖã„Åß„Éó„É¨„Éì„É•„Éº‰∏ä„ÅßÊèè„Åë„Åæ„Åô':'Open Draw tab to draw on preview';}
  $('rst-easy').textContent=T('reset');$('rst-tone').textContent=T('reset');
  $('ht-lbl').textContent=T('tabLabels','tone')||'Histogram';
  $('ht-lbl').textContent=L==='ja'?'„Éí„Çπ„Éà„Ç∞„É©„É†':'Histogram';
  $('cv-lbl').textContent=L==='ja'?'RGB„Ç´„Éº„Éñ':'RGB Curve';
  $('hsl-sec-lbl').textContent=L==='ja'?'HSL„Éü„Ç≠„Çµ„Éº':'HSL Mixer';
  $('cmix-lbl').textContent=L==='ja'?'„Ç´„É©„Éº„Éü„ÉÉ„ÇØ„Çπ':'Color Mix';
  $('cv-hint').textContent=L==='ja'?'„Éâ„É©„ÉÉ„Ç∞„ÅßÁßªÂãï ¬∑ „Çø„ÉÉ„Éó„ÅßËøΩÂä† ¬∑ „ÉÄ„Éñ„É´„Çø„ÉÉ„Éó„ÅßÂâäÈô§':'Drag to move ¬∑ Tap to add ¬∑ Dbl-tap to remove';
  $('mosaic-desc').textContent=T('mosaicDesc');
  $('clear-mos').textContent=T('clearMosaic');
  $('blur-desc').textContent=T('blurDesc');
  $('blur-start-btn').textContent=T('blurStart');
  $('blur-clear-btn').textContent=T('blurClear');
  $('blur-tip-lbl').textContent=T('blurTipLbl');
  $('blur-tip-txt').textContent=T('blurTipTxt');
  $('blur-hint').textContent=T('blurHint');
  $('sw-lbl').textContent=L==='ja'?'Ê®™ÂπÖ px':'Width px';
  $('sh-lbl').textContent=L==='ja'?'Á∏¶ÂπÖ px':'Height px';
  $('pi-open-btn').textContent=L==='ja'?'Ôºã ‰øùÂ≠ò':'Ôºã Save';
  $('pi-nm-lbl').textContent=L==='ja'?'„Éó„É™„Çª„ÉÉ„ÉàÂêç':'Preset Name';
  $('pi-save-btn').textContent=T('save');$('pi-cancel-btn').textContent=T('cancel');
  $('noimg-lbl').textContent=L==='ja'?'ÁîªÂÉè„Å™„Åó':'No Image';
  $('noimg-sub').textContent=L==='ja'?'ÁîªÂÉè„ÇíÈñã„Åè„Å®ÊÉÖÂ†±„ÅåË°®Á§∫„Åï„Çå„Åæ„Åô':'Open an image to see info';
  $('filt-str-lbl').textContent=T('filterStr');
  $('help-btn').textContent=T('help');
  $('cheki-ttl').textContent=T('chekiTtl');$('cheki-sub').textContent=T('chekiSub');
  $('chk-soft').textContent=T('chkSoft');$('chk-warm').textContent=T('chkWarm');$('chk-cool').textContent=T('chkCool');
  $('exp-ttl').textContent=T('expTitle');
  $('exp-cancel').textContent=T('cancel');$('exp-dl').textContent=T('download');
  $('fmt-jpg-sub').textContent=T('fmtJpg');$('fmt-png-sub').textContent=T('fmtPng');
  $('fmt-webp-sub').textContent=T('fmtWebp');$('fmt-transp-nm').textContent=T('fmtTranspNm');$('fmt-transp-sub').textContent=T('fmtTranspSub');
  $('cut-basic').textContent=L==='ja'?'Âü∫Êú¨':'Basic';
  $('cr-sq').textContent=L==='ja'?'„Çπ„ÇØ„Ç®„Ç¢':'Square';$('cr-std').textContent=L==='ja'?'„Çπ„Çø„É≥„ÉÄ„Éº„Éâ':'Standard';
  $('cr-wide').textContent=L==='ja'?'„ÉØ„Ç§„Éâ':'Wide';$('cr-port').textContent=L==='ja'?'„Éù„Éº„Éà„É¨„Éº„Éà':'Portrait';
  $('cr-story').textContent=L==='ja'?'„Çπ„Éà„Éº„É™„Éº':'Story';$('cr-free').textContent=L==='ja'?'„Ç´„Çπ„Çø„É†':'Custom';
  // Settings
  $('stg-s-display').textContent=L==='ja'?'Ë°®Á§∫':'Display';
  $('stg-fs-lbl').textContent=L==='ja'?'ÊñáÂ≠ó„ÅÆÂ§ß„Åç„Åï':'Font Size';
  $('stg-fs-sub').textContent=L==='ja'?'UI„ÉÜ„Ç≠„Çπ„Éà„ÅÆ„Çµ„Ç§„Ç∫':'UI text size';
  $('stg-hist-lbl').textContent=L==='ja'?'„Éí„Çπ„Éà„Ç∞„É©„É†Â∏∏ÊôÇË°®Á§∫':'Always Show Histogram';
  $('stg-hist-sub').textContent=L==='ja'?'„Éó„É¨„Éì„É•„Éº„Å´Èáç„Å≠„Å¶Ë°®Á§∫':'Overlay on preview';
  $('stg-zoom-lbl').textContent=L==='ja'?'„Ç∫„Éº„É†ÂÄçÁéáË°®Á§∫':'Show Zoom';
  $('stg-zoom-sub').textContent=L==='ja'?'„Éó„É¨„Éì„É•„Éº„Å´„Ç∫„Éº„É†%„ÇíË°®Á§∫':'Display zoom % on preview';
  $('stg-s-editor').textContent=L==='ja'?'„Ç®„Éá„Ç£„Çø':'Editor';
  $('stg-dm-lbl').textContent=L==='ja'?'„Éá„Éï„Ç©„É´„Éà„É¢„Éº„Éâ':'Default Mode';
  $('stg-dm-sub').textContent=L==='ja'?'Ëµ∑ÂãïÊôÇ„ÅÆ„É¢„Éº„Éâ':'Mode when app opens';
  $('stg-save-lbl').textContent=L==='ja'?'Ë®≠ÂÆö„Çí‰øùÂ≠ò':'Save Settings';
  $('stg-save-sub').textContent=L==='ja'?'„É™„É≠„Éº„ÉâÂæå„ÇÇÁ∂≠ÊåÅ':'Keep after reload';
  $('fs-s').textContent=L==='ja'?'Â∞è':'S';$('fs-m').textContent=L==='ja'?'‰∏≠':'M';$('fs-l').textContent=L==='ja'?'Â§ß':'L';{const e=document.getElementById('fs-xl');if(e)e.textContent=L==='ja'?'ÁâπÂ§ß':'XL';}
  $('dm-easy').textContent=T('easy');$('dm-pro').textContent=T('pro');
  // Rebuild dynamic UI elements with new language
  buildFilterGrid();
  buildEasyCards();
  buildMosaicGrid();
  buildPresets();
  if(typeof buildBlurRegionsList==='function')buildBlurRegionsList();
}
function toggleLang(){L=L==='ja'?'en':'ja';applyLang()}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   SETTINGS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let STG={fontSize:'medium',histOv:false,showZoom:true,defaultMode:'pro',save:true,previewQuality:'high',animQuality:'high',enableFX:true,realtimeRender:true,cursorFX:false};
function loadSTG(){try{const s=localStorage.getItem('lens_stg');if(s)STG={...STG,...JSON.parse(s)}}catch(e){}}
function saveSTG(){if(STG.save)try{localStorage.setItem('lens_stg',JSON.stringify(STG))}catch(e){}}

function syncSTGUI(){
  (['fs-s','fs-m','fs-l','fs-xl']).forEach(id=>{const e=document.getElementById(id);if(e)e.classList.remove('on')});
  const fsMap={small:'fs-s',medium:'fs-m',large:'fs-l',xlarge:'fs-xl'};
  const fse=document.getElementById(fsMap[STG.fontSize]||'fs-m');if(fse)fse.classList.add('on');
  $('tog-hist').checked=STG.histOv;
  $('tog-zoom').checked=STG.showZoom;
  $('dm-easy').classList.toggle('on',STG.defaultMode==='easy');
  $('dm-pro').classList.toggle('on',STG.defaultMode==='pro');
  $('tog-save').checked=STG.save;
  ['pq-high','pq-mid','pq-low'].forEach(id=>{const e=document.getElementById(id);if(e)e.classList.remove('on');});
  const pqe=document.getElementById('pq-'+STG.previewQuality);if(pqe)pqe.classList.add('on');
  ['anim-high','anim-low'].forEach(id=>{const e=document.getElementById(id);if(e)e.classList.remove('on');});
  const aqe=document.getElementById('anim-'+(STG.animQuality||'high'));if(aqe)aqe.classList.add('on');
  const tfx=document.getElementById('tog-fx');if(tfx)tfx.checked=STG.enableFX!==false;
  const trt=document.getElementById('tog-realtime');if(trt)trt.checked=STG.realtimeRender!==false;
  const tcu=document.getElementById('tog-cursor');if(tcu)tcu.checked=!!STG.cursorFX;
  applyGraphicSettings();
}
function setPreviewQuality(q){STG.previewQuality=q;syncSTGUI();saveSTG();}
function setAnimQuality(q){
  STG.animQuality=q;
  document.documentElement.style.setProperty('--anim-dur',q==='low'?'0s':'.15s');
  document.documentElement.style.setProperty('--anim-ease',q==='low'?'none':'cubic-bezier(.22,1,.36,1)');
  syncSTGUI();saveSTG();
}
function toggleFX(v){
  STG.enableFX=v;
  document.querySelectorAll('.sheet,.ovl-inner').forEach(el=>{
    el.style.backdropFilter=v?'blur(20px)':'none';
    el.style.webkitBackdropFilter=v?'blur(20px)':'none';
  });
  syncSTGUI();saveSTG();
}
function toggleRealtime(v){STG.realtimeRender=v;syncSTGUI();saveSTG();}
function toggleCursorFX(v){STG.cursorFX=v;applyGraphicSettings();syncSTGUI();saveSTG();}
function applyGraphicSettings(){
  const q=STG.animQuality||'high';
  document.documentElement.style.setProperty('--anim-dur',q==='low'?'0s':'.15s');
  if(STG.cursorFX){
    document.getElementById('cv-viewport')?.classList.add('cursor-fx');
  } else {
    document.getElementById('cv-viewport')?.classList.remove('cursor-fx');
  }
}
function openSettings(){$('stg-modal').classList.add('op');syncSTGUI()}
function closeSettings(){$('stg-modal').classList.remove('op')}
function setFontSize(s){
  STG.fontSize=s;
  const map={small:'11px',medium:'14px',large:'17px',xlarge:'21px'};
  const sz=map[s]||'14px';
  document.documentElement.style.setProperty('--fs',sz);
  document.body.style.fontSize=sz;
  document.querySelectorAll('.panel-content,.sheet,.tabs').forEach(el=>{el.style.fontSize=sz;});
  syncSTGUI();saveSTG();
}
function toggleHistOv(v){STG.histOv=v;const e=$('ht-overlay');if(e)e.style.display=v?'block':'none';if(v&&srcImg)renderHistOv();saveSTG()}
function toggleZoom(v){STG.showZoom=v;const e=$('zoom-badge');if(e)e.style.display=(v&&srcImg)?'block':'none';saveSTG()}
function setDefaultMode(m){STG.defaultMode=m;syncSTGUI();saveSTG()}
function toggleSaveStg(v){STG.save=v;if(!v)try{localStorage.removeItem('lens_stg')}catch(e){}else saveSTG();syncSTGUI()}
function applySTG(){
  const map={small:'11px',medium:'14px',large:'17px',xlarge:'21px'};
  const sz=map[STG.fontSize]||'14px';
  document.documentElement.style.setProperty('--fs',sz);
  document.body.style.fontSize=sz;
  if(!STG.showZoom)$('zoom-badge').style.display='none';
  if(STG.histOv)$('ht-overlay').style.display='block';
  ['pq-high','pq-mid','pq-low'].forEach(id=>{const e=document.getElementById(id);if(e)e.classList.remove('on');});
  const pqe=document.getElementById('pq-'+(STG.previewQuality||'high'));if(pqe)pqe.classList.add('on');
  applyGraphicSettings();
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   STATE
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const DEF={
  // Tone
  brightness:0,contrast:0,exposure:0,highlights:0,shadows:0,blacks:0,whites:0,
  midtone:0,shadowTint:0,highlightTint:0,
  // Color
  saturation:0,vibrance:0,hue:0,temperature:0,tint:0,
  warmShadows:0,coolHighlights:0,splitHigh:0,splitLow:0,
  // Detail & Optics
  sharpness:0,sharpRadius:50,sharpDetail:25,
  blur:0,clarity:0,dehaze:0,texture:0,
  vignette:0,vignetteFeather:50,vignetteMid:0,
  lens:0,chrAb:0,noise:0,noiseC:0,noiseDetail:50,
  grain:0,grainSize:25,grainRough:50,
  fade:0,distortion:0,
  // Transform
  angle:0,perspH:0,perspV:0,horizWarp:0,vertWarp:0,scaleH:0,scaleV:0,
  // Color Mixer
  rr:0,rg:0,rb:0,gr:0,gg:0,gb:0,br:0,bg2:0,bb:0,
  // RAW
  rawExp:0,rawWB:0,rawTint:0,rawSat:0,
  // Blur region
  blurRadius:20,blurFeather:30,
};
const HSL_COLS=['Red','Orange','Yellow','Green','Aqua','Blue','Purple','Magenta'];
const HSL_DOTS=['#e02020','#f87020','#ddb800','#10a020','#00b8cc','#1060e0','#8820e0','#d010a0'];
HSL_COLS.forEach(c=>{DEF['hH_'+c]=0;DEF['hS_'+c]=0;DEF['hL_'+c]=0});

let adj={...DEF};
let rotDeg=0,fH=false,fV=false;
let rw=1080,rh=1080;
let srcImg=null,imgMeta=null;
let exportFmt='jpg';
let mosaicSize=0;
let filterIntensity=100,activeFilterId=null;
let isDirty=false,curMode='pro',curPanel='tone';
let htMode='rgb',cvCh='L';
let isRawFile=false;
let blurRegions=[];
let blurSelActive=false;
let blurShape='circle';
let myPresets=[];
try{myPresets=JSON.parse(localStorage.getItem('lens_v9')||'[]')}catch(e){}

const curves={
  L:[[0,0],[.25,.25],[.5,.5],[.75,.75],[1,1]],
  R:[[0,0],[.5,.5],[1,1]],G:[[0,0],[.5,.5],[1,1]],B:[[0,0],[.5,.5],[1,1]],
};
function buildCurveLUT(pts){
  // Build a 256-entry LUT from curve control points using linear interpolation
  const lut=new Uint8Array(256);
  for(let i=0;i<256;i++){
    const t=i/255;
    // Find surrounding points
    let lo=pts[0],hi=pts[pts.length-1];
    for(let j=0;j<pts.length-1;j++){
      if(pts[j][0]<=t&&pts[j+1][0]>=t){lo=pts[j];hi=pts[j+1];break;}
    }
    const span=hi[0]-lo[0];
    const v=span<0.001?lo[1]:lo[1]+(hi[1]-lo[1])*((t-lo[0])/span);
    lut[i]=Math.max(0,Math.min(255,Math.round(v*255)));
  }
  return lut;
}
function curvesActive(){
  const isId=(c)=>c.every(([x,y],i,a)=>Math.abs(x-i/(a.length-1))<.01&&Math.abs(y-i/(a.length-1))<.01);
  return!isId(curves.L)||!isId(curves.R)||!isId(curves.G)||!isId(curves.B);
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   FILE SUPPORT
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const RAW_EXTS=new Set(['raw','cr2','cr3','cr4','nef','nrw','arw','sr2','orf','rw2','pef','ptx','dng','heic','heif','avif','tiff','tif','bmp']);

function getExt(name){return name.split('.').pop().toLowerCase()}
function isSpecial(file){return RAW_EXTS.has(getExt(file.name))}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   FILTERS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const FILTERS=[
  // ‚îÄ‚îÄ‚îÄ „Éï„ÉØ„Éï„ÉØ„Éª„Ç®„Ç¢„É™„ÉºÁ≥ª ‚îÄ‚îÄ‚îÄ
  {id:'f4', ic:'‚ú®',nm:'„Ç®„Ç¢„É™„Éº',        nEn:'Airy',          cat:'fluffy',adj:{brightness:18,contrast:-18,saturation:-5,fade:35,vignette:8,shadows:15,highlights:10}},
  {id:'f4b',ic:'üå§Ô∏è',nm:'„Çµ„Éã„Éº„Ç®„Ç¢„Éº',  nEn:'Sunny Air',      cat:'fluffy',adj:{brightness:20,contrast:-14,saturation:5,temperature:12,fade:28,vignette:6,shadows:12,highlights:15}},
  {id:'fa1',ic:'üïäÔ∏è',nm:'„Ç≥„ÉÉ„Éà„É≥„Ç®„Ç¢„Éº',nEn:'Cotton Air',      cat:'fluffy',adj:{brightness:22,contrast:-22,saturation:-8,fade:38,vignette:5,highlights:18,whites:12,shadows:10}},
  {id:'fa2',ic:'üå¨Ô∏è',nm:'„Éâ„É™„Éº„É†„Éò„Ç§„Ç∫',nEn:'Dream Haze',     cat:'fluffy',adj:{brightness:18,contrast:-20,saturation:-12,fade:42,blur:1,vignette:6,highlights:14}},
  {id:'fa3',ic:'üå∏',nm:'„Çπ„Éó„É™„É≥„Ç∞„ÇΩ„Éï„Éà',nEn:'Spring Soft',   cat:'fluffy',adj:{brightness:15,contrast:-15,saturation:8,temperature:10,fade:30,vignette:10,vibrance:12}},
  {id:'fa4',ic:'üç¨',nm:'„Ç≠„É£„É≥„Éá„Ç£',     nEn:'Candy',          cat:'fluffy',adj:{brightness:14,contrast:-10,saturation:18,temperature:8,tint:12,fade:28,vignette:8,vibrance:15}},
  // ‚îÄ‚îÄ‚îÄ „Éõ„ÉØ„Ç§„Éà„Éâ„É™„Éº„É†Á≥ª ‚îÄ‚îÄ‚îÄ
  {id:'f3', ic:'ü§ç',nm:'„Éõ„ÉØ„Ç§„Éà„Éâ„É™„Éº„É†',nEn:'White Dream',    cat:'white',adj:{brightness:20,contrast:-15,saturation:-20,temperature:-15,fade:30,vignette:5,highlights:20}},
  {id:'f3b',ic:'‚òÅÔ∏è',nm:'„ÇØ„É©„Ç¶„Éâ„Éõ„ÉØ„Ç§„Éà',nEn:'Cloud White',    cat:'white',adj:{brightness:25,contrast:-20,saturation:-30,fade:40,vignette:3,highlights:25,whites:20}},
  {id:'f3c',ic:'üïäÔ∏è',nm:'„ÇΩ„Éï„Éà„Éü„É´„ÇØ',  nEn:'Soft Milk',       cat:'white',adj:{brightness:18,contrast:-22,saturation:-15,temperature:-8,fade:35,vignette:8,highlights:18,shadows:10}},
  {id:'f3d',ic:'ü´ß',nm:'„Éî„É•„Ç¢„Éõ„ÉØ„Ç§„Éà', nEn:'Pure White',      cat:'white',adj:{brightness:28,contrast:-28,saturation:-40,fade:45,highlights:30,whites:25,shadows:15}},
  {id:'f3e',ic:'üåÅ',nm:'„Éü„Çπ„Éà„É¢„Éº„Éã„É≥„Ç∞',nEn:'Mist Morning',   cat:'white',adj:{brightness:15,contrast:-18,saturation:-10,temperature:-12,blur:2,fade:28,vignette:6,highlights:15}},
  {id:'fw1',ic:'üåø',nm:'„É¢„Éº„Éã„É≥„Ç∞„Éñ„É™„Éº„Ç∫',nEn:'Morning Breeze',cat:'white',adj:{brightness:16,contrast:-16,saturation:-18,temperature:-5,fade:32,vignette:4,highlights:16,whites:10}},
  // ‚îÄ‚îÄ‚îÄ „Éî„É≥„ÇØÁ≥ª ‚îÄ‚îÄ‚îÄ
  {id:'f1', ic:'üå∏',nm:'„Åµ„Çè„Éî„É≥„ÇØ',     nEn:'Fluffy Pink',    cat:'pink',adj:{brightness:8,contrast:-10,saturation:15,tint:20,temperature:15,fade:22,vignette:12,vibrance:10}},
  {id:'f8', ic:'üçë',nm:'Ê°ÉËâ≤„Éà„ÉØ„Ç§„É©„Ç§„Éà',nEn:'Peach Twilight', cat:'pink',adj:{brightness:12,saturation:25,temperature:25,tint:18,fade:18,vignette:20,vibrance:20}},
  {id:'f8b',ic:'üåπ',nm:'„É≠„Éº„Ç∫„ÇØ„Ç©„Éº„ÉÑ', nEn:'Rose Quartz',    cat:'pink',adj:{brightness:10,contrast:-8,saturation:20,temperature:20,tint:25,fade:25,vignette:15,vibrance:18}},
  {id:'f8c',ic:'üéÄ',nm:'„Éô„Éì„Éº„Éî„É≥„ÇØ',   nEn:'Baby Pink',       cat:'pink',adj:{brightness:15,contrast:-15,saturation:10,temperature:18,tint:30,fade:32,vignette:10,vibrance:12,highlights:12}},
  {id:'f8d',ic:'üå∑',nm:'„ÉÅ„É•„Éº„É™„ÉÉ„Éó',   nEn:'Tulip',           cat:'pink',adj:{brightness:8,contrast:-5,saturation:30,temperature:22,tint:15,fade:15,vignette:18,vibrance:25}},
  {id:'f8e',ic:'üíó',nm:'„Éî„É≥„ÇØ„Éâ„É™„Éº„É†', nEn:'Pink Dream',      cat:'pink',adj:{brightness:14,contrast:-12,saturation:18,temperature:15,tint:28,fade:30,vignette:12,vibrance:15,highlights:10}},
  {id:'f8f',ic:'üçì',nm:'„Çπ„Éà„É≠„Éô„É™„Éº',   nEn:'Strawberry',      cat:'pink',adj:{brightness:6,contrast:5,saturation:35,temperature:18,tint:10,vignette:22,vibrance:30}},
  {id:'fp1',ic:'üå∫',nm:'„Ç≥„Éº„É©„É´„Éñ„É©„ÉÉ„Ç∑„É•',nEn:'Coral Blush',  cat:'pink',adj:{brightness:10,contrast:-8,saturation:22,temperature:20,tint:15,fade:20,vignette:14,vibrance:20}},
  // ‚îÄ‚îÄ‚îÄ Èùí„ÉªÂÜ∑„Åü„ÅÑÁ≥ª ‚îÄ‚îÄ‚îÄ
  {id:'f2', ic:'üíô',nm:'„ÇØ„Éº„É´„Éñ„É´„Éº',   nEn:'Cool Blue',       cat:'cold',adj:{brightness:5,contrast:5,saturation:5,temperature:-30,tint:-10,fade:15,vignette:18,vibrance:8}},
  {id:'f2b',ic:'üßä',nm:'„Ç¢„Ç§„Çπ„Éñ„É´„Éº',   nEn:'Ice Blue',        cat:'cold',adj:{brightness:8,contrast:8,saturation:-10,temperature:-40,tint:-15,fade:20,vignette:22,vibrance:5}},
  {id:'fc1',ic:'üåä',nm:'„Ç¢„ÇØ„Ç¢„Éû„É™„É≥',   nEn:'Aquamarine',      cat:'cold',adj:{brightness:8,contrast:5,saturation:12,temperature:-35,tint:-8,fade:12,vignette:16,vibrance:18}},
  {id:'fc2',ic:'‚ùÑÔ∏è',nm:'„Ç¶„Ç£„É≥„Çø„Éº„Éï„É≠„Çπ„Éà',nEn:'Winter Frost', cat:'cold',adj:{brightness:12,contrast:-5,saturation:-20,temperature:-45,tint:-5,fade:25,vignette:18,highlights:10}},
  {id:'fc3',ic:'üåô',nm:'„É†„Éº„É≥„É©„Ç§„Éà',   nEn:'Moonlight',       cat:'cold',adj:{brightness:-5,contrast:18,saturation:-15,temperature:-28,tint:-12,vignette:35,clarity:8,fade:10}},
  {id:'fc4',ic:'üî∑',nm:'„Çµ„Éï„Ç°„Ç§„Ç¢',     nEn:'Sapphire',        cat:'cold',adj:{brightness:5,contrast:12,saturation:10,temperature:-38,tint:-18,vignette:28,vibrance:12}},
  {id:'fc5',ic:'üåå',nm:'„Éü„ÉÉ„Éâ„Éä„Ç§„Éà',   nEn:'Midnight',        cat:'cold',adj:{brightness:-10,contrast:20,saturation:-5,temperature:-20,tint:-8,vignette:40,clarity:10,fade:8}},
  // ‚îÄ‚îÄ‚îÄ Ê∏©„Åã„ÅÑÁ≥ª ‚îÄ‚îÄ‚îÄ
  {id:'f5', ic:'üçä',nm:'„Ç¥„Éº„É´„Éá„É≥„Ç¢„ÉØ„Éº',nEn:'Golden Hour',    cat:'warm',adj:{brightness:8,contrast:10,saturation:20,temperature:35,tint:8,vignette:25,fade:10}},
  {id:'f5b',ic:'üåÖ',nm:'„Çµ„É≥„Çª„ÉÉ„Éà',     nEn:'Sunset',          cat:'warm',adj:{brightness:5,contrast:15,saturation:25,temperature:40,tint:5,vignette:30,fade:8,vibrance:15}},
  {id:'fw2',ic:'üçØ',nm:'„Éè„Éã„Éº„Ç¥„Éº„É´„Éâ', nEn:'Honey Gold',      cat:'warm',adj:{brightness:10,contrast:8,saturation:22,temperature:38,tint:10,vignette:22,fade:8,vibrance:18}},
  {id:'fw3',ic:'üî•',nm:'„Éï„Ç°„Ç§„Ç¢„Éº„Çµ„É≥„Çª„ÉÉ„Éà',nEn:'Fire Sunset', cat:'warm',adj:{brightness:5,contrast:18,saturation:30,temperature:45,tint:8,vignette:32,fade:6,vibrance:20}},
  {id:'fw4',ic:'üåæ',nm:'„Ç™„Éº„Çø„É†„Ç¥„Éº„É´„Éâ',nEn:'Autumn Gold',    cat:'warm',adj:{brightness:6,contrast:12,saturation:25,temperature:32,tint:6,vignette:26,grain:15,fade:8}},
  {id:'fw5',ic:'üïØÔ∏è',nm:'„Ç≠„É£„É≥„Éâ„É´„É©„Ç§„Éà',nEn:'Candlelight',   cat:'warm',adj:{brightness:4,contrast:15,saturation:20,temperature:42,tint:12,vignette:30,warmShadows:20,fade:12}},
  {id:'fw6',ic:'üåÑ',nm:'„Ç¥„Éº„É´„Éá„É≥„É¢„Éº„Éã„É≥„Ç∞',nEn:'Golden Morning',cat:'warm',adj:{brightness:14,contrast:8,saturation:18,temperature:30,tint:5,vignette:18,fade:10,highlights:-8}},
  // ‚îÄ‚îÄ‚îÄ „ÉÅ„Çß„Ç≠„Éª„Éï„Ç£„É´„É†„Éª„É©„Ç§„Ç´ ‚îÄ‚îÄ‚îÄ
  {id:'f9', ic:'‚òï',nm:'„Ç´„Éï„Çß„Éï„Ç£„É´„É†', nEn:'Cafe Film',       cat:'cheki',adj:{brightness:-5,contrast:15,saturation:-10,temperature:20,grain:35,fade:20,vignette:35}},
  {id:'f9b',ic:'üì∑',nm:'„ÉÅ„Çß„Ç≠È¢®',       nEn:'Cheki',            cat:'cheki',adj:{brightness:15,contrast:-20,saturation:-5,temperature:8,grain:25,fade:38,vignette:15,highlights:18,shadows:8}},
  {id:'f9c',ic:'üéûÔ∏è',nm:'„É¥„Ç£„É≥„ÉÜ„Éº„Ç∏',  nEn:'Vintage Film',    cat:'cheki',adj:{brightness:-8,contrast:20,saturation:-15,temperature:25,grain:45,fade:25,vignette:40,hue:5}},
  {id:'fk1',ic:'üî¥',nm:'„É©„Ç§„Ç´„É¨„ÉÉ„Éâ',   nEn:'Leica Red',        cat:'cheki',adj:{brightness:-5,contrast:22,saturation:-8,temperature:18,grain:40,fade:15,vignette:42,clarity:10}},
  {id:'fk2',ic:'‚¨õ',nm:'„É©„Ç§„Ç´„É¢„Éé',     nEn:'Leica Mono',       cat:'cheki',adj:{saturation:-100,contrast:28,brightness:-5,grain:35,vignette:38,sharpness:18,clarity:12}},
  {id:'fk3',ic:'üì∏',nm:'„Ç≥„ÉÄ„ÉÉ„ÇØ400',    nEn:'Kodak 400',        cat:'cheki',adj:{brightness:-3,contrast:18,saturation:8,temperature:22,grain:50,fade:18,vignette:32,warmShadows:12}},
  {id:'fk4',ic:'üü©',nm:'„Éï„Ç∏„Ç∞„É™„Éº„É≥',   nEn:'Fuji Green',       cat:'cheki',adj:{brightness:2,contrast:15,saturation:12,temperature:-5,grain:30,fade:15,vignette:28,hue:-5}},
  {id:'fk5',ic:'üéûÔ∏è',nm:'„É≠„É¢',          nEn:'Lomo',             cat:'cheki',adj:{brightness:-10,contrast:30,saturation:20,temperature:15,grain:55,fade:10,vignette:50}},
  // ‚îÄ‚îÄ‚îÄ „Éä„ÉÅ„É•„É©„É´Á≥ª ‚îÄ‚îÄ‚îÄ
  {id:'f7', ic:'üåø',nm:'„Éä„ÉÅ„É•„É©„É´„Ç∞„É™„Éº„É≥',nEn:'Natural Green', cat:'natural',adj:{brightness:5,saturation:20,temperature:-5,clarity:10,vibrance:15,hue:8}},
  {id:'f10',ic:'üçΩÔ∏è',nm:'„Åä„ÅÑ„Åó„Åù„ÅÜ',     nEn:'Delicious',       cat:'natural',adj:{brightness:10,contrast:18,saturation:30,temperature:18,vibrance:25,clarity:15,highlights:-10}},
  {id:'f11',ic:'üåä',nm:'„Ç™„Éº„Ç∑„É£„É≥',      nEn:'Ocean',           cat:'natural',adj:{brightness:8,saturation:22,temperature:-20,tint:-5,clarity:12,vibrance:20,vignette:15}},
  {id:'fn1',ic:'üå≤',nm:'„Éï„Ç©„É¨„Çπ„Éà',      nEn:'Forest',          cat:'natural',adj:{brightness:3,contrast:12,saturation:18,temperature:-8,clarity:14,vibrance:18,vignette:12,hue:10}},
  {id:'fn2',ic:'üåæ',nm:'„Çπ„Éó„É™„É≥„Ç∞„Éï„Ç£„Éº„É´„Éâ',nEn:'Spring Field', cat:'natural',adj:{brightness:8,contrast:8,saturation:22,temperature:5,clarity:10,vibrance:20,fade:8}},
  // ‚îÄ‚îÄ‚îÄ „É¢„Éé„ÇØ„É≠„Éª„Ç¢„Éº„ÉàÁ≥ª ‚îÄ‚îÄ‚îÄ
  {id:'f6', ic:'üñ§',nm:'„É¢„Éé„ÇØ„É≠',        nEn:'Monochrome',      cat:'mono',adj:{saturation:-100,contrast:20,sharpness:20,vignette:30}},
  {id:'f6b',ic:'‚¨ú',nm:'„ÇΩ„Éï„Éà„É¢„Éé',     nEn:'Soft Mono',        cat:'mono',adj:{saturation:-100,contrast:5,brightness:12,fade:20,vignette:15}},
  {id:'f12',ic:'üåô',nm:'„Éä„Ç§„Éà„É†„Éº„Éâ',    nEn:'Night Mood',       cat:'mono',adj:{brightness:-18,contrast:25,saturation:10,temperature:-10,vignette:45,clarity:8}},
  {id:'fm1',ic:'üìΩÔ∏è',nm:'„Éè„Ç§„Ç≥„É≥„Éà„É©„Çπ„Éà',nEn:'High Contrast',  cat:'mono',adj:{saturation:-80,contrast:40,sharpness:15,vignette:35,clarity:15,blacks:-10}},
  {id:'fm2',ic:'üü§',nm:'„Çª„Éî„Ç¢',          nEn:'Sepia',           cat:'mono',adj:{saturation:-100,contrast:15,brightness:5,temperature:30,tint:10,fade:20,vignette:25}},
  {id:'fm3',ic:'üåå',nm:'„Ç§„É≥„Éï„É©„É¨„ÉÉ„Éâ',  nEn:'Infrared',         cat:'mono',adj:{saturation:-100,contrast:20,sharpness:10,vignette:28,brightness:8,hue:180}},
];

function buildFilterGrid(){
  const el=$('filter-grid');if(!el)return;
  const catOrder=['fluffy','white','pink','cold','warm','cheki','natural','mono'];
  const cats=catOrder.map(k=>({label:T('filterCats',k),ids:FILTERS.filter(f=>f.cat===k).map(f=>f.id)}));
  let html='';
  cats.forEach(cat=>{
    if(!cat.ids.length)return;
    html+=`<div class="fg-cat">${cat.label}</div>`;
    cat.ids.forEach(id=>{
      const f=FILTERS.find(x=>x.id===id);if(!f)return;
      const nm=L==='en'&&f.nEn?f.nEn:f.nm;
      html+=`<div class="fc${activeFilterId===id?' on':''}" onclick="applyFilter('${id}')"><div class="fi">${f.ic}</div><div class="fn">${nm}</div></div>`;
    });
  });
  el.innerHTML=html;
  // Intensity slider
  const ir=$('filt-intensity');if(!ir)return;
  ir.innerHTML=buildESliderHTML('__fi__','',0,100,filterIntensity,'');
  attachES(document.getElementById('ehit-__fi__'),'__fi__',0,100);
}

function applyFilter(id){
  activeFilterId=id;
  const f=FILTERS.find(x=>x.id===id);if(!f)return;
  const t=filterIntensity/100;
  adj={...DEF};
  Object.entries(f.adj).forEach(([k,v])=>{if(k in adj)adj[k]=Math.round(v*t)});
  isDirty=true;buildAllSliders();scheduleRender();buildFilterGrid();
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   EASY CARDS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const EASY_DEFS=[
  {key:'brightness',ico:'‚òÄÔ∏è',min:-100,max:100},
  {key:'contrast',  ico:'‚óë', min:-100,max:100},
  {key:'saturation',ico:'üé®',min:-100,max:100},
  {key:'temperature',ico:'üå°Ô∏è',min:-100,max:100},
  {key:'fade',      ico:'üå´Ô∏è',min:0,max:100},
  {key:'sharpness', ico:'üîç',min:0,max:100},
  {key:'vignette',  ico:'‚≠ï',min:0,max:100},
  {key:'grain',     ico:'üéûÔ∏è',min:0,max:100},
];

function buildEasyCards(){
  const el=$('easy-cards');if(!el)return;
  el.innerHTML=EASY_DEFS.map(d=>`
    <div class="ec">
      <div class="ec-hd"><span class="ec-ico">${d.ico}</span><span class="ec-ttl">${T('easyLbls',d.key)}</span></div>
      <div class="ec-sub">${T('easyDesc',d.key)}</div>
      ${buildESliderHTML(d.key,d.key,d.min,d.max,adj[d.key]??0,T('easyLbls',d.key))}
    </div>`).join('');
  EASY_DEFS.forEach(d=>attachES(document.getElementById('ehit-'+d.key),d.key,d.min,d.max));
}

function buildESliderHTML(id,key,min,max,v,label){
  const p=((v-min)/(max-min))*100;
  const hasMid=min<0;
  const fl=hasMid?(v>=0?'50%':p+'%'):'0%';
  const fw=hasMid?(v>=0?(p-50)+'%':(50-p)+'%'):p+'%';
  return`<div class="ec-val-row"><span></span><span class="ec-val${v!==0?' nz':''}" id="ev-${id}">${v>0?'+'+v:v}</span></div>
<div class="es-hit" id="ehit-${id}" data-min="${min}" data-max="${max}">
  <div class="es-bg">${hasMid?'<div class="es-mid"></div>':''}
    <div class="es-fill" id="ef-${id}" style="left:${fl};width:${fw}"></div>
    <div class="es-knob" id="ek-${id}" style="left:${p}%"></div>
  </div>
</div>`;
}

function attachES(hit,id,min,max){
  if(!hit)return;
  let active=false;
  function calcV(clientX){
    const rect=hit.getBoundingClientRect();
    const w=rect.width;if(!w)return(id==='__fi__')?filterIntensity:(adj[id]??0);
    const frac=Math.max(0,Math.min(1,(clientX-rect.left)/w));
    return Math.round(min+frac*(max-min));
  }
  function applyV(v){
    const p=((v-min)/(max-min))*100;
    const hasMid=min<0;
    const fl=hasMid?(v>=0?'50%':p+'%'):'0%';
    const fw=hasMid?(v>=0?(p-50)+'%':(50-p)+'%'):p+'%';
    const ev=document.getElementById('ev-'+id);
    const ef=document.getElementById('ef-'+id);
    const ek=document.getElementById('ek-'+id);
    if(ev){ev.textContent=v>0?'+'+v:String(v);ev.className='ec-val'+(v!==0?' nz':'');}
    if(ef){ef.style.left=fl;ef.style.width=fw;}
    if(ek)ek.style.left=p+'%';
    if(id==='__fi__'){filterIntensity=v;if(activeFilterId)applyFilter(activeFilterId);}
    else{adj[id]=v;isDirty=true;activeFilterId=null;updateProSlider(id,v,min,max);if(STG.realtimeRender!==false||!active)scheduleRender();}
  }
  hit.addEventListener('pointerdown',e=>{
    active=true;
    hit.classList.add('drag');hit.setPointerCapture(e.pointerId);
    applyV(calcV(e.clientX));e.preventDefault();
    if(navigator.vibrate)navigator.vibrate(4);
  },{passive:false});
  hit.addEventListener('pointermove',e=>{
    if(!active)return;
    e.preventDefault();
    applyV(calcV(e.clientX));
  },{passive:false});
  const end=()=>{active=false;hit.classList.remove('drag')};
  hit.addEventListener('pointerup',end);hit.addEventListener('pointercancel',end);
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   PRO SLIDERS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const GROUPS={
  tone:[
    ['brightness',-100,100],['contrast',-100,100],['exposure',-100,100],
    ['highlights',-100,100],['shadows',-100,100],['blacks',-100,100],['whites',-100,100],
    ['midtone',-100,100],['shadowTint',-100,100],['highlightTint',-100,100],
  ],
  color:[
    ['saturation',-100,100],['vibrance',-100,100],['hue',-180,180],
    ['temperature',-100,100],['tint',-100,100],
    ['warmShadows',-100,100],['coolHighlights',-100,100],
    ['splitHigh',-100,100],['splitLow',-100,100],
  ],
  detail:[
    ['sharpness',0,100],['sharpRadius',0,100],['sharpDetail',0,100],
    ['blur',0,50],['clarity',-100,100],['dehaze',-100,100],
    ['vignette',0,100],['vignetteFeather',0,100],['vignetteMid',-100,100],
    ['lens',-100,100],['chrAb',0,50],
    ['noise',0,100],['noiseC',0,100],['noiseDetail',0,100],
    ['texture',0,100],['grain',0,100],['grainSize',0,100],['grainRough',0,100],['fade',0,100],['distortion',-100,100],
  ],
  xform:[
    ['angle',-45,45],['perspH',-50,50],['perspV',-50,50],
    ['horizWarp',-50,50],['vertWarp',-50,50],['scaleH',-50,50],['scaleV',-50,50],
  ],
  adv:[
    ['rr',-100,100],['rg',-100,100],['rb',-100,100],
    ['gr',-100,100],['gg',-100,100],['gb',-100,100],
    ['br',-100,100],['bg2',-100,100],['bb',-100,100],
  ],
  raw:[['rawExp',-100,100],['rawWB',-100,100],['rawTint',-100,100],['rawSat',-100,100]],
  blurSec:[['blurRadius',1,100],['blurFeather',0,100]],
};

function buildProSliderHTML(key,min,max){
  const v=adj[key]??0;const p=pct(v,min,max);
  const hasMid=min<0;
  const fl=hasMid?(v>=0?'50%':p+'%'):'0%';
  const fw=hasMid?(v>=0?(p-50)+'%':(50-p)+'%'):p+'%';
  const lbl=T('sl',key)||key;
  return`<div class="sl-row">
  <div class="sl-top">
    <span class="sl-lbl">${lbl}</span>
    <span class="sl-val-wrap"><span class="sl-val${v!==0?' nz':''}" id="sv-${key}" onclick="openNI('${key}',${min},${max})">${fmtV(v)}</span><input class="sl-inp" id="si-${key}" type="number" min="${min}" max="${max}" onblur="closeNI('${key}',${min},${max})" onkeydown="niKey(event,'${key}',${min},${max})"/></span>
  </div>
  <div class="sl-hit" id="sh-${key}" data-min="${min}" data-max="${max}">
    <div class="sl-track">${hasMid?'<div class="sl-mid"></div>':''}
      <div class="sl-fill" id="sf-${key}" style="left:${fl};width:${fw}"></div>
      <div class="sl-knob" id="sk-${key}" style="left:${p}%"></div>
    </div>
  </div>
</div>`;
}

function buildGroup(defs,cid){
  const el=$(cid);if(!el)return;
  el.innerHTML=defs.map(([k,mn,mx])=>buildProSliderHTML(k,mn,mx)).join('');
  defs.forEach(([k,mn,mx])=>attachPS(document.getElementById('sh-'+k),k,mn,mx));
}

function buildAllSliders(){
  buildGroup(GROUPS.tone,'sl-tone');
  buildGroup(GROUPS.color,'sl-color');
  buildGroup(GROUPS.detail,'sl-detail');
  buildGroup(GROUPS.xform,'sl-xform');
  buildGroup(GROUPS.adv,'sl-adv');
  buildGroup(GROUPS.blurSec,'sl-blur-strength');
  // RAW section
  if(isRawFile){
    let rawEl=$('sl-raw');
    if(!rawEl){
      const detail=$('panel-detail');
      if(detail){
        const sec=document.createElement('div');sec.className='sec';sec.id='raw-sec';
        sec.innerHTML=`<div class="sec-hd"><div class="sec-ttl"><div class="sec-bar" style="background:#ff4400"></div><span>RAW ÁèæÂÉèË®≠ÂÆö</span></div></div><div class="sec-body"><div id="sl-raw"></div></div>`;
        detail.insertBefore(sec,detail.firstChild.nextSibling);
      }
    }
    if($('sl-raw'))buildGroup(GROUPS.raw,'sl-raw');
  }
  buildHSL();buildEasyCards();buildFilterGrid();
}

function attachPS(hit,key,min,max){
  if(!hit)return;
  let active=false;
  function calcV(clientX){
    const rect=hit.getBoundingClientRect();
    const w=rect.width;if(!w)return adj[key]??0;
    const frac=Math.max(0,Math.min(1,(clientX-rect.left)/w));
    return Math.round(min+frac*(max-min));
  }
  function applyV(v){
    adj[key]=v;isDirty=true;
    updateProSlider(key,v,min,max);
    if(STG.realtimeRender!==false||!active)scheduleRender();
  }
  hit.addEventListener('pointerdown',e=>{
    active=true;
    hit.classList.add('drag');hit.setPointerCapture(e.pointerId);
    applyV(calcV(e.clientX));e.preventDefault();
    if(navigator.vibrate)navigator.vibrate(4);
  },{passive:false});
  hit.addEventListener('pointermove',e=>{
    if(!active)return;
    e.preventDefault();
    applyV(calcV(e.clientX));
  },{passive:false});
  const end=()=>{active=false;hit.classList.remove('drag')};
  hit.addEventListener('pointerup',end);hit.addEventListener('pointercancel',end);
}

function updateProSlider(key,v,min,max){
  const p=pct(v,min,max);
  const hasMid=min<0;
  const fl=hasMid?(v>=0?'50%':p+'%'):'0%';
  const fw=hasMid?(v>=0?(p-50)+'%':(50-p)+'%'):p+'%';
  const sv=document.getElementById('sv-'+key);
  const sf=document.getElementById('sf-'+key);
  const sk=document.getElementById('sk-'+key);
  if(sv){sv.textContent=fmtV(v);sv.className='sl-val'+(v!==0?' nz':'');}
  if(sf){sf.style.left=fl;sf.style.width=fw;}
  if(sk)sk.style.left=p+'%';
}

function openNI(key,min,max){
  const si=document.getElementById('si-'+key);if(!si)return;
  si.value=adj[key]??0;si.style.display='block';
  requestAnimationFrame(()=>{si.focus();si.select()});
}
function closeNI(key,min,max){
  const si=document.getElementById('si-'+key);if(!si)return;
  let v=parseInt(si.value,10);if(isNaN(v))v=adj[key]??0;
  v=Math.max(min,Math.min(max,v));
  adj[key]=v;isDirty=true;
  updateProSlider(key,v,min,max);scheduleRender();si.style.display='none';
}
function niKey(e,key,min,max){if(e.key==='Enter'||e.key==='Escape'){e.preventDefault();closeNI(key,min,max)}}

/* HSL */
function buildHSL(){
  const el=$('hsl-panel');if(!el)return;
  const subs=[['H',-50,50],['S',-100,100],['L',-100,100]];
  el.innerHTML=HSL_COLS.map((c,i)=>`
    <div class="hsl-cr">
      <div class="hsl-hd"><div class="hsl-dot" style="background:${HSL_DOTS[i]}"></div><span class="hsl-nm">${c}</span></div>
      ${subs.map(([s,mn,mx])=>{
        const key='h'+s+'_'+c;const v=adj[key]??0;const p=pct(v,mn,mx);
        const fl=v>=0?'50%':p+'%';const fw=v>=0?(p-50)+'%':(50-p)+'%';
        return`<div class="hsl-sub">
          <span class="hsl-sl">${s}</span>
          <div class="sl-hit" id="sh-${key}" data-min="${mn}" data-max="${mx}">
            <div class="sl-track"><div class="sl-mid"></div>
              <div class="sl-fill" id="sf-${key}" style="left:${fl};width:${fw}"></div>
              <div class="sl-knob" id="sk-${key}" style="left:${p}%"></div>
            </div>
          </div>
          <span class="hsl-v${v!==0?' nz':''}" id="sv-${key}">${fmtV(v)}</span>
        </div>`;
      }).join('')}
    </div>`).join('');
  HSL_COLS.forEach(c=>subs.forEach(([s,mn,mx])=>{
    const key='h'+s+'_'+c;
    attachPS(document.getElementById('sh-'+key),key,mn,mx);
  }));
}

function toggleSec(hd){hd.parentElement.classList.toggle('closed')}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   RENDER ENGINE ‚Äî complete rewrite for correctness
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let rQueued=false,lastZoom=1;
let vpZoom=1,vpPanX=0,vpPanY=0,vpFitZoom=1;

function updateCanvasTransform(){
  const cv=$('prev-cv');if(!cv)return;
  cv.style.transform=`translate(${vpPanX}px,${vpPanY}px) scale(${vpZoom})`;
  updateZoomBadge();
}
function updateZoomBadge(){
  const zb=$('zoom-badge');if(!zb)return;
  if(STG.showZoom&&srcImg){zb.style.display='block';zb.textContent=Math.round(vpZoom*vpFitZoom*100)+'%';}
  else zb.style.display='none';
}
function zoomTo(z,cx,cy){
  const vp=$('cv-viewport');if(!vp||!srcImg)return;
  const rect=vp.getBoundingClientRect();
  const prevZ=vpZoom;
  vpZoom=Math.max(0.1,Math.min(20,z));
  if(cx!==undefined){
    vpPanX=(cx-rect.left)-(cx-rect.left-vpPanX)*(vpZoom/prevZ);
    vpPanY=(cy-rect.top)-(cy-rect.top-vpPanY)*(vpZoom/prevZ);
  }
  updateCanvasTransform();
}
function zoomIn(){zoomTo(vpZoom*1.3)}
function zoomOut(){zoomTo(vpZoom/1.3)}
function zoomReset(){vpZoom=1;vpPanX=0;vpPanY=0;updateCanvasTransform()}
(()=>{
  const vp=$('cv-viewport');if(!vp)return;
  let lastDist=0,lastPt=null;const pts=new Map();
  vp.addEventListener('pointerdown',e=>{
    if(blurSelActive)return;
    pts.set(e.pointerId,{x:e.clientX,y:e.clientY});
    vp.setPointerCapture(e.pointerId);
    if(pts.size===1){lastPt={x:e.clientX,y:e.clientY};vp.classList.add('panning');}
    e.preventDefault();
  },{passive:false});
  vp.addEventListener('pointermove',e=>{
    if(!pts.has(e.pointerId)||blurSelActive)return;
    pts.set(e.pointerId,{x:e.clientX,y:e.clientY});
    const pa=[...pts.values()];
    if(pa.length===2){const d=Math.hypot(pa[0].x-pa[1].x,pa[0].y-pa[1].y);if(lastDist)zoomTo(vpZoom*(d/lastDist),(pa[0].x+pa[1].x)/2,(pa[0].y+pa[1].y)/2);lastDist=d;}
    else if(pa.length===1&&lastPt){vpPanX+=e.clientX-lastPt.x;vpPanY+=e.clientY-lastPt.y;lastPt={x:e.clientX,y:e.clientY};updateCanvasTransform();}
  },{passive:true});
  const pe=e=>{pts.delete(e.pointerId);lastDist=0;if(pts.size===0){lastPt=null;vp.classList.remove('panning');}};
  vp.addEventListener('pointerup',pe);vp.addEventListener('pointercancel',pe);
  vp.addEventListener('wheel',e=>{if(blurSelActive)return;e.preventDefault();zoomTo(vpZoom*(e.deltaY<0?1.12:0.88),e.clientX,e.clientY);},{passive:false});
})();

let _renderRAF=0;
function scheduleRender(){
  if(_renderRAF)return;
  _renderRAF=requestAnimationFrame(()=>{_renderRAF=0;if(srcImg)renderCanvas();});
}

function renderCanvas(){
  if(!srcImg)return;
  const area=$('preview-area');
  const cv=$('prev-cv');
  const AW=area.clientWidth,AH=area.clientHeight;
  if(!AW||!AH)return;

  const _dprBase=window.devicePixelRatio||1;
  const _pqMul=STG.previewQuality==='low'?0.5:STG.previewQuality==='mid'?0.75:1;
  const dpr=Math.max(0.5,_dprBase*_pqMul);
  const iw=srcImg.naturalWidth,ih=srcImg.naturalHeight;
  const sc=Math.min(AW/iw,AH/ih);
  const cssW=Math.round(iw*sc),cssH=Math.round(ih*sc);
  const cw=Math.round(cssW*dpr),ch=Math.round(cssH*dpr);
  lastZoom=sc;vpFitZoom=sc;

  if(cv.width!==cw||cv.height!==ch){cv.width=cw;cv.height=ch;}
  cv.style.width=cssW+'px';cv.style.height=cssH+'px';

  const ctx=cv.getContext('2d',{willReadFrequently:true});
  ctx.clearRect(0,0,cw,ch);

  /* Step 1: draw base with CSS filters */
  ctx.save();
  ctx.scale(dpr,dpr);
  ctx.translate(cssW/2,cssH/2);
  const ang=(rotDeg+adj.angle)*Math.PI/180;
  if(ang)ctx.rotate(ang);
  if(fH)ctx.scale(-1,1);
  if(fV)ctx.scale(1,-1);
  // Perspective (simple skew approximation)
  if(adj.perspH||adj.perspV){ctx.transform(1,adj.perspV/500,adj.perspH/500,1,0,0);}
  const bri=Math.max(0,1+(adj.brightness+adj.rawExp*0.5)/100);
  const con=Math.max(0.01,1+adj.contrast/100);
  const sat=Math.max(0,1+(adj.saturation+adj.rawSat*0.5)/100);
  const blurPx=adj.blur>0?(adj.blur*0.3).toFixed(2)+'px':'';
  const hueRot=(adj.hue)!==0?`hue-rotate(${adj.hue}deg)`:'';
  const filters=[
    `brightness(${bri.toFixed(4)})`,
    `contrast(${con.toFixed(4)})`,
    `saturate(${sat.toFixed(4)})`,
    blurPx?`blur(${blurPx})`:'',
    hueRot,
  ].filter(Boolean).join(' ');
  ctx.filter=filters;
  ctx.drawImage(srcImg,-cssW/2,-cssH/2,cssW,cssH);
  ctx.restore();
  ctx.filter='none';

  /* Step 2: pixel-level operations */
  const exposure=adj.exposure+(adj.rawExp||0);
  const temperature=(adj.temperature||0)+(adj.rawWB||0);
  const tint=(adj.tint||0)+(adj.rawTint||0);
  const vibrance=(adj.vibrance||0)+(adj.rawSat||0)*0.5;

  const hslActive=HSL_COLS.some(c=>adj['hH_'+c]||adj['hS_'+c]||adj['hL_'+c]);
  const crvActive=curvesActive();
  const texV=(adj.texture||0)/100;
  const needPx=exposure||temperature||tint||crvActive||texV||
               adj.highlights||adj.shadows||adj.blacks||adj.whites||
               adj.grain||vibrance||adj.clarity||
               adj.warmShadows||adj.coolHighlights||adj.dehaze||texV||
               adj.noise||adj.noiseC||adj.chrAb||hslActive||
               adj.rr||adj.rg||adj.rb||adj.gr||adj.gg||adj.gb||adj.br||adj.bg2||adj.bb;

  if(needPx){
    const lutL=crvActive?buildCurveLUT(curves.L):null;
    const lutR=crvActive?buildCurveLUT(curves.R):null;
    const lutG=crvActive?buildCurveLUT(curves.G):null;
    const lutB=crvActive?buildCurveLUT(curves.B):null;
    const id=ctx.getImageData(0,0,cw,ch);
    const d=id.data,n=d.length;
    const expMul=exposure?Math.pow(2,exposure/100):1;
    const hiB=adj.highlights/300;
    const shB=adj.shadows/300;
    const blkB=adj.blacks/200;
    const whtB=adj.whites/200;
    const tmpAmt=temperature;
    const tintAmt=tint;
    const vibAmt=vibrance;
    const clarV=(adj.clarity||0)/200;
    const wshB=(adj.warmShadows||0)/300;
    const chlB=(adj.coolHighlights||0)/300;
    const dehV=(adj.dehaze||0)/100;

    for(let i=0;i<n;i+=4){
      let r=d[i],g=d[i+1],b=d[i+2];

      // Exposure
      if(expMul!==1){r=r*expMul;g=g*expMul;b=b*expMul;}
      // Temperature ‚Äî warm=+R-B, cool=-R+B
      if(tmpAmt>0){r+=tmpAmt*0.5;b-=tmpAmt*0.25;}
      else if(tmpAmt<0){b+=(-tmpAmt)*0.5;r-=(-tmpAmt)*0.25;}
      // Tint ‚Äî +green / +magenta
      if(tintAmt>0)g+=tintAmt*0.35;
      else if(tintAmt<0){r+=(-tintAmt)*0.25;b+=(-tintAmt)*0.25;}

      const lum=(0.299*r+0.587*g+0.114*b)/255;

      // Highlights
      if(adj.highlights&&lum>0.5){const s2=((lum-0.5)/0.5)*hiB;r+=r*s2;g+=g*s2;b+=b*s2;}
      // Shadows
      if(adj.shadows&&lum<0.5){const s2=((0.5-lum)/0.5)*shB;r+=r*s2;g+=g*s2;b+=b*s2;}
      // Whites
      if(adj.whites&&lum>0.75){const s2=((lum-0.75)/0.25)*whtB;r+=r*s2;g+=g*s2;b+=b*s2;}
      // Blacks
      if(adj.blacks&&lum<0.25){const s2=((0.25-lum)/0.25)*blkB;r-=r*s2;g-=g*s2;b-=b*s2;}

      // Vibrance (smart saturation)
      if(vibAmt){
        const mx=Math.max(r,g,b);const mn2=Math.min(r,g,b);
        const curSat=mx>0?(mx-mn2)/mx:0;
        const boost=(vibAmt/100)*(1-curSat)*0.6;
        const avg=(r+g+b)/3;
        r+=(r-avg)*boost;g+=(g-avg)*boost;b+=(b-avg)*boost;
      }
      // Clarity
      if(clarV&&lum>0.05&&lum<0.95){
        const avg2=(r+g+b)/3/255;const diff=(avg2-lum)*clarV;
        r+=diff*r;g+=diff*g;b+=diff*b;
      }
      // Texture (micro-contrast enhancement)
      if(texV&&lum>0.05&&lum<0.95){
        const tAvg=(r+g+b)/3/255;
        const tDiff=(tAvg>0.5?1:-1)*texV*0.12;
        r=clamp(r+r*tDiff);g=clamp(g+g*tDiff);b=clamp(b+b*tDiff);
      }
      // Warm shadows
      if(wshB&&lum<0.5){const s2=((0.5-lum)/0.5)*wshB;r+=s2*30;b-=s2*15;}
      // Cool highlights
      if(chlB&&lum>0.5){const s2=((lum-0.5)/0.5)*chlB;b+=s2*25;r-=s2*12;}
      // Dehaze
      if(dehV){const h=dehV*0.15;r-=h*255*(1-lum);g-=h*255*(1-lum);b-=h*255*(1-lum);}
      // Film grain (improved with roughness)
      if(adj.grain){
        const gAmt=adj.grain*0.7;
        const gRough=(adj.grainRough||50)/100;
        const n2=(Math.random()-.5)*gAmt;
        if(gRough<0.5){r+=n2;g+=n2;b+=n2;} // luminance grain
        else{r+=(Math.random()-.5)*gAmt*gRough;g+=(Math.random()-.5)*gAmt*gRough;b+=(Math.random()-.5)*gAmt*gRough;} // chroma grain
      }
      // Luminance noise
      if(adj.noise){const nAmt=(Math.random()-.5)*adj.noise*1.2;r+=nAmt;g+=nAmt;b+=nAmt;}
      // Chroma noise
      if(adj.noiseC){r+=(Math.random()-.5)*adj.noiseC*1.0;g+=(Math.random()-.5)*adj.noiseC*1.0;b+=(Math.random()-.5)*adj.noiseC*1.0;}
      // Chromatic aberration (simple: shift red/blue channels)
      if(adj.chrAb){const ca=adj.chrAb*0.3;r+=ca*(lum-.5);b-=ca*(lum-.5);}
      // Color mixer
      if(adj.rr||adj.rg||adj.rb||adj.gr||adj.gg||adj.gb||adj.br||adj.bg2||adj.bb){
        const nr=r+(adj.rr/100)*r+(adj.rg/100)*g+(adj.rb/100)*b;
        const ng=g+(adj.gr/100)*r+(adj.gg/100)*g+(adj.gb/100)*b;
        const nb=b+(adj.br/100)*r+(adj.bg2/100)*g+(adj.bb/100)*b;
        r=nr;g=ng;b=nb;
      }
      // Apply RGB curves
      if(crvActive){
        const ri=Math.max(0,Math.min(255,Math.round(r)));
        const gi=Math.max(0,Math.min(255,Math.round(g)));
        const bi=Math.max(0,Math.min(255,Math.round(b)));
        r=lutL[lutR[ri]];g=lutL[lutG[gi]];b=lutL[lutB[bi]];
      }
      // HSL per-channel mixer
      {
        const rn=r/255,gn=g/255,bn=b/255;
        const mx=Math.max(rn,gn,bn),mn=Math.min(rn,gn,bn),d2=mx-mn;
        if(d2>0.01){
          let h6;
          if(mx===rn)h6=((gn-bn)/d2+6)%6;
          else if(mx===gn)h6=(bn-rn)/d2+2;
          else h6=(rn-gn)/d2+4;
          const h=h6/6; // 0-1
          // Weights: Red=0, Orange=1/8, Yellow=2/8, Green=3/8, Aqua=4/8, Blue=5/8, Purple=6/8, Magenta=7/8
          const hCols=['Red','Orange','Yellow','Green','Aqua','Blue','Purple','Magenta'];
          const hCenters=[0,1/8,2/8,3/8,4/8,5/8,6/8,7/8];
          let maxW=0,bestCol='';
          for(let ci=0;ci<8;ci++){
            let diff=Math.abs(h-hCenters[ci]);if(diff>0.5)diff=1-diff;
            const w=Math.max(0,1-diff*8);
            if(w>maxW){maxW=w;bestCol=hCols[ci];}
          }
          if(maxW>0.05){
            const hShift=adj['hH_'+bestCol]||0;
            const sShift=adj['hS_'+bestCol]||0;
            const lShift=adj['hL_'+bestCol]||0;
            if(hShift||sShift||lShift){
              // Convert to HSL, adjust, back to RGB
              const l=(mx+mn)/2;
              const s2=d2/(1-Math.abs(2*l-1));
              const newH=((h6/6)+(hShift/360)+1)%1;
              const newS=Math.max(0,Math.min(1,s2*(1+sShift/100)));
              const newL=Math.max(0,Math.min(1,l+lShift/200));
              // HSL to RGB
              const c2=newS*(1-Math.abs(2*newL-1));
              const x2=c2*(1-Math.abs((newH*6)%2-1));
              const m2=newL-c2/2;
              let r2=0,g2=0,b2=0;
              const h2=newH*6;
              if(h2<1){r2=c2;g2=x2;}else if(h2<2){r2=x2;g2=c2;}else if(h2<3){g2=c2;b2=x2;}
              else if(h2<4){g2=x2;b2=c2;}else if(h2<5){r2=x2;b2=c2;}else{r2=c2;b2=x2;}
              r=((r2+m2)*maxW+(rn*(1-maxW)))*255;
              g=((g2+m2)*maxW+(gn*(1-maxW)))*255;
              b=((b2+m2)*maxW+(bn*(1-maxW)))*255;
            }
          }
        }
      }

      d[i]=clamp(r);d[i+1]=clamp(g);d[i+2]=clamp(b);
    }
    ctx.putImageData(id,0,0);
  }

  /* Sharpness (unsharp mask) */
  if(adj.sharpness>0){
    const amt=adj.sharpness/100*1.5;
    const tmp=document.createElement('canvas');tmp.width=cw;tmp.height=ch;
    const tc=tmp.getContext('2d');
    tc.filter=`blur(1px)`;tc.drawImage(cv,0,0);
    const src2=ctx.getImageData(0,0,cw,ch);
    const blr=tc.getImageData(0,0,cw,ch);
    const sd=src2.data,bd=blr.data;
    for(let i=0;i<sd.length;i+=4){
      sd[i]=clamp(sd[i]+(sd[i]-bd[i])*amt);
      sd[i+1]=clamp(sd[i+1]+(sd[i+1]-bd[i+1])*amt);
      sd[i+2]=clamp(sd[i+2]+(sd[i+2]-bd[i+2])*amt);
    }
    ctx.putImageData(src2,0,0);
  }

  /* Step 3: mosaic */
  if(mosaicSize>0){
    const ms=Math.max(2,Math.round(mosaicSize*sc/6));
    const src=ctx.getImageData(0,0,cw,ch);
    const tmp=new ImageData(cw,ch);
    const sd=src.data,td=tmp.data;
    for(let y=0;y<ch;y+=ms){for(let x=0;x<cw;x+=ms){
      const bi=(y*cw+x)*4;
      const pr=sd[bi],pg=sd[bi+1],pb2=sd[bi+2];
      for(let dy=0;dy<ms&&y+dy<ch;dy++)for(let dx=0;dx<ms&&x+dx<cw;dx++){
        const ti=((y+dy)*cw+(x+dx))*4;
        td[ti]=pr;td[ti+1]=pg;td[ti+2]=pb2;td[ti+3]=255;
      }
    }}
    ctx.putImageData(tmp,0,0);
  }

  /* Step 4: region blur */
  if(blurRegions.length){
    const dprR=window.devicePixelRatio||1;
    blurRegions.forEach(({x,y,rx,ry,str,feather,shape,r:legR})=>{
      const prx=(rx||legR||30)*dprR,pry=(ry||legR||30)*dprR;
      const px2=x*dprR,py2=y*dprR;
      const pad=(feather||50)*dprR*0.15+4;
      const x0=Math.max(0,Math.round(px2-prx-pad));
      const y0=Math.max(0,Math.round(py2-pry-pad));
      const x1=Math.min(cw,Math.round(px2+prx+pad));
      const y1=Math.min(ch,Math.round(py2+pry+pad));
      if(x1<=x0||y1<=y0)return;
      const w2=x1-x0,h2=y1-y0;
      const piece=ctx.getImageData(x0,y0,w2,h2);
      const blurred=boxBlurID(piece,Math.max(1,Math.round(str*dprR*0.12)));
      const bd=blurred.data;const od=piece.data;
      for(let pyi=0;pyi<h2;pyi++)for(let pxi=0;pxi<w2;pxi++){
        const ax=pxi+x0-px2,ay=pyi+y0-py2;
        let alpha=0;
        if(shape==='rect'){const fx=Math.max(0,Math.min(1,1-Math.max(0,Math.abs(ax)-prx)/(pad+1)));const fy=Math.max(0,Math.min(1,1-Math.max(0,Math.abs(ay)-pry)/(pad+1)));alpha=fx*fy;}
        else if(shape==='gradient'){alpha=Math.max(0,Math.min(1,0.5+(ay/(pry||1))*0.5));}
        else{const d=Math.hypot(ax/(prx||1),ay/(pry||1));alpha=Math.max(0,Math.min(1,1-d));}
        alpha=alpha*alpha;
        const ii=(pyi*w2+pxi)*4;
        od[ii]=od[ii]*(1-alpha)+bd[ii]*alpha;
        od[ii+1]=od[ii+1]*(1-alpha)+bd[ii+1]*alpha;
        od[ii+2]=od[ii+2]*(1-alpha)+bd[ii+2]*alpha;
      }
      ctx.putImageData(piece,x0,y0);
    });
  }

  /* Step 5: overlay effects */
  if(adj.vignette>0){
    const vg=ctx.createRadialGradient(cw/2,ch/2,0,cw/2,ch/2,Math.hypot(cw,ch)*0.55);
    vg.addColorStop(Math.max(0,1-adj.vignette/100*0.65),'rgba(0,0,0,0)');
    vg.addColorStop(1,`rgba(0,0,0,${(adj.vignette/100*0.88).toFixed(3)})`);
    ctx.fillStyle=vg;ctx.fillRect(0,0,cw,ch);
  }
  if(adj.fade>0){
    ctx.fillStyle=`rgba(255,255,255,${(adj.fade/100*0.4).toFixed(3)})`;
    ctx.fillRect(0,0,cw,ch);
  }

  /* UI updates */
  const ef=$('exp-fill');if(ef)ef.style.width=(50+(adj.exposure||0)/2)+'%';
  // Position canvas in viewport
  if($('cv-viewport')){
    cv.style.left=Math.round((AW-cssW)/2)+'px';
    cv.style.top=Math.round((AH-cssH)/2)+'px';
  }
  updateZoomBadge();

  /* Histogram updates (deferred, non-blocking) */
  requestAnimationFrame(()=>{
    if($('panel-tone').classList.contains('on'))drawHistogram();
    if(STG.histOv)renderHistOv();
  });
}

function boxBlurID(imageData,r){
  const d=new Uint8ClampedArray(imageData.data);
  const W=imageData.width,H=imageData.height;
  const out=new Uint8ClampedArray(d.length);
  for(let y=0;y<H;y++){
    for(let x=0;x<W;x++){
      let sr=0,sg=0,sb=0,cnt=0;
      for(let dy=-r;dy<=r;dy++){for(let dx=-r;dx<=r;dx++){
        const nx=x+dx,ny=y+dy;
        if(nx>=0&&nx<W&&ny>=0&&ny<H){
          const i=(ny*W+nx)*4;sr+=d[i];sg+=d[i+1];sb+=d[i+2];cnt++;
        }
      }}
      const i=(y*W+x)*4;out[i]=sr/cnt;out[i+1]=sg/cnt;out[i+2]=sb/cnt;out[i+3]=d[i+3];
    }
  }
  return new ImageData(out,W,H);
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   SW OVERRIDE FOR DRAW TAB
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
(function(){
  // Wrap sw to handle draw canvas visibility
  const origSw=window.sw;
  if(!origSw)return;
  window.sw=function(id){
    origSw(id);
    // Draw canvas visibility
    let dcv=document.getElementById('draw-cv');
    if(id==='draw'){
      if(!dcv||!dCanvas){initDrawCanvas();dcv=document.getElementById('draw-cv');}
      if(dcv){dcv.style.display='block';dcv.classList.add('active');}
      // Sync canvas size
      if(dCanvas&&srcImg){
        const area=document.getElementById('preview-area');
        if(area){const r=area.getBoundingClientRect();if(dCanvas.width!==Math.round(r.width)){const tmp=document.createElement('canvas');tmp.width=dCanvas.width;tmp.height=dCanvas.height;tmp.getContext('2d').drawImage(dCanvas,0,0);dCanvas.width=Math.round(r.width);dCanvas.height=Math.round(r.height);dCtx.drawImage(tmp,0,0,tmp.width,tmp.height,0,0,dCanvas.width,dCanvas.height);}}
      }
    } else {
      if(dcv){dcv.style.display='none';dcv.classList.remove('active');}
    }
  };
})();

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   HISTOGRAM
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function setHtMode(btn,mode){
  htMode=mode;
  document.querySelectorAll('.ht-tab').forEach(b=>b.classList.toggle('on',b===btn));
  drawHistogram();
}

function getPixelData(){
  const pv=$('prev-cv');
  if(!pv||pv.style.display==='none')return null;
  try{return pv.getContext('2d',{willReadFrequently:true}).getImageData(0,0,pv.width,pv.height)}
  catch(e){return null}
}

function drawHistogram(){
  const hc=$('ht-canvas');if(!hc)return;
  const id=getPixelData();if(!id)return;
  const dpr=window.devicePixelRatio||1;
  const rect=hc.getBoundingClientRect();
  if(!rect.width)return;
  const W=Math.round(rect.width*dpr),H=Math.round(rect.height*dpr)||120;
  if(hc.width!==W||hc.height!==H){hc.width=W;hc.height=H}
  const ctx=hc.getContext('2d');
  ctx.clearRect(0,0,W,H);ctx.fillStyle='#0d0d0d';ctx.fillRect(0,0,W,H);
  const d=id.data;const bw=Math.ceil(W/256)+1;
  if(htMode==='rgb'){
    const rH=new Int32Array(256),gH=new Int32Array(256),bH=new Int32Array(256);
    for(let i=0;i<d.length;i+=4){rH[d[i]]++;gH[d[i+1]]++;bH[d[i+2]]++;}
    let mx=0;
    for(let i=0;i<256;i++){if(rH[i]>mx)mx=rH[i];if(gH[i]>mx)mx=gH[i];if(bH[i]>mx)mx=bH[i];}
    if(!mx)return;
    [[rH,'rgba(200,60,60,.75)'],[gH,'rgba(60,185,80,.75)'],[bH,'rgba(60,120,220,.75)']].forEach(([h,col])=>{
      ctx.fillStyle=col;
      for(let i=0;i<256;i++){const bh=Math.round((h[i]/mx)*(H-2));ctx.fillRect(Math.round(i/256*W),H-bh,bw,bh);}
    });
  }else{
    const lH=new Int32Array(256);
    for(let i=0;i<d.length;i+=4)lH[Math.round(.299*d[i]+.587*d[i+1]+.114*d[i+2])]++;
    let mx=0;for(let i=0;i<256;i++)if(lH[i]>mx)mx=lH[i];
    if(!mx)return;
    ctx.fillStyle='rgba(200,200,200,.8)';
    for(let i=0;i<256;i++){const bh=Math.round((lH[i]/mx)*(H-2));ctx.fillRect(Math.round(i/256*W),H-bh,bw,bh);}
  }
}

function renderHistOv(){
  const hca=$('ht-ov-cv');if(!hca)return;
  const id=getPixelData();if(!id)return;
  const box=document.getElementById('ht-overlay');
  if(!box||box.style.display==='none')return;
  const W=150,H=62;
  hca.width=W;hca.height=H;
  const ctx=hca.getContext('2d');
  ctx.clearRect(0,0,W,H);
  ctx.fillStyle='rgba(0,0,0,.25)';ctx.fillRect(0,0,W,H);
  const d=id.data;const bw=Math.ceil(W/256)+1;
  const rH=new Int32Array(256),gH=new Int32Array(256),bH=new Int32Array(256);
  // „Çµ„É≥„Éó„É™„É≥„Ç∞ÔºàÈ´òÈÄüÂåñ: 4„Éî„ÇØ„Çª„É´„Åî„Å®Ôºâ
  for(let i=0;i<d.length;i+=16){rH[d[i]]++;gH[d[i+1]]++;bH[d[i+2]]++;}
  let mx=1;for(let i=0;i<256;i++){if(rH[i]>mx)mx=rH[i];if(gH[i]>mx)mx=gH[i];if(bH[i]>mx)mx=bH[i];}
  [[rH,'rgba(220,70,70,.7)'],[gH,'rgba(70,200,90,.7)'],[bH,'rgba(70,130,230,.7)']].forEach(([h,col])=>{
    ctx.fillStyle=col;
    for(let i=0;i<256;i++){const bh=Math.round((h[i]/mx)*(H-2));ctx.fillRect(Math.round(i/256*W),H-bh,bw,bh);}
  });
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   RGB CURVE
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function setCvCh(btn,ch){
  cvCh=ch;
  document.querySelectorAll('.cv-tab').forEach(b=>b.classList.toggle('on',b===btn));
  drawCurve();
}
function drawCurve(){
  const cv=$('cv-canvas');if(!cv)return;
  const dpr=window.devicePixelRatio||1;
  const rect=cv.getBoundingClientRect();if(!rect.width)return;
  const W=Math.round(rect.width*dpr),H=Math.round(rect.height*dpr)||240;
  if(cv.width!==W||cv.height!==H){cv.width=W;cv.height=H}
  const ctx=cv.getContext('2d');
  ctx.clearRect(0,0,W,H);ctx.fillStyle='#0d0d0d';ctx.fillRect(0,0,W,H);
  ctx.strokeStyle='#1c1c1c';ctx.lineWidth=dpr;
  for(let i=1;i<4;i++){
    ctx.beginPath();ctx.moveTo(W*i/4,0);ctx.lineTo(W*i/4,H);ctx.stroke();
    ctx.beginPath();ctx.moveTo(0,H*i/4);ctx.lineTo(W,H*i/4);ctx.stroke();
  }
  ctx.strokeStyle='#242424';ctx.lineWidth=dpr;
  ctx.beginPath();ctx.moveTo(0,H);ctx.lineTo(W,0);ctx.stroke();
  const pts=curves[cvCh];
  const col={L:'#c8c8c8',R:'#cc3333',G:'#33aa44',B:'#3366cc'}[cvCh];
  ctx.strokeStyle=col;ctx.lineWidth=2.5*dpr;
  ctx.beginPath();
  pts.forEach(([x,y],i)=>{i===0?ctx.moveTo(x*W,(1-y)*H):ctx.lineTo(x*W,(1-y)*H)});
  ctx.stroke();
  pts.forEach(([x,y])=>{
    ctx.fillStyle=col;ctx.beginPath();ctx.arc(x*W,(1-y)*H,5*dpr,0,Math.PI*2);ctx.fill();
    ctx.strokeStyle='#000';ctx.lineWidth=1.5*dpr;ctx.stroke();
  });
}
(()=>{
  const cv=$('cv-canvas');if(!cv)return;
  let drag=null;
  function toNorm(e){
    const r=cv.getBoundingClientRect();
    const cx=e.clientX??e.touches?.[0].clientX;
    const cy=e.clientY??e.touches?.[0].clientY;
    return[Math.max(0,Math.min(1,(cx-r.left)/r.width)),Math.max(0,Math.min(1,1-(cy-r.top)/r.height))];
  }
  function nearest([x,y]){
    let bi=null,bd=Infinity;
    curves[cvCh].forEach(([px,py],i)=>{const d=Math.hypot(px-x,py-y);if(d<bd){bd=d;bi=i}});
    return bd<0.09?bi:null;
  }
  cv.addEventListener('pointerdown',e=>{
    cv.setPointerCapture(e.pointerId);
    const nm=toNorm(e);let idx=nearest(nm);
    if(idx===null){
      curves[cvCh].push([...nm]);
      curves[cvCh].sort((a,b2)=>a[0]-b2[0]);
      idx=curves[cvCh].findIndex(([x,y])=>Math.abs(x-nm[0])<.001&&Math.abs(y-nm[1])<.001);
    }
    drag=idx;drawCurve();isDirty=true;e.preventDefault();
  },{passive:false});
  cv.addEventListener('pointermove',e=>{
    if(drag===null)return;
    const nm=toNorm(e);
    curves[cvCh][drag]=[...nm];
    curves[cvCh].sort((a,b2)=>a[0]-b2[0]);
    drag=curves[cvCh].findIndex(([x,y])=>Math.abs(x-nm[0])<.001&&Math.abs(y-nm[1])<.001);
    drawCurve();isDirty=true;scheduleRender();
  },{passive:true});
  cv.addEventListener('pointerup',()=>{drag=null});
  cv.addEventListener('dblclick',e=>{
    const idx=nearest(toNorm(e));
    if(idx!==null&&curves[cvCh].length>2){curves[cvCh].splice(idx,1);drawCurve();isDirty=true;scheduleRender();}
  });
})();

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   REGION BLUR TOOL
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function setBlurShape(s){
  blurShape=s;
  ['circle','rect','gradient'].forEach(sh=>{
    const el=$('bsc-'+sh);if(!el)return;
    const on=sh===s;
    el.style.border=on?'1.5px solid var(--red)':'1.5px solid var(--b1)';
    el.style.background=on?'var(--reda)':'var(--s1)';
    const lbl=el.querySelector('div:last-child');if(lbl)lbl.style.color=on?'var(--t1)':'var(--t3)';
  });
}
function buildBlurRegionsList(){
  const el=$('blur-regions-list');if(!el)return;
  if(!blurRegions.length){el.innerHTML='<div style="font-size:9.5px;color:var(--t3);padding:5px 0">'+(L==='ja'?'„Ç®„É™„Ç¢„Å™„Åó':'No areas applied')+'</div>';return;}
  el.innerHTML=blurRegions.map((r,i)=>`<div style="display:flex;align-items:center;justify-content:space-between;padding:7px 9px;background:var(--s1);border:1.5px solid var(--b1);border-radius:var(--rs);margin-bottom:4px;font-size:9.5px;color:var(--t2)"><span>${r.shape==='circle'?'‚≠ï':r.shape==='rect'?'‚¨ú':'üå´Ô∏è'} #${i+1} ¬∑ F${r.str}</span><button onclick="removeBlurRegion(${i})" style="background:none;border:1px solid var(--b2);color:var(--t3);font-size:10px;padding:2px 7px;cursor:pointer;border-radius:4px">‚úï</button></div>`).join('');
}
function removeBlurRegion(i){blurRegions.splice(i,1);isDirty=true;scheduleRender();buildBlurRegionsList()}
function startBlurSel(){
  if(!srcImg)return;
  blurSelActive=true;
  const area=$('preview-area');
  $('blur-sel').style.display='block';
  const selCv=$('blur-sel-cv');
  selCv.width=area.clientWidth;selCv.height=area.clientHeight;
  const ctx=selCv.getContext('2d');
  ctx.clearRect(0,0,selCv.width,selCv.height);
  let dragging=false,sx=0,sy=0;
  function gp(e){const r=selCv.getBoundingClientRect();return{x:(e.clientX??e.touches?.[0]?.clientX??0)-r.left,y:(e.clientY??e.touches?.[0]?.clientY??0)-r.top};}
  selCv.onpointerdown=e=>{dragging=true;const p=gp(e);sx=p.x;sy=p.y;selCv.setPointerCapture(e.pointerId);e.preventDefault();};
  selCv.onpointermove=e=>{
    if(!dragging)return;const p=gp(e);const ex=p.x,ey=p.y;
    ctx.clearRect(0,0,selCv.width,selCv.height);
    ctx.strokeStyle='rgba(200,0,10,.9)';ctx.lineWidth=2;ctx.setLineDash([6,3]);ctx.fillStyle='rgba(200,0,10,.09)';
    if(blurShape==='circle'){const r=Math.hypot(ex-sx,ey-sy);ctx.beginPath();ctx.arc(sx,sy,r,0,Math.PI*2);ctx.stroke();ctx.fill();ctx.strokeStyle='rgba(200,0,10,.3)';ctx.setLineDash([]);ctx.beginPath();ctx.arc(sx,sy,r*0.5,0,Math.PI*2);ctx.stroke();}
    else if(blurShape==='rect'){ctx.beginPath();ctx.rect(sx,sy,ex-sx,ey-sy);ctx.stroke();ctx.fill();}
    else{const top=Math.min(sy,ey),h=Math.abs(ey-sy);ctx.beginPath();ctx.rect(0,top,selCv.width,h);ctx.stroke();ctx.fill();}
  };
  selCv.onpointerup=e=>{
    if(!dragging)return;dragging=false;
    const p=gp(e);const ex=p.x,ey=p.y;
    const cvEl=$('prev-cv');const cvR=cvEl.getBoundingClientRect();
    const sxcv=(sx-cvR.left)/vpZoom,sycv=(sy-cvR.top)/vpZoom;
    let region;
    if(blurShape==='circle'){const rad=Math.hypot(ex-sx,ey-sy)/vpZoom;if(rad<5){ctx.clearRect(0,0,selCv.width,selCv.height);return;}region={x:sxcv,y:sycv,rx:rad,ry:rad,str:adj.blurRadius||25,feather:adj.blurFeather||50,shape:'circle'};}
    else if(blurShape==='rect'){const rw2=Math.abs(ex-sx)/vpZoom,rh2=Math.abs(ey-sy)/vpZoom;if(rw2<5||rh2<5){ctx.clearRect(0,0,selCv.width,selCv.height);return;}region={x:sxcv+Math.sign(ex-sx)*rw2/2,y:sycv+Math.sign(ey-sy)*rh2/2,rx:rw2/2,ry:rh2/2,str:adj.blurRadius||25,feather:adj.blurFeather||50,shape:'rect'};}
    else{const bh=Math.abs(ey-sy)/vpZoom;region={x:0,y:sycv+(ey>sy?bh/2:-bh/2),rx:selCv.width,ry:bh/2,str:adj.blurRadius||25,feather:adj.blurFeather||50,shape:'gradient'};}
    blurRegions.push(region);isDirty=true;scheduleRender();buildBlurRegionsList();
    ctx.clearRect(0,0,selCv.width,selCv.height);
  };
  selCv.ondblclick=()=>stopBlurSel();
}
function stopBlurSel(){
  blurSelActive=false;
  const ovl=$('blur-sel');ovl.style.display='none';
  const selCv=$('blur-sel-cv');
  selCv.onpointerdown=null;selCv.onpointermove=null;selCv.onpointerup=null;selCv.ondblclick=null;
}
function clearBlurRegions(){blurRegions=[];isDirty=true;scheduleRender()}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   IMAGE LOAD
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function onPreviewClick(){if(!srcImg)triggerOpen()}
function triggerOpen(){$('fi').click()}
function onFI(e){const f=e.target.files[0];if(f)loadFile(f);e.target.value=''}

function loadFile(f){
  if(!f)return;
  const url=URL.createObjectURL(f);
  const ext=getExt(f.name);
  isRawFile=isSpecial(f);
  const img=new Image();
  img.onload=()=>{
    srcImg=img;isDirty=false;
    // Badge
    const badge=$('raw-badge');
    if(badge){
      const showBadge=['raw','cr2','cr3','nef','arw','orf','rw2','dng','heic','heif','avif','tiff','tif'].includes(ext);
      badge.style.display=showBadge?'inline-block':'none';
      badge.textContent=ext.toUpperCase();
    }
    const ph=$('ph');
    ph.style.transition='opacity .25s';ph.style.opacity='0';
    setTimeout(()=>{ph.style.display='none'},250);
    $('cv-viewport').style.display='block';
    $('preview-area').classList.add('has-img');
    $('bot').style.display='flex';
    $('exp-hbtn').style.display='';
    $('checker').style.display='block';
    $('zoom-ctrls').style.display='flex';
    vpZoom=1;vpPanX=0;vpPanY=0;
    imgMeta={name:f.name,size:(f.size/1024).toFixed(1)+' KB',type:f.type||ext.toUpperCase(),w:img.naturalWidth,h:img.naturalHeight,mp:((img.naturalWidth*img.naturalHeight)/1e6).toFixed(2),ar:(img.naturalWidth/img.naturalHeight).toFixed(3),totalPx:(img.naturalWidth*img.naturalHeight).toLocaleString()};
    rw=img.naturalWidth;rh=img.naturalHeight;
    $('rw').value=rw;$('rh').value=rh;
    if(isRawFile&&curMode==='pro')buildAllSliders();
    requestAnimationFrame(()=>requestAnimationFrame(()=>{scheduleRender();buildInfo();buildRes()}));
  };
  img.onerror=()=>{URL.revokeObjectURL(url);};
  img.src=url;
}

// Drag & Drop
const prevArea=$('preview-area');
['dragenter','dragover'].forEach(ev=>prevArea.addEventListener(ev,e=>{e.preventDefault();e.stopPropagation();prevArea.classList.add('dragover')}));
['dragleave','dragend'].forEach(ev=>prevArea.addEventListener(ev,e=>{e.preventDefault();prevArea.classList.remove('dragover')}));
prevArea.addEventListener('drop',e=>{e.preventDefault();e.stopPropagation();prevArea.classList.remove('dragover');const f=e.dataTransfer.files[0];if(f)loadFile(f)});
window.addEventListener('dragover',e=>e.preventDefault());
window.addEventListener('drop',e=>{e.preventDefault();const f=e.dataTransfer.files[0];if(f)loadFile(f)});

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   TABS & MODE
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function sw(id){
  curPanel=id;
  document.querySelectorAll('.tab').forEach(t=>t.classList.toggle('active',t.dataset.tab===id));
  document.querySelectorAll('.panel').forEach(p=>p.classList.toggle('on',p.id==='panel-'+id));
  if(id==='color')requestAnimationFrame(drawCurve);
  if(id==='tone')requestAnimationFrame(drawHistogram);
}
function setMode(mode){
  curMode=mode;
  $('mb-easy').classList.toggle('on',mode==='easy');
  $('mb-pro').classList.toggle('on',mode==='pro');
  document.querySelectorAll('.tab').forEach(t=>{
    const m=t.dataset.m;
    t.style.display=(m===undefined||m===mode)?'':'none';
  });
  if(mode==='easy')sw('efilter');else sw('tone');
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   MOBILE RESIZE
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
(()=>{
  const h=$('mob-resize');if(!h)return;
  let drag=false,startY=0,startH=0;
  function startDrag(y){
    if(window.innerWidth>=768)return;
    drag=true;startY=y;startH=document.getElementById('preview-area').clientHeight;
    h.classList.add('active');
  }
  function moveDrag(y){
    if(!drag||window.innerWidth>=768)return;
    const newH=Math.max(100,Math.min(window.innerHeight*0.82,startH+(y-startY)));
    document.documentElement.style.setProperty('--mobile-prev',newH+'px');
    if(srcImg)scheduleRender();
  }
  function endDrag(){drag=false;h.classList.remove('active');}
  // Pointer events (modern)
  h.addEventListener('pointerdown',e=>{startDrag(e.clientY);h.setPointerCapture(e.pointerId);e.preventDefault();},{passive:false});
  h.addEventListener('pointermove',e=>{moveDrag(e.clientY);},{passive:true});
  h.addEventListener('pointerup',endDrag);h.addEventListener('pointercancel',endDrag);
  // Touch fallback (Safari iOS)
  h.addEventListener('touchstart',e=>{startDrag(e.touches[0].clientY);e.preventDefault();},{passive:false});
  document.addEventListener('touchmove',e=>{if(drag)moveDrag(e.touches[0].clientY);},{passive:true});
  document.addEventListener('touchend',endDrag);
})();

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   DESKTOP SPLIT
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
(()=>{
  const h=$('split-handle');if(!h)return;
  let drag=false;
  h.addEventListener('mousedown',e=>{drag=true;h.classList.add('drag');e.preventDefault()});
  document.addEventListener('mousemove',e=>{
    if(!drag)return;
    const r=$('app').getBoundingClientRect();
    const p=Math.max(18,Math.min(75,((e.clientX-r.left)/r.width)*100));
    document.documentElement.style.setProperty('--split',p+'%');
    if(srcImg)scheduleRender();
  });
  document.addEventListener('mouseup',()=>{drag=false;h.classList.remove('drag')});
  function pos(){const lp=$('left-pane');if(lp)h.style.left=(lp.getBoundingClientRect().right-4)+'px'}
  const lp=$('left-pane');if(lp)new ResizeObserver(pos).observe(lp);
})();

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   MOSAIC / ROTATE / CROP
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const MOS=[4,8,16,32,64];
function buildMosaicGrid(){
  const el=$('mos-grid');if(!el)return;
  el.innerHTML=MOS.map(s=>`<div class="mos-card${mosaicSize===s?' on':''}" onclick="setMosaic(${s})"><div class="mos-sz">${s}px</div><div class="mos-lbl">${s<=4?(L==='ja'?'Á¥∞':'Fine'):s<=16?(L==='ja'?'‰∏≠':'Med'):(L==='ja'?'Á≤ó':'Coarse')}</div></div>`).join('');
}
function setMosaic(s){mosaicSize=s;isDirty=true;buildMosaicGrid();scheduleRender()}
function clearMosaic(){mosaicSize=0;buildMosaicGrid();scheduleRender()}
function doRotate(d){rotDeg=(rotDeg+d+360)%360;isDirty=true;scheduleRender()}
function doFlipH(){fH=!fH;isDirty=true;scheduleRender()}
function doFlipV(){fV=!fV;isDirty=true;scheduleRender()}
function pickCrop(el){document.querySelectorAll('.crop-card').forEach(c=>c.classList.remove('on'));el.classList.add('on')}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   RESET
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function resetAdj(){
  adj={...DEF};rotDeg=0;fH=false;fV=false;mosaicSize=0;blurRegions=[];
  activeFilterId=null;filterIntensity=100;isDirty=false;
  curves.L=[[0,0],[.25,.25],[.5,.5],[.75,.75],[1,1]];
  curves.R=[[0,0],[.5,.5],[1,1]];curves.G=[[0,0],[.5,.5],[1,1]];curves.B=[[0,0],[.5,.5],[1,1]];
  buildAll();scheduleRender();requestAnimationFrame(drawCurve);
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   RESOLUTION
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const RP=[
  {l:'Instagram Square',w:1080,h:1080,cat:'SNS'},{l:'Instagram Portrait',w:1080,h:1350,cat:'SNS'},
  {l:'Instagram Landscape',w:1080,h:566,cat:'SNS'},{l:'Story / Reel',w:1080,h:1920,cat:'SNS'},
  {l:'X Post',w:1200,h:675,cat:'SNS'},{l:'X Banner',w:1500,h:500,cat:'SNS'},
  {l:'Facebook OG',w:1200,h:630,cat:'SNS'},{l:'YouTube Thumb',w:1280,h:720,cat:'SNS'},
  {l:'TikTok',w:1080,h:1920,cat:'SNS'},
  {l:'HD',w:1280,h:720,cat:'HD'},{l:'Full HD',w:1920,h:1080,cat:'HD'},
  {l:'2K QHD',w:2560,h:1440,cat:'HD'},{l:'4K UHD',w:3840,h:2160,cat:'HD'},{l:'8K',w:7680,h:4320,cat:'HD'},
  {l:'A4 Ê®™',w:3508,h:2480,cat:'Print'},{l:'A4 Á∏¶',w:2480,h:3508,cat:'Print'},
  {l:'A3 Ê®™',w:4961,h:3508,cat:'Print'},{l:'A3 Á∏¶',w:3508,h:4961,cat:'Print'},
  {l:'Square 1K',w:1000,h:1000,cat:'Square'},{l:'Square 2K',w:2000,h:2000,cat:'Square'},{l:'Square 4K',w:4000,h:4000,cat:'Square'},
];
function buildRes(){
  const el=$('rp-list');if(!el)return;
  const cats=[...new Set(RP.map(r=>r.cat))];
  el.innerHTML=cats.map(cat=>`<div class="rp-cat">${T('rp',cat)||cat}</div>`+
    RP.filter(r=>r.cat===cat).map(r=>`<div class="rp-item${rw===r.w&&rh===r.h?' on':''}" onclick="pickRP(this,${r.w},${r.h})"><span class="rp-nm">${r.l}</span><span class="rp-dim">${r.w}√ó${r.h}</span></div>`).join('')).join('');
}
function pickRP(el,w,h){document.querySelectorAll('.rp-item').forEach(r=>r.classList.remove('on'));el.classList.add('on');rw=w;rh=h;$('rw').value=w;$('rh').value=h;buildInfo()}
function onResChange(){rw=+$('rw').value||1080;rh=+$('rh').value||1080;document.querySelectorAll('.rp-item').forEach(r=>r.classList.remove('on'));buildInfo()}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   PRESETS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function showPI(){$('pi-box').style.display='block';setTimeout(()=>$('pi-name').focus(),30)}
function hidePI(){$('pi-box').style.display='none';$('pi-name').value=''}
function savePreset(){
  const n=$('pi-name').value.trim();if(!n)return;
  myPresets.push({id:Date.now(),name:n,adj:{...adj},curves:JSON.parse(JSON.stringify(curves)),rot:rotDeg,fH,fV});
  try{localStorage.setItem('lens_v9',JSON.stringify(myPresets))}catch(e){}
  hidePI();buildPresets();
}
function delPreset(id){myPresets=myPresets.filter(p=>p.id!==id);try{localStorage.setItem('lens_v9',JSON.stringify(myPresets))}catch(e){}buildPresets()}
function applyPreset(id){
  const bp=FILTERS.find(f=>f.id===id);
  if(bp){adj={...DEF,...bp.adj};isDirty=true;buildAll();scheduleRender();return}
  const p=myPresets.find(x=>x.id===id);if(!p)return;
  adj={...p.adj};if(p.curves)Object.assign(curves,JSON.parse(JSON.stringify(p.curves)));
  rotDeg=p.rot||0;fH=!!p.fH;fV=!!p.fV;isDirty=true;
  buildAll();scheduleRender();drawCurve();sw('tone');
}
function buildPresets(){
  const el=$('preset-list');if(!el)return;
  let html=`<div class="pnl-ttl" style="margin-bottom:7px;font-size:7px">${T('builtin')}</div>`;
  html+=FILTERS.map(f=>`<div class="pc builtin"><div class="pc-info"><div class="pc-nm">${f.ic} ${L==='en'&&f.nEn?f.nEn:f.nm}</div></div><button class="app-btn" onclick="applyPreset('${f.id}')">${T('apply')}</button></div>`).join('');
  if(myPresets.length){
    html+=`<div class="pnl-ttl" style="margin-top:14px;margin-bottom:7px;font-size:7px">${T('myPresets')}</div>`;
    html+=myPresets.map(p=>{
      const meta=Object.entries(p.adj).filter(([,v])=>v!==0).slice(0,3).map(([k,v])=>`${k}:${v>0?'+':''}${v}`).join(' ¬∑ ')||'DEFAULT';
      return`<div class="pc"><div class="pc-info"><div class="pc-nm">${p.name}</div><div class="pc-meta">${meta}</div></div><button class="app-btn" onclick="applyPreset(${p.id})">${T('apply')}</button><button class="del-btn" onclick="delPreset(${p.id})">${T('del')}</button></div>`;
    }).join('');
  }else{
    html+=`<div class="empty" style="padding:18px 0"><div class="e-ring"><div class="e-dot"></div></div><div class="e-ttl">${T('noPresets')}</div><div class="e-sub">${T('noPresetsSub')}</div></div>`;
  }
  el.innerHTML=html;
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   INFO
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function toggleInfoSec(id){$('ish-'+id).classList.toggle('op');$('isb-'+id).classList.toggle('op')}
function buildInfo(){
  const el=$('info-body');if(!el||!imgMeta)return;
  const rows=[['file',imgMeta.name],['size',imgMeta.size],['type',imgMeta.type],['w',imgMeta.w+' px'],['h',imgMeta.h+' px'],['mp',imgMeta.mp],['ar',imgMeta.ar+':1'],['outW',rw+' px'],['outH',rh+' px']];
  const active=Object.entries(adj).filter(([,v])=>v!==0);
  el.innerHTML=rows.map(([k,v])=>`<div class="info-r"><span class="info-k">${T('infoKeys',k)}</span><span class="info-v">${v}</span></div>`).join('')+
  `<div class="info-sec">
    <div class="info-sh" id="ish-tech" onclick="toggleInfoSec('tech')"><span class="info-st">${T('techTitle')}</span><span class="info-ch">‚ñæ</span></div>
    <div class="info-sb" id="isb-tech">
      <div class="idr"><span class="idk">ZOOM</span><span class="idv">${Math.round(lastZoom*100)}%</span></div>
      <div class="idr"><span class="idk">ROTATION</span><span class="idv">${rotDeg}¬∞${fH?' +FH':''}${fV?' +FV':''}</span></div>
      <div class="idr"><span class="idk">BLUR REGIONS</span><span class="idv">${blurRegions.length}</span></div>
    </div>
  </div>
  <div class="info-sec">
    <div class="info-sh" id="ish-adj" onclick="toggleInfoSec('adj')"><span class="info-st">${T('adjTitle')}</span><span class="info-ch">‚ñæ</span></div>
    <div class="info-sb" id="isb-adj">
      ${active.length?active.map(([k,v])=>`<div class="idr"><span class="idk">${k}</span><span class="idv r">${v>0?'+':''}${v}</span></div>`).join(''):`<div class="idr"><span class="idk">${T('noneAdj')}</span></div>`}
    </div>
  </div>`;
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   EXPORT
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function openExport(){if(!srcImg)return;$('exp-modal').classList.add('op')}
function closeExport(){$('exp-modal').classList.remove('op')}
function pickFmt(el,fmt){document.querySelectorAll('.fmt-opt').forEach(e=>e.classList.remove('on'));el.classList.add('on');exportFmt=fmt}

function doExport(){
  if(!srcImg)return;closeExport();
  const cv=$('offscreen');
  cv.width=rw;cv.height=rh;
  const ctx=cv.getContext('2d');
  const transp=exportFmt==='transparent';
  if(!transp){ctx.fillStyle='#fff';ctx.fillRect(0,0,rw,rh)}
  ctx.save();ctx.translate(rw/2,rh/2);
  const ang=(rotDeg+adj.angle)*Math.PI/180;if(ang)ctx.rotate(ang);
  if(fH)ctx.scale(-1,1);if(fV)ctx.scale(1,-1);
  if(adj.perspH||adj.perspV){ctx.transform(1,adj.perspV/500,adj.perspH/500,1,0,0);}
  const bri=Math.max(0,1+(adj.brightness+(adj.rawExp||0)*0.5)/100);
  const con=Math.max(0.01,1+adj.contrast/100);
  const sat=Math.max(0,1+(adj.saturation+(adj.rawSat||0)*0.5)/100);
  const blrF=adj.blur>0?`blur(${(adj.blur*0.3).toFixed(2)}px)`:'';
  const hueF=adj.hue!==0?`hue-rotate(${adj.hue}deg)`:'';
  ctx.filter=[`brightness(${bri})`,`contrast(${con})`,`saturate(${sat})`,blrF,hueF].filter(Boolean).join(' ');
  ctx.drawImage(srcImg,-rw/2,-rh/2,rw,rh);ctx.restore();ctx.filter='none';
  // Pixel ops (same as render)
  const exposure=(adj.exposure||0)+(adj.rawExp||0);
  const temperature=(adj.temperature||0)+(adj.rawWB||0);
  const tint=(adj.tint||0)+(adj.rawTint||0);
  const vibrance=(adj.vibrance||0)+((adj.rawSat||0)*0.5);
  const hslActive2=HSL_COLS.some(c=>adj['hH_'+c]||adj['hS_'+c]||adj['hL_'+c]);
  const crvActive2=curvesActive();
  const needPx=exposure||temperature||tint||crvActive2||adj.highlights||adj.shadows||adj.blacks||adj.whites||adj.grain||vibrance||adj.clarity||adj.warmShadows||adj.coolHighlights||adj.dehaze||adj.noise||adj.noiseC||adj.chrAb||hslActive2||adj.rr||adj.rg||adj.rb||adj.gr||adj.gg||adj.gb||adj.br||adj.bg2||adj.bb;
  if(needPx){
    const lutLE=crvActive2?buildCurveLUT(curves.L):null;
    const lutRE=crvActive2?buildCurveLUT(curves.R):null;
    const lutGE=crvActive2?buildCurveLUT(curves.G):null;
    const lutBE=crvActive2?buildCurveLUT(curves.B):null;
    const id=ctx.getImageData(0,0,rw,rh);const d=id.data;const n=d.length;
    const expMul=exposure?Math.pow(2,exposure/100):1;
    const hiB=adj.highlights/300,shB=adj.shadows/300,blkB=adj.blacks/200,whtB=adj.whites/200;
    const wshB=(adj.warmShadows||0)/300,chlB=(adj.coolHighlights||0)/300;
    const dehV=(adj.dehaze||0)/100;const clarV=(adj.clarity||0)/200;
    for(let i=0;i<n;i+=4){
      let r=d[i],g=d[i+1],b=d[i+2];
      if(expMul!==1){r*=expMul;g*=expMul;b*=expMul;}
      if(temperature>0){r+=temperature*0.5;b-=temperature*0.25;}else if(temperature<0){b+=(-temperature)*0.5;r-=(-temperature)*0.25;}
      if(tint>0)g+=tint*0.35;else if(tint<0){r+=(-tint)*0.25;b+=(-tint)*0.25;}
      const lum=(0.299*r+0.587*g+0.114*b)/255;
      if(adj.highlights&&lum>0.5){const s2=((lum-0.5)/0.5)*hiB;r+=r*s2;g+=g*s2;b+=b*s2;}
      if(adj.shadows&&lum<0.5){const s2=((0.5-lum)/0.5)*shB;r+=r*s2;g+=g*s2;b+=b*s2;}
      if(adj.whites&&lum>0.75){const s2=((lum-0.75)/0.25)*whtB;r+=r*s2;g+=g*s2;b+=b*s2;}
      if(adj.blacks&&lum<0.25){const s2=((0.25-lum)/0.25)*blkB;r-=r*s2;g-=g*s2;b-=b*s2;}
      if(vibrance){const mx=Math.max(r,g,b);const mn2=Math.min(r,g,b);const curSat=mx>0?(mx-mn2)/mx:0;const boost=(vibrance/100)*(1-curSat)*0.6;const avg=(r+g+b)/3;r+=(r-avg)*boost;g+=(g-avg)*boost;b+=(b-avg)*boost;}
      if(clarV&&lum>0.05&&lum<0.95){const avg2=(r+g+b)/3/255;const diff=(avg2-lum)*clarV;r+=diff*r;g+=diff*g;b+=diff*b;}
      if(wshB&&lum<0.5){const s2=((0.5-lum)/0.5)*wshB;r+=s2*30;b-=s2*15;}
      if(chlB&&lum>0.5){const s2=((lum-0.5)/0.5)*chlB;b+=s2*25;r-=s2*12;}
      if(dehV){const h=dehV*0.15;r-=h*255*(1-lum);g-=h*255*(1-lum);b-=h*255*(1-lum);}
      if(adj.grain){const n2=(Math.random()-.5)*adj.grain*0.7;r+=n2;g+=n2;b+=n2;}
      if(adj.noise){const nAmt=(Math.random()-.5)*adj.noise*1.2;r+=nAmt;g+=nAmt;b+=nAmt;}
      if(adj.noiseC){r+=(Math.random()-.5)*adj.noiseC*1.0;g+=(Math.random()-.5)*adj.noiseC*1.0;b+=(Math.random()-.5)*adj.noiseC*1.0;}
      if(adj.chrAb){const lum2=(0.299*r+0.587*g+0.114*b)/255;const ca=adj.chrAb*0.3;r+=ca*(lum2-.5);b-=ca*(lum2-.5);}
      if(adj.rr||adj.rg||adj.rb||adj.gr||adj.gg||adj.gb||adj.br||adj.bg2||adj.bb){
        const nr=r+(adj.rr/100)*r+(adj.rg/100)*g+(adj.rb/100)*b;
        const ng=g+(adj.gr/100)*r+(adj.gg/100)*g+(adj.gb/100)*b;
        const nb=b+(adj.br/100)*r+(adj.bg2/100)*g+(adj.bb/100)*b;
        r=nr;g=ng;b=nb;
      }
      // Apply RGB curves (export)
      if(crvActive2){
        const rie=Math.max(0,Math.min(255,Math.round(r)));
        const gie=Math.max(0,Math.min(255,Math.round(g)));
        const bie=Math.max(0,Math.min(255,Math.round(b)));
        r=lutLE[lutRE[rie]];g=lutLE[lutGE[gie]];b=lutLE[lutBE[bie]];
      }
      // HSL per-channel (export)
      if(hslActive2){
        const rn=r/255,gn=g/255,bn=b/255;
        const mx=Math.max(rn,gn,bn),mn=Math.min(rn,gn,bn),d2e=mx-mn;
        if(d2e>0.01){
          let h6;
          if(mx===rn)h6=((gn-bn)/d2e+6)%6;
          else if(mx===gn)h6=(bn-rn)/d2e+2;
          else h6=(rn-gn)/d2e+4;
          const h=h6/6;
          const hCols=['Red','Orange','Yellow','Green','Aqua','Blue','Purple','Magenta'];
          const hCenters=[0,1/8,2/8,3/8,4/8,5/8,6/8,7/8];
          let maxW=0,bestCol='';
          for(let ci=0;ci<8;ci++){let diff=Math.abs(h-hCenters[ci]);if(diff>0.5)diff=1-diff;const w=Math.max(0,1-diff*8);if(w>maxW){maxW=w;bestCol=hCols[ci];}}
          if(maxW>0.05){
            const hShift=adj['hH_'+bestCol]||0,sShift=adj['hS_'+bestCol]||0,lShift=adj['hL_'+bestCol]||0;
            if(hShift||sShift||lShift){
              const le=(mx+mn)/2,s2e=d2e/(1-Math.abs(2*le-1));
              const newH=((h6/6)+(hShift/360)+1)%1,newS=Math.max(0,Math.min(1,s2e*(1+sShift/100))),newLe=Math.max(0,Math.min(1,le+lShift/200));
              const c2e=newS*(1-Math.abs(2*newLe-1)),x2e=c2e*(1-Math.abs((newH*6)%2-1)),m2e=newLe-c2e/2;
              let r2e=0,g2e=0,b2e=0;const h2e=newH*6;
              if(h2e<1){r2e=c2e;g2e=x2e;}else if(h2e<2){r2e=x2e;g2e=c2e;}else if(h2e<3){g2e=c2e;b2e=x2e;}
              else if(h2e<4){g2e=x2e;b2e=c2e;}else if(h2e<5){r2e=x2e;b2e=c2e;}else{r2e=c2e;b2e=x2e;}
              r=((r2e+m2e)*maxW+(rn*(1-maxW)))*255;g=((g2e+m2e)*maxW+(gn*(1-maxW)))*255;b=((b2e+m2e)*maxW+(bn*(1-maxW)))*255;
            }
          }
        }
      }
      d[i]=clamp(r);d[i+1]=clamp(g);d[i+2]=clamp(b);
    }
    ctx.putImageData(id,0,0);
  }
  /* Sharpness */
  if(adj.sharpness>0){
    const amt=adj.sharpness/100*1.5;
    const tmp2=document.createElement('canvas');tmp2.width=rw;tmp2.height=rh;
    const tc2=tmp2.getContext('2d');
    tc2.filter=`blur(1px)`;tc2.drawImage(cv,0,0);
    const src3=ctx.getImageData(0,0,rw,rh);
    const blr2=tc2.getImageData(0,0,rw,rh);
    const sd2=src3.data,bd2=blr2.data;
    for(let i=0;i<sd2.length;i+=4){
      sd2[i]=clamp(sd2[i]+(sd2[i]-bd2[i])*amt);
      sd2[i+1]=clamp(sd2[i+1]+(sd2[i+1]-bd2[i+1])*amt);
      sd2[i+2]=clamp(sd2[i+2]+(sd2[i+2]-bd2[i+2])*amt);
    }
    ctx.putImageData(src3,0,0);
  }
  if(mosaicSize>0){
    for(let y=0;y<rh;y+=mosaicSize)for(let x=0;x<rw;x+=mosaicSize){
      const px=ctx.getImageData(x,y,1,1).data;
      ctx.fillStyle=`rgb(${px[0]},${px[1]},${px[2]})`;ctx.fillRect(x,y,mosaicSize,mosaicSize);
    }
  }
  if(adj.vignette>0&&!transp){
    const vg=ctx.createRadialGradient(rw/2,rh/2,0,rw/2,rh/2,Math.hypot(rw,rh)*0.55);
    vg.addColorStop(Math.max(0,1-adj.vignette/100*0.65),'rgba(0,0,0,0)');
    vg.addColorStop(1,`rgba(0,0,0,${adj.vignette/100*0.88})`);
    ctx.fillStyle=vg;ctx.fillRect(0,0,rw,rh);
  }
  if(adj.fade>0){ctx.fillStyle=`rgba(255,255,255,${adj.fade/100*0.4})`;ctx.fillRect(0,0,rw,rh)}
  const mime=transp||exportFmt==='png'?'image/png':exportFmt==='webp'?'image/webp':'image/jpeg';
  const ext2=transp||exportFmt==='png'?'png':exportFmt==='webp'?'webp':'jpg';
  const a=document.createElement('a');a.download=`lens_${Date.now()}.${ext2}`;
  a.href=cv.toDataURL(mime,mime==='image/jpeg'?.94:undefined);a.click();isDirty=false;
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   HOME / CONFIRM
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function goHome(){
  if(!srcImg)return;
  if(isDirty){$('confirm').classList.add('op');return}
  doGoHome();
}
function closeConfirm(){$('confirm').classList.remove('op')}
function confirmGoHome(){closeConfirm();doGoHome()}
function doGoHome(){
  srcImg=null;isDirty=false;mosaicSize=0;activeFilterId=null;filterIntensity=100;isRawFile=false;blurRegions=[];
  adj={...DEF};rotDeg=0;fH=false;fV=false;
  curves.L=[[0,0],[.25,.25],[.5,.5],[.75,.75],[1,1]];curves.R=[[0,0],[.5,.5],[1,1]];curves.G=[[0,0],[.5,.5],[1,1]];curves.B=[[0,0],[.5,.5],[1,1]];
  $('cv-viewport').style.display='none';
  $('zoom-ctrls').style.display='none';
  const cv=$('prev-cv');
  try{const c=cv.getContext('2d');if(c)c.clearRect(0,0,cv.width,cv.height)}catch(e){}
  vpZoom=1;vpPanX=0;vpPanY=0;
  $('preview-area').classList.remove('has-img');
  const ph=$('ph');ph.style.display='';ph.style.opacity='1';ph.style.transition='';
  $('checker').style.display='none';$('bot').style.display='none';$('exp-hbtn').style.display='none';
  const badge=$('raw-badge');if(badge)badge.style.display='none';
  $('zoom-badge').style.display='none';
  const rawSec=$('raw-sec');if(rawSec)rawSec.remove();
  buildAll();
  if(curMode==='easy')sw('efilter');else sw('tone');
}

window.addEventListener('beforeunload',e=>{if(isDirty&&srcImg){e.preventDefault();e.returnValue=''}});

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   HELP
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function openHelp(){$('help-modal').classList.add('op');buildHelp()}
function closeHelp(){$('help-modal').classList.remove('op')}
function buildHelp(){
  const el=$('help-content');if(!el)return;
  const steps=TX[L].helpSteps;
  el.innerHTML=steps.map(s=>`<div class="help-step"><div class="help-num">${s.n}</div><div><div class="help-ttl">${s.t}</div><div class="help-desc">${s.d}</div></div></div>`).join('')+
  `<div style="margin-top:14px;padding:12px;background:var(--s2);border:1px solid var(--b2);border-radius:var(--rs)">
    <div style="font-size:7.5px;font-weight:700;letter-spacing:1.5px;color:var(--red);margin-bottom:5px">üí° TIPS</div>
    <div style="font-size:10px;color:var(--t2);line-height:1.7">${L==='ja'?'„Éª„Çπ„É©„Ç§„ÉÄ„ÉºÂÄ§„Çí„Çø„ÉÉ„Éó„Åô„Çã„Å®Êï∞ÂÄ§ÂÖ•Âäõ„Åß„Åç„Åæ„Åô<br>„Éª„Éó„É™„Çª„ÉÉ„Éà‰øùÂ≠ò„Åß„ÅäÊ∞ó„Å´ÂÖ•„Çä„ÅÆË®≠ÂÆö„ÇíË®òÈå≤<br>„ÉªÁØÑÂõ≤„Åº„Åã„Åó„Åß„Éù„Éº„Éà„É¨„Éº„Éà„ÅÆËÉåÊôØ„Çí„Åº„Åã„Åõ„Åæ„Åô':'„ÉªTap a slider value to type a number directly<br>„ÉªSave presets to remember favorite looks<br>„ÉªUse region blur to blur portrait backgrounds'}</div>
  </div>`;
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   CHEKI
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function applyCheki(s){
  const styles={soft:{brightness:15,contrast:-20,saturation:-5,temperature:8,grain:25,fade:38,vignette:15,highlights:18,shadows:8},warm:{brightness:12,contrast:-15,saturation:5,temperature:20,grain:28,fade:32,vignette:18,highlights:15,shadows:10},cool:{brightness:12,contrast:-18,saturation:-8,temperature:-12,grain:22,fade:35,vignette:14,highlights:16,shadows:8}};
  const st=styles[s];if(!st)return;
  adj={...DEF,...st};isDirty=true;activeFilterId=null;buildAllSliders();scheduleRender();
}


/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   FRAME ENGINE
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let activeFrame='cheki-white';
let frameColor='#ffffff';
let frameThick=60;
let frameCorner='sharp';
let frameCaption='';
let frameCaptionOn=false;

function pickFrame(el){
  document.querySelectorAll('.frame-card').forEach(c=>c.classList.remove('on'));
  el.classList.add('on');
  activeFrame=el.dataset.frame;
  applyFrame();
}
function updateFrameColor(){
  const e=document.getElementById('frame-color');
  if(e)frameColor=e.value;
  // update custom preset card background  
  applyFrame();
}
function setFrameCorner(s){
  frameCorner=s;
  ['sharp','round','oval'].forEach(c=>{
    const b=document.getElementById('corner-'+c);
    if(b)b.classList.toggle('on',c===s);
  });
  applyFrame();
}
function updateFrameCaption(){
  const on=document.getElementById('frame-caption-on');
  const txt=document.getElementById('frame-caption-text');
  frameCaptionOn=on?on.checked:false;
  frameCaption=txt?txt.value:'';
  if(txt)txt.style.display=frameCaptionOn?'block':'none';
  applyFrame();
}
// Frame thickness slider
(function(){
  const hit=document.getElementById('frame-thick-hit');
  if(!hit)return;
  function fromX(cx){
    const bg=hit.querySelector('.sl-track-bg');if(!bg)return 0;
    const r=bg.getBoundingClientRect();
    return Math.max(10,Math.min(200,Math.round(10+(cx-r.left)/r.width*190)));
  }
  function set(cx){
    frameThick=fromX(cx);
    const pct=(frameThick-10)/190*100;
    const fill=document.getElementById('frame-thick-fill');
    const thumb=document.getElementById('frame-thick-thumb');
    const val=document.getElementById('frame-thick-val');
    if(fill)fill.style.width=pct+'%';
    if(thumb)thumb.style.left=pct+'%';
    if(val)val.textContent=frameThick;
    applyFrame();
  }
  let active=false;
  hit.addEventListener('pointerdown',e=>{active=true;hit.setPointerCapture(e.pointerId);set(e.clientX);e.preventDefault();},{passive:false});
  hit.addEventListener('pointermove',e=>{if(!active)return;e.preventDefault();set(e.clientX);},{passive:false});
  hit.addEventListener('pointerup',()=>active=false);
  hit.addEventListener('pointercancel',()=>active=false);
})();

function getFrameConfig(name){
  const configs={
    'cheki-white':{bg:'#ffffff',inner:'rgba(0,0,0,0.05)',thick:60},
    'cheki-black':{bg:'#1a1a1a',inner:'rgba(255,255,255,0.03)',thick:60},
    'cheki-beige':{bg:'#e8d5b7',inner:'rgba(0,0,0,0.04)',thick:60},
    'cheki-pink':{bg:'#fce4ec',inner:'rgba(0,0,0,0.04)',thick:60},
    'cheki-navy':{bg:'#1a3a6a',inner:'rgba(255,255,255,0.04)',thick:60},
    'none':{bg:null,inner:null,thick:0},
    'custom':{bg:frameColor,inner:null,thick:frameThick},
  };
  return configs[name]||configs['cheki-white'];
}

function applyFrame(){
  // Mark frame as dirty for next render
  isDirty=true;
  scheduleRender();
}

// renderFrame is called inside renderCanvas after main image draw
function renderFrame(ctx,W,H){
  if(activeFrame==='none')return;
  const cfg=getFrameConfig(activeFrame);
  if(!cfg.bg)return;
  const t=cfg.thick;
  const bot=activeFrame.startsWith('cheki')?t*2:t; // cheki has thick bottom
  // Draw frame rectangles
  ctx.fillStyle=cfg.bg;
  ctx.fillRect(0,0,W,t);           // top
  ctx.fillRect(0,H-bot,W,bot);     // bottom
  ctx.fillRect(0,t,t,H-t-bot);     // left
  ctx.fillRect(W-t,t,t,H-t-bot);   // right
  // Corner style
  if(frameCorner==='round'||frameCorner==='oval'){
    const r=frameCorner==='oval'?Math.min(W,H)*0.08:12;
    ctx.save();
    ctx.globalCompositeOperation='destination-in';
    ctx.beginPath();
    ctx.roundRect?ctx.roundRect(0,0,W,H,r):ctx.rect(0,0,W,H);
    ctx.fill();
    ctx.restore();
  }
  // Caption on bottom frame
  if(frameCaptionOn&&frameCaption){
    ctx.save();
    const isDark=cfg.bg==='#1a1a1a'||cfg.bg==='#1a3a6a';
    ctx.fillStyle=isDark?'rgba(255,255,255,0.7)':'rgba(0,0,0,0.55)';
    ctx.font=`${Math.max(12,t*0.25)}px Nunito,sans-serif`;
    ctx.textAlign='center';
    ctx.textBaseline='middle';
    ctx.fillText(frameCaption,W/2,H-bot/2);
    ctx.restore();
  }
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   DRAW ENGINE
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let dTool='pen';
let dSize=8;
let dOpacity=1.0;
let dColor='#e03030';
let dFillColor='#ffffff';
let dUseFill=false;
let dHistory=[];
let dCanvas=null;
let dCtx=null;
let dDrawing=false;
let dStartPt=null;
let dSnap=null;

function initDrawCanvas(){
  const area=document.getElementById('preview-area');
  if(!area)return;
  let cv=document.getElementById('draw-cv');
  if(!cv){
    cv=document.createElement('canvas');
    cv.id='draw-cv';
    cv.style.cssText='position:absolute;inset:0;z-index:25;cursor:crosshair;touch-action:none;display:none;pointer-events:none;width:100%;height:100%';
    area.appendChild(cv);
  }
  dCanvas=cv;dCtx=cv.getContext('2d');
  const rect=area.getBoundingClientRect();
  dCanvas.width=Math.round(rect.width);dCanvas.height=Math.round(rect.height);
  attachDrawEvents();
}

function getDPt(e){
  const r=dCanvas.getBoundingClientRect();
  const s=e.touches?e.touches[0]:e;
  return{x:(s.clientX-r.left)*(dCanvas.width/r.width),y:(s.clientY-r.top)*(dCanvas.height/r.height)};
}

function setDStyle(){
  dCtx.strokeStyle=dTool==='eraser'?'rgba(0,0,0,1)':dColor;
  dCtx.fillStyle=dFillColor;
  dCtx.lineWidth=dSize;
  dCtx.globalAlpha=dTool==='eraser'?1:dOpacity;
  dCtx.globalCompositeOperation=dTool==='eraser'?'destination-out':'source-over';
  dCtx.lineCap='round';dCtx.lineJoin='round';
}

function attachDrawEvents(){
  if(!dCanvas)return;
  dCanvas.onpointerdown=dDown;dCanvas.onpointermove=dMove;dCanvas.onpointerup=dUp;dCanvas.onpointercancel=dUp;
}

function dDown(e){
  if(!dCanvas)return;
  dDrawing=true;dCanvas.setPointerCapture(e.pointerId);
  const pt=getDPt(e);dStartPt=pt;setDStyle();
  if(dTool==='pen'||dTool==='brush'||dTool==='eraser'){
    dCtx.beginPath();dCtx.moveTo(pt.x,pt.y);
  } else if(dTool==='text'){
    const txt=prompt(L==='ja'?'„ÉÜ„Ç≠„Çπ„Éà„ÇíÂÖ•Âäõ:':'Enter text:','');
    if(txt){
      setDStyle();dCtx.font=`bold ${dSize*3}px Nunito,sans-serif`;
      dCtx.fillStyle=dColor;dCtx.globalAlpha=dOpacity;
      dCtx.globalCompositeOperation='source-over';
      dCtx.fillText(txt,pt.x,pt.y);
      saveDrawSnap();
    }
    dDrawing=false;return;
  } else {
    dSnap=document.createElement('canvas');
    dSnap.width=dCanvas.width;dSnap.height=dCanvas.height;
    dSnap.getContext('2d').drawImage(dCanvas,0,0);
  }
  e.preventDefault();
}

function dMove(e){
  if(!dDrawing||!dCanvas)return;
  const pt=getDPt(e);setDStyle();
  if(dTool==='pen'||dTool==='eraser'){
    dCtx.lineTo(pt.x,pt.y);dCtx.stroke();dCtx.beginPath();dCtx.moveTo(pt.x,pt.y);
  } else if(dTool==='brush'){
    dCtx.lineWidth=dSize*2;dCtx.globalAlpha=dOpacity*0.35;
    dCtx.lineTo(pt.x,pt.y);dCtx.stroke();dCtx.beginPath();dCtx.moveTo(pt.x,pt.y);
  } else if(dSnap&&dStartPt){
    dCtx.clearRect(0,0,dCanvas.width,dCanvas.height);dCtx.drawImage(dSnap,0,0);setDStyle();
    if(dTool==='line'){
      dCtx.beginPath();dCtx.moveTo(dStartPt.x,dStartPt.y);dCtx.lineTo(pt.x,pt.y);dCtx.stroke();
    } else if(dTool==='rect'){
      const w=pt.x-dStartPt.x,h=pt.y-dStartPt.y;
      if(dUseFill)dCtx.fillRect(dStartPt.x,dStartPt.y,w,h);
      dCtx.strokeRect(dStartPt.x,dStartPt.y,w,h);
    } else if(dTool==='ellipse'){
      const rx=Math.abs(pt.x-dStartPt.x)/2,ry=Math.abs(pt.y-dStartPt.y)/2;
      const cx=(dStartPt.x+pt.x)/2,cy=(dStartPt.y+pt.y)/2;
      dCtx.beginPath();dCtx.ellipse(cx,cy,rx,ry,0,0,Math.PI*2);
      if(dUseFill)dCtx.fill();dCtx.stroke();
    } else if(dTool==='arrow'){
      drawArrow(dCtx,dStartPt,pt);
    }
  }
}

function drawArrow(ctx,from,to){
  const dx=to.x-from.x,dy=to.y-from.y;
  const len=Math.hypot(dx,dy);if(len<2)return;
  const ux=dx/len,uy=dy/len;
  const hw=Math.max(8,dSize*3),hl=Math.max(12,dSize*5);
  ctx.beginPath();ctx.moveTo(from.x,from.y);ctx.lineTo(to.x,to.y);ctx.stroke();
  ctx.save();ctx.translate(to.x,to.y);ctx.rotate(Math.atan2(dy,dx));
  ctx.beginPath();ctx.moveTo(0,0);ctx.lineTo(-hl,-hw/2);ctx.lineTo(-hl,hw/2);ctx.closePath();
  ctx.fillStyle=dColor;ctx.globalAlpha=dOpacity;ctx.fill();ctx.restore();
}

function dUp(){
  if(!dDrawing)return;dDrawing=false;dSnap=null;saveDrawSnap();
}

function saveDrawSnap(){
  if(!dCanvas)return;
  const s=document.createElement('canvas');s.width=dCanvas.width;s.height=dCanvas.height;
  s.getContext('2d').drawImage(dCanvas,0,0);
  dHistory.push(s);if(dHistory.length>40)dHistory.shift();
}

function setDTool(t){
  dTool=t;
  document.querySelectorAll('.drw-b').forEach(b=>b.classList.toggle('on',b.id==='dt-'+t));
  if(dCanvas)dCanvas.style.cursor=t==='eraser'?'cell':'crosshair';
}

function drawUndo(){
  if(!dCanvas||!dCtx)return;
  dHistory.pop();
  if(dHistory.length>0){
    dCtx.clearRect(0,0,dCanvas.width,dCanvas.height);
    dCtx.drawImage(dHistory[dHistory.length-1],0,0);
  } else {
    dCtx.clearRect(0,0,dCanvas.width,dCanvas.height);
  }
}

function drawClear(){
  if(!dCanvas||!dCtx)return;
  dCtx.clearRect(0,0,dCanvas.width,dCanvas.height);dHistory=[];
}

// Draw sliders
(function(){
  function makeDSlider(hitId,fillId,thumbId,valId,min,max,init,onSet){
    const hit=document.getElementById(hitId);if(!hit)return;
    function fromX(cx){const bg=hit.querySelector('.sl-track-bg');if(!bg)return init;const r=bg.getBoundingClientRect();return Math.max(min,Math.min(max,Math.round(min+(cx-r.left)/r.width*(max-min))));}
    function set(cx){
      const v=fromX(cx);onSet(v);
      const pct=(v-min)/(max-min)*100;
      const fill=document.getElementById(fillId),thumb=document.getElementById(thumbId),val=document.getElementById(valId);
      if(fill)fill.style.width=pct+'%';if(thumb)thumb.style.left=pct+'%';
      if(val)val.textContent=(valId==='draw-op-val')?v+'%':v;
    }
    let active=false;
    hit.addEventListener('pointerdown',e=>{active=true;hit.setPointerCapture(e.pointerId);set(e.clientX);e.preventDefault();},{passive:false});
    hit.addEventListener('pointermove',e=>{if(!active)return;e.preventDefault();set(e.clientX);},{passive:false});
    hit.addEventListener('pointerup',()=>active=false);
    hit.addEventListener('pointercancel',()=>active=false);
  }
  makeDSlider('draw-sz-hit','draw-sz-fill','draw-sz-thumb','draw-size-val',1,100,8,v=>dSize=v);
  makeDSlider('draw-op-hit','draw-op-fill','draw-op-thumb','draw-op-val',0,100,100,v=>dOpacity=v/100);
})();

// Color + fill events (defer to avoid null)
document.addEventListener('DOMContentLoaded',()=>{});
(function(){
  const dc=document.getElementById('draw-color');if(dc)dc.addEventListener('input',e=>dColor=e.target.value);
  const dfc=document.getElementById('draw-fill-color');if(dfc)dfc.addEventListener('input',e=>dFillColor=e.target.value);
  const duf=document.getElementById('draw-use-fill');if(duf)duf.addEventListener('change',e=>dUseFill=e.target.checked);
})();

// Override sw to show/hide draw canvas and manage draw mode
const _origSw=typeof window.sw==='function'?window.sw:null;
/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   RESIZE OBSERVER
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
new ResizeObserver(()=>{
  if(srcImg)scheduleRender();
  if($('panel-color').classList.contains('on'))requestAnimationFrame(drawCurve);
}).observe($('preview-area'));

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   SPLASH
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
(()=>{
  const sp=$('splash');if(!sp)return;
  // ISO / Shutter animated counters
  const isoEl=document.getElementById('sp-iso');
  const isoVals=['ISO 100','ISO 200','ISO 400','ISO 800','ISO 1600','ISO 3200'];
  let isoIdx=2,isoDir=1;
  const isoT=setInterval(()=>{
    isoIdx=(isoIdx+isoDir+isoVals.length)%isoVals.length;
    if(isoIdx===isoVals.length-1||isoIdx===0)isoDir=-isoDir;
    if(isoEl)isoEl.textContent=isoVals[isoIdx];
  },1600);
  sp.addEventListener('click',()=>{
    clearInterval(isoT);
    sp.classList.add('out');
    setTimeout(()=>sp.remove(),1000);
  });
})();

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   EXPOSE + BOOT
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
Object.assign(window,{
  toggleLang,setMode,sw,triggerOpen,onFI,openExport,closeExport,pickFmt,doExport,
  resetAdj,setCvCh,toggleSec,doRotate,doFlipH,doFlipV,pickCrop,
  onResChange,pickRP,showPI,hidePI,savePreset,delPreset,applyPreset,
  toggleInfoSec,openNI,closeNI,niKey,
  goHome,closeConfirm,confirmGoHome,
  setMosaic,clearMosaic,setHtMode,applyFilter,onPreviewClick,applyCheki,
  openSettings,closeSettings,setFontSize,toggleHistOv,toggleZoom,setDefaultMode,toggleSaveStg,setPreviewQuality,setAnimQuality,toggleFX,toggleRealtime,toggleCursorFX,
  openHelp,closeHelp,startBlurSel,clearBlurRegions,removeBlurRegion,setBlurShape,buildBlurRegionsList,
  zoomIn,zoomOut,zoomReset,
  pickFrame,updateFrameColor,setFrameCorner,updateFrameCaption,applyFrame,
  setDTool,drawUndo,drawClear,
});

function buildAll(){buildAllSliders();buildFilterGrid();buildEasyCards();buildRes();buildPresets();buildMosaicGrid();if(typeof buildBlurRegionsList==='function')buildBlurRegionsList();}

loadSTG();
const bootMode=STG.defaultMode||'pro';
buildAll();
setMode(bootMode);
applyLang();
applySTG();
syncSTGUI();

})();
</script>
</body>
</html>
